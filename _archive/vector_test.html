<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frontier DOOH Vector Test (MapLibre)</title>

  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    html, body { height: 100%; margin: 0; padding: 0; background: #111414; }
    #map { height: 100%; width: 100%; }
  </style>
</head>
<body>

<div id="map"></div>
<div id="status" style="position:fixed;left:10px;bottom:10px;z-index:9999;background:rgba(0,0,0,0.75);color:#fff;padding:8px 10px;border-radius:8px;font:12px/1.4 system-ui;max-width:70vw;white-space:pre-wrap;">loading...</div>

<script>
 const KEY = "s3k9sg6vGwjKAfd4mDlR";
  const map = new maplibregl.Map({
    container: "map",
    style: `https://api.maptiler.com/maps/dataviz-v4-dark/style.json?key=${KEY}`,
    center: [127.0, 36.0],
    zoom: 7,
    attributionControl: true
  });

  map.addControl(new maplibregl.NavigationControl(), "top-right");
  const statusEl = document.getElementById("status");
  const setStatus = (msg) => { if (statusEl) statusEl.textContent = msg; };

  setStatus("MapLibre init OK. Loading style.json...");

  map.on("error", (e) => {
    // 콘솔 없이 화면에 에러를 띄우기
    try {
      const msg = (e && e.error && e.error.message) ? e.error.message : JSON.stringify(e);
      setStatus("Map error:\n" + msg);
    } catch (_) {
      setStatus("Map error (unparsed).");
    }
  });

  map.on("styledata", () => {
    setStatus("Style loaded. Loading tiles...");
  });

map.once("idle", () => {
  setStatus((statusEl ? statusEl.textContent + "\n" : "") + "Idle OK (style + tiles loaded).");
});

// 로드 후: 모든 심볼 레이어 라벨을 name:ko 우선으로 강제 + (데이터 로드/클러스터 생성)
map.on("load", async () => {
  // 1) 한글 라벨 우선
  try {
    const style = map.getStyle();
    const layers = (style && style.layers ? style.layers : []).filter(l => l.type === "symbol");
    layers.forEach(l => {
      try {
        map.setLayoutProperty(
          l.id,
          "text-field",
          ["coalesce", ["get", "name:ko"], ["get", "name"], ["get", "name_en"]]
        );
      } catch (e) {}
    });
  } catch (e) {}

  // 2) 데이터 로드 + GeoJSON 변환 + Source/Layer 구성(클러스터 ON)
  try {
    setStatus("Loading data_public_dummy_5000.json...");

    const res = await fetch("./data_public_dummy_5000.json");
    const data = await res.json();

    const isArray = Array.isArray(data);
    const items = isArray ? data : (Array.isArray(data.items) ? data.items : []);
    const total = items.length;

    if (!total) {
      setStatus("No items in data_public_dummy_5000.json");
      return;
    }

    const features = items.map((it, idx) => {
      const lng = Number(it.lng ?? it.lngDisp);
      const lat = Number(it.lat ?? it.latDisp);
      if (!Number.isFinite(lng) || !Number.isFinite(lat)) return null;

      return {
        type: "Feature",
        geometry: { type: "Point", coordinates: [lng, lat] },
        properties: {
          idx,
          key: it._key ?? "",
          name: it.name ?? it.title ?? "",
          high: it.high ?? it.category ?? ""
        }
      };
    }).filter(Boolean);

    setStatus(
      "data_public_dummy_5000 loaded\n" +
      "items: " + total + "\n" +
      "points(valid): " + features.length + "\n" +
      "Cluster mode: ON"
    );

    // 안전 제거(존재할 때만)
    const safeRemoveLayer = (id) => { try { if (map.getLayer(id)) map.removeLayer(id); } catch(e) {} };
    const safeRemoveSource = (id) => { try { if (map.getSource(id)) map.removeSource(id); } catch(e) {} };

    safeRemoveLayer("dooh-unclustered");
    safeRemoveLayer("dooh-clusters");
    safeRemoveLayer("dooh-cluster-count");
    safeRemoveSource("dooh");

    map.addSource("dooh", {
      type: "geojson",
      data: { type: "FeatureCollection", features },
      cluster: true,
      clusterMaxZoom: 17,
      clusterRadius: 50
    });

    // 2) Cluster 원
    map.addLayer({
      id: "dooh-clusters",
      type: "circle",
      source: "dooh",
      filter: ["has", "point_count"],
      paint: {
        "circle-color": "#a2decc",
        "circle-opacity": 0.35,
        "circle-stroke-color": "#a2decc",
        "circle-stroke-width": 1,
        "circle-radius": [
          "step",
          ["get", "point_count"],
          16, 50,
          22, 200,
          28, 1000,
          34
        ]
      }
    });

    // 3) Cluster 숫자
    map.addLayer({
      id: "dooh-cluster-count",
      type: "symbol",
      source: "dooh",
      filter: ["has", "point_count"],
      layout: {
        "text-field": "{point_count_abbreviated}",
        "text-size": 12
      },
      paint: { "text-color": "#0b0c0d" }
    });

    // 4) 개별 포인트(클러스터 아닌 것)
    map.addLayer({
      id: "dooh-unclustered",
      type: "circle",
      source: "dooh",
      filter: ["!", ["has", "point_count"]],
      paint: {
        "circle-color": "#a2decc",
        "circle-radius": 4,
        "circle-opacity": 0.9
      }
    });

    // 5) 클러스터 클릭 시 확대
    map.on("click", "dooh-clusters", (e) => {
      const f = e.features && e.features[0];
      if (!f) return;

      const clusterId = f.properties.cluster_id;
      const source = map.getSource("dooh");
      if (!source || !source.getClusterExpansionZoom) return;

      source.getClusterExpansionZoom(clusterId, (err, zoom) => {
        if (err) return;
        map.easeTo({ center: f.geometry.coordinates, zoom });
      });
    });

    // 마우스 커서
    map.on("mouseenter", "dooh-clusters", () => { map.getCanvas().style.cursor = "pointer"; });
    map.on("mouseleave", "dooh-clusters", () => { map.getCanvas().style.cursor = ""; });

    setStatus((statusEl ? statusEl.textContent + "\n" : "") + "Cluster layers added.");
  } catch (err) {
    setStatus("Data load error: " + (err && err.message ? err.message : String(err)));
  }
});

</script>

</body>
</html>
