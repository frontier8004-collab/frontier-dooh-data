<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frontier DOOH 전국 DB</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0d0f;
      --panel:#0f1215;
      --panel2:#14181c;
      --line:#242b32;
      --text:#cfd8e3;
      --muted:#8fa0b4;
      --mint:#a2decc;
      --mint2:#6dd6c1;
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:#000; color:var(--text); font-family:system-ui, -apple-system, Segoe UI, Roboto, "NanumSquare", sans-serif;}
    body{overflow:hidden}

    .topbar{
      position:fixed; left:0; right:0; top:0;
      height:64px; display:flex; align-items:center; gap:16px;
      padding:0 18px;
      background:linear-gradient(180deg, rgba(0,0,0,.88), rgba(0,0,0,.65));
      border-bottom:1px solid rgba(255,255,255,.05);
      z-index:999;
      backdrop-filter: blur(10px);
    }
    .brand{
      font-weight:800; letter-spacing:.3px;
      color:#dfe8f3;
      display:flex; align-items:flex-end; gap:10px;
      white-space:nowrap;
    }
    .brand small{font-weight:700; color:rgba(223,232,243,.65); font-size:12px}
    .brand .ver{font-size:11px; color:rgba(162,222,204,.8); font-weight:800}

    .searchWrap{
      flex:1; display:flex; align-items:center; gap:10px;
      min-width:420px;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
      border-radius:999px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.25);
    }
    .searchWrap input{
      flex:1;
      background:transparent; border:0; outline:0;
      color:var(--text); font-size:14px;
    }
    .searchWrap input::placeholder{color:rgba(207,216,227,.45)}
    .pillBtn{
      height:34px; padding:0 14px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
    }
    .pillBtn:hover{border-color:rgba(162,222,204,.35); box-shadow:0 0 0 2px rgba(162,222,204,.08) inset}
    .select{
      height:34px; padding:0 14px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      outline:0;
      font-size:13px;
      cursor:pointer;
    }

    .layout{
      position:fixed; left:0; right:0; top:64px; bottom:0;
      display:grid;
      grid-template-columns: 46% 54%;
      gap:0;
      background:var(--bg);
    }

    .leftPanel{
      border-right:1px solid rgba(255,255,255,.06);
      background:linear-gradient(180deg, rgba(8,10,12,.92), rgba(8,10,12,.86));
      padding:14px 14px 18px 14px;
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .leftHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:6px 6px 10px 6px;
      color:rgba(223,232,243,.9);
      font-weight:800;
      letter-spacing:.2px;
    }
    .countBar{
      display:flex; gap:10px; align-items:center;
      font-size:12px; color:rgba(207,216,227,.75);
    }
    .countTag{
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.06);
    }
    .listWrap{
      flex:1;
      overflow:auto;
      padding:8px 6px 0 6px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .card{
      background:rgba(255,255,255,.025);
      border:1px solid rgba(255,255,255,.07);
      border-radius:16px;
      padding:12px;
      min-height:126px;
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
    }
    .card:hover{
      border-color:rgba(162,222,204,.25);
      box-shadow: 0 10px 28px rgba(0,0,0,.42), 0 0 0 2px rgba(162,222,204,.06) inset;
    }
    .badgeRow{display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px}
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      color:rgba(223,232,243,.85);
      white-space:nowrap;
    }
    .name{
      font-weight:900;
      font-size:13px;
      line-height:1.25;
      margin-bottom:8px;
      color:#e5eef9;
      word-break:keep-all;
    }
    .addr{
      font-size:12px;
      color:rgba(207,216,227,.65);
      line-height:1.25;
      margin-bottom:10px;
    }
    .price{
      font-weight:900;
      color:rgba(162,222,204,.95);
      font-size:13px;
      letter-spacing:.2px;
    }

    .mapPanel{
      position:relative;
      padding:14px;
      background:radial-gradient(1000px 600px at 60% 20%, rgba(162,222,204,.08), transparent 60%), #0a0c0e;
    }
    #map{
      height:100%;
      width:100%;
      border-radius:22px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.06);
      background:#0c0f12;
    }

    .rightPanel{
      position:absolute;
      top:24px;
      right:24px;
      width:320px;
      display:flex;
      flex-direction:column;
      gap:12px;
      pointer-events:auto;
      z-index:500;
    }
    .rpCard{
      background:rgba(10,12,14,.78);
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow: 0 16px 36px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    .zoomBar{
      display:grid;
      grid-template-columns: 44px 1fr 44px;
      gap:10px;
      align-items:center;
      padding:10px;
      background:rgba(255,255,255,.02);
    }
    .zBtn{
      height:38px; width:44px;
      border-radius:12px;
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(223,232,243,.9);
      font-weight:900;
      cursor:pointer;
    }
    .zBtn:hover{border-color:rgba(162,222,204,.35); box-shadow:0 0 0 2px rgba(162,222,204,.08) inset}
    .zLabel{
      height:38px;
      border-radius:12px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      font-weight:900;
      letter-spacing:.6px;
      color:rgba(223,232,243,.95);
      text-transform:uppercase;
      font-size:12px;
    }

    .cartRow{
      display:flex;
      gap:10px;
      padding:10px;
      align-items:center;
      justify-content:space-between;
    }
    .cartBtn{
      flex:1;
      height:44px;
      border-radius:14px;
      background:rgba(162,222,204,.10);
      border:1px solid rgba(162,222,204,.22);
      color:rgba(223,232,243,.95);
      font-weight:900;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      box-shadow: 0 0 0 2px rgba(162,222,204,.06) inset;
    }
    .cartBtn:hover{border-color:rgba(162,222,204,.45)}
    .cartBadge{
      font-size:12px;
      color:rgba(162,222,204,.95);
      font-weight:900;
    }

    .recentHead{
      padding:12px 12px 8px 12px;
      display:flex; align-items:center; justify-content:space-between;
      font-weight:900;
      color:#e5eef9;
    }
    .recentHead small{color:rgba(207,216,227,.6); font-weight:800}
    .recentList{padding:0 12px 12px 12px; display:flex; flex-direction:column; gap:10px}
    .recentItem{
      display:grid;
      grid-template-columns: 1fr 42px;
      gap:10px;
      align-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:10px;
    }
    .recentTitle{
      font-size:12px;
      font-weight:900;
      color:#e5eef9;
      line-height:1.25;
      word-break:keep-all;
    }
    .recentSub{
      margin-top:6px;
      font-size:11px;
      color:rgba(207,216,227,.65);
      font-weight:800;
    }
    .recentX{
      height:34px; width:42px;
      border-radius:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(223,232,243,.9);
      font-weight:900;
      cursor:pointer;
    }
    .recentX:hover{border-color:rgba(162,222,204,.35); box-shadow:0 0 0 2px rgba(162,222,204,.08) inset}

    .hintBar{
      position:fixed;
      right:18px;
      top:76px;
      font-size:12px;
      color:rgba(207,216,227,.7);
      z-index:1000;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.08);
      backdrop-filter: blur(8px);
    }

    .listWrap::-webkit-scrollbar{width:10px}
    .listWrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.10); border-radius:999px; border:2px solid rgba(0,0,0,.25)}
    .listWrap::-webkit-scrollbar-track{background:rgba(255,255,255,.03)}

    @media (max-width: 1320px){
      .layout{grid-template-columns: 52% 48%}
      .grid{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 980px){
      body{overflow:auto}
      .layout{position:relative; top:64px; height:auto; grid-template-columns: 1fr; grid-template-rows: 520px 1fr}
      .leftPanel{border-right:0; border-top:1px solid rgba(255,255,255,.06)}
      .mapPanel{height:520px}
      .rightPanel{right:18px; top:18px; width:300px}
      .searchWrap{min-width:0}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      Frontier DOOH 전국 DB
      <span class="ver">v1.1.21</span>
    </div>

    <div class="searchWrap">
      <input id="q" type="text" placeholder="검색 (예: 대구, 강남구, 동성로, 대구시세계백화점...)" />
      <button id="clearQ" class="pillBtn" title="검색어 지우기">×</button>
    </div>

    <select id="cat" class="select" title="매체 카테고리">
      <option value="">매체 카테고리 (전체)</option>
    </select>

    <button id="resetAll" class="pillBtn">초기화</button>
  </div>

  <div class="hintBar">Loaded: <span id="loaded">-</span></div>

  <div class="layout">
    <div class="leftPanel">
      <div class="leftHeader">
        <div>리스트</div>
        <div class="countBar">
          <div class="countTag">전체 <span id="cntAll">-</span></div>
          <div class="countTag">필터 <span id="cntFiltered">-</span></div>
          <div class="countTag">현재범위 <span id="cntInView">-</span></div>
        </div>
      </div>
      <div class="listWrap" id="listWrap">
        <div class="grid" id="grid"></div>
      </div>
    </div>

    <div class="mapPanel">
      <div id="map"></div>

      <div class="rightPanel" id="rightPanel">
        <div class="rpCard">
          <div class="zoomBar">
            <button class="zBtn" id="zOut">←</button>
            <div class="zLabel">ZOOM <span id="zLabel">8</span></div>
            <button class="zBtn" id="zIn">→</button>
          </div>
        </div>

        <div class="rpCard">
          <div class="cartRow">
            <button id="cartBtn" class="cartBtn">
              <span>장바구니</span>
              <span class="cartBadge"><span id="cartCnt">0</span> · 0원</span>
            </button>
          </div>
        </div>

        <div class="rpCard">
          <div class="recentHead">
            <div>최근 본 매체</div>
            <small><span id="recentStat">0/0</span></small>
          </div>
          <div class="recentList" id="recentList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (()=>{

    const DEFAULT_ZOOM = 8;

    const elQ = document.getElementById('q');
    const elClearQ = document.getElementById('clearQ');
    const elCat = document.getElementById('cat');
    const elReset = document.getElementById('resetAll');

    const elLoaded = document.getElementById('loaded');
    const elCntAll = document.getElementById('cntAll');
    const elCntFiltered = document.getElementById('cntFiltered');
    const elCntInView = document.getElementById('cntInView');

    const grid = document.getElementById('grid');
    const listWrap = document.getElementById('listWrap');

    const rightPanel = document.getElementById('rightPanel');
    const zIn = document.getElementById('zIn');
    const zOut = document.getElementById('zOut');
    const zoomLabel = document.getElementById('zLabel');

    const cartBtn = document.getElementById('cartBtn');
    const cartCnt = document.getElementById('cartCnt');

    const recentList = document.getElementById('recentList');
    const recentStat = document.getElementById('recentStat');

    let map, tile, cluster;
    let all = [];
    let filtered = [];
    let markersById = new Map();

    const LS_RECENT_KEY = 'frontier_dooh_recent_v1';
    const LS_CART_KEY   = 'frontier_dooh_cart_v1';

    function money(v){
      const n = parseFloat(v);
      if(!Number.isFinite(n)) return '';
      return n.toLocaleString('ko-KR') + '원';
    }

    function safeStr(v){
      return (v===null || v===undefined) ? '' : String(v);
    }

    function pickId(p){
      return safeStr(p.id || p.uid || p._id || p.media_id || p.code || p.name || p.title || (p.lat + ',' + p.lng));
    }

    function getCategory(p){
      return safeStr(p.media_category || p.category || p.cat || p.media_group || p.group || '').trim();
    }

    function getRegion(p){
      return safeStr(p.region || p.si_do || p.sido || p.city || '').trim();
    }

    function getDistrict(p){
      return safeStr(p.district || p.gu || p.sigungu || p.county || '').trim();
    }

    function getName(p){
      return safeStr(p.media_name || p.name || p.title || p.place || p.spot_name || '이름 없음').trim();
    }

    function getAddr(p){
      const a1 = safeStr(p.address || p.addr || p.road_address || p.jibun_address || '').trim();
      const a2 = safeStr(p.address_detail || p.detail_address || '').trim();
      return (a1 + (a2 ? (' ' + a2) : '')).trim();
    }

    function getPrice(p){
      return p.price || p.cost || p.fee || p.monthly_price || '';
    }

    function getBadges(p){
      const arr = [];
      const a = getRegion(p); if(a) arr.push(a);
      const b = getDistrict(p); if(b) arr.push(b);
      const c = getCategory(p); if(c) arr.push(c);
      return arr.slice(0,4);
    }

    function normalizeQ(s){
      return safeStr(s).trim().toLowerCase();
    }

    function readJSON(key, fallback){
      try{
        const v = localStorage.getItem(key);
        if(!v) return fallback;
        return JSON.parse(v);
      }catch(e){
        return fallback;
      }
    }
    function writeJSON(key, val){
      try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
    }

    // =========================
    // Data normalization helpers
    // =========================
    function normalizePoints(raw){
      // Accept: Array<point>, {points:[...]}, {data:[...]}, GeoJSON FeatureCollection
      if (Array.isArray(raw)) return raw;
      if (raw && Array.isArray(raw.points)) return raw.points;
      if (raw && Array.isArray(raw.data)) return raw.data;

      // GeoJSON FeatureCollection support
      if (raw && raw.type === 'FeatureCollection' && Array.isArray(raw.features)){
        return raw.features.map(f=>{
          const props = (f && f.properties) ? f.properties : {};
          let lat = null, lng = null;
          if (f && f.geometry && Array.isArray(f.geometry.coordinates)){
            const [x,y] = f.geometry.coordinates;
            lng = x; lat = y;
          }
          return { ...props, lat, lng };
        }).filter(p => Number.isFinite(parseFloat(p.lat)) && Number.isFinite(parseFloat(p.lng)));
      }

      return null;
    }

    function coercePoint(p){
      // Unify latitude/longitude keys and force number types
      if (!p || typeof p !== 'object') return null;
      const lat = (p.lat ?? p.latitude ?? p.y ?? p.Lat ?? p.LAT);
      const lng = (p.lng ?? p.lon ?? p.longitude ?? p.x ?? p.Lng ?? p.LNG ?? p.Lon);
      const latNum = parseFloat(lat);
      const lngNum = parseFloat(lng);
      if (!Number.isFinite(latNum) || !Number.isFinite(lngNum)) return null;
      return { ...p, lat: latNum, lng: lngNum };
    }

    function initMap(){
      map = L.map('map', { zoomControl:false, attributionControl:true });

      tile = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
      }).addTo(map);

      if(L.markerClusterGroup){
        cluster = L.markerClusterGroup({
          maxClusterRadius: 60,
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          zoomToBoundsOnClick: true
        });
        map.addLayer(cluster);
      }

      map.setView([36.2, 127.8], DEFAULT_ZOOM);

      map.on('zoomend', ()=>{
        zoomLabel.textContent = map.getZoom();
        applyInViewCount();
      });

      map.on('moveend', ()=>{
        applyInViewCount();
      });

      zoomLabel.textContent = map.getZoom();
    }

    function clearMarkers(){
      markersById.clear();
      if(cluster){
        cluster.clearLayers();
      }
    }

    function addMarkers(points){
      clearMarkers();
      if(!points || points.length === 0) return;

      for(const p of points){
        const id = pickId(p);
        const m = L.marker([p.lat, p.lng]);
        m.__pid = id;

        m.on('click', ()=>{
          pushRecent(p);
          renderRecent();
          openPopupFor(p);
        });

        markersById.set(id, m);
        if(cluster) cluster.addLayer(m);
        else m.addTo(map);
      }
    }

    function openPopupFor(p){
      const name = getName(p);
      const addr = getAddr(p);
      const cat = getCategory(p);
      const price = getPrice(p);

      const html = `
        <div style="min-width:220px">
          <div style="font-weight:900; font-size:13px; margin-bottom:6px">${escapeHtml(name)}</div>
          <div style="font-size:12px; color:#6c7a8a; margin-bottom:8px">${escapeHtml(addr)}</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px">
            ${cat?`<span style="padding:3px 8px; border-radius:999px; background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.08); font-size:11px">${escapeHtml(cat)}</span>`:''}
          </div>
          ${price?`<div style="font-weight:900; color:#1b7f6b">${escapeHtml(money(price))}</div>`:''}
        </div>
      `;
      L.popup({closeButton:true})
        .setLatLng([p.lat, p.lng])
        .setContent(html)
        .openOn(map);
    }

    function escapeHtml(s){
      return safeStr(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function rebuildCategoryOptions(){
      const set = new Set();
      for(const p of all){
        const c = getCategory(p);
        if(c) set.add(c);
      }
      const arr = Array.from(set).sort((a,b)=>a.localeCompare(b,'ko'));
      const cur = elCat.value;

      elCat.innerHTML = '<option value="">매체 카테고리 (전체)</option>' + arr.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      elCat.value = cur;
    }

    function matchPoint(p, q, cat){
      if(cat){
        const c = getCategory(p);
        if(c !== cat) return false;
      }
      if(!q) return true;

      const hay = [
        getName(p),
        getAddr(p),
        getRegion(p),
        getDistrict(p),
        getCategory(p)
      ].join(' ').toLowerCase();

      return hay.includes(q);
    }

    function renderList(points){
      grid.innerHTML = '';
      if(!points || points.length === 0){
        grid.innerHTML = '<div style="grid-column:1/-1; padding:18px; color:rgba(207,216,227,.65); font-weight:800;">결과가 없습니다.</div>';
        return;
      }

      const frag = document.createDocumentFragment();

      for(const p of points){
        const card = document.createElement('div');
        card.className = 'card';

        const badges = getBadges(p).map(x=>`<span class="badge">${escapeHtml(x)}</span>`).join('');

        card.innerHTML = `
          <div class="badgeRow">${badges}</div>
          <div class="name">${escapeHtml(getName(p))}</div>
          <div class="addr">${escapeHtml(getAddr(p))}</div>
          <div class="price">${escapeHtml(money(getPrice(p)))}</div>
        `;

        card.addEventListener('click', ()=>{
          pushRecent(p);
          renderRecent();
          map.setView([p.lat, p.lng], Math.max(map.getZoom(), 12), {animate:true});
          openPopupFor(p);
        });

        frag.appendChild(card);
      }

      grid.appendChild(frag);
    }

    function applyCounts(){
      elCntAll.textContent = all.length.toLocaleString('ko-KR');
      elCntFiltered.textContent = filtered.length.toLocaleString('ko-KR');
      applyInViewCount();
    }

    function applyInViewCount(){
      if(!map || !filtered) { elCntInView.textContent = '0'; return; }
      const b = map.getBounds();
      let cnt = 0;
      for(const p of filtered){
        if(b.contains([p.lat, p.lng])) cnt++;
      }
      elCntInView.textContent = cnt.toLocaleString('ko-KR');
    }

    function applyFilters(){
      const q = normalizeQ(elQ.value);
      const cat = safeStr(elCat.value).trim();

      filtered = all.filter(p => matchPoint(p, q, cat));
      addMarkers(filtered);
      renderList(filtered);
      applyCounts();

      elLoaded.textContent = all.length.toLocaleString('ko-KR');
    }

    function pushRecent(p){
      const id = pickId(p);
      let arr = readJSON(LS_RECENT_KEY, []);
      arr = arr.filter(x => x && x.id !== id);
      arr.unshift({ id, p });
      arr = arr.slice(0, 20);
      writeJSON(LS_RECENT_KEY, arr);
    }

    function removeRecent(id){
      let arr = readJSON(LS_RECENT_KEY, []);
      arr = arr.filter(x => x && x.id !== id);
      writeJSON(LS_RECENT_KEY, arr);
    }

    function renderRecent(){
      const arr = readJSON(LS_RECENT_KEY, []);
      const items = arr.map(x=>x.p).filter(Boolean);

      // 4개까지만 보이고, 그 이상은 페이지네이션(2페이지)
      const pageSize = 4;
      let page = readJSON(LS_RECENT_KEY + '_page', 1);
      page = Math.max(1, Math.min(page, Math.ceil(items.length / pageSize) || 1));

      const totalPages = Math.ceil(items.length / pageSize) || 1;
      const start = (page-1)*pageSize;
      const slice = items.slice(start, start+pageSize);

      recentStat.textContent = `${Math.min(items.length, pageSize)}/${Math.min(items.length, pageSize)} (${items.length ? page + '/' + totalPages : '0/0'})`.replace('(0/0)','0/0');

      // 상단 표기: "4/4" 형태 유지
      const shown = Math.min(pageSize, items.length);
      recentStat.textContent = `${shown}/${Math.min(pageSize, items.length || pageSize)}`.replace('0/4','0/0');

      recentList.innerHTML = '';

      for(const p of slice){
        const id = pickId(p);

        const row = document.createElement('div');
        row.className = 'recentItem';
        row.innerHTML = `
          <div>
            <div class="recentTitle">${escapeHtml(getName(p))}</div>
            <div class="recentSub">${escapeHtml(getRegion(p))}${getDistrict(p)?(' · '+escapeHtml(getDistrict(p))):''}</div>
          </div>
          <button class="recentX" title="삭제">×</button>
        `;

        row.addEventListener('click', (e)=>{
          if(e.target && e.target.classList.contains('recentX')) return;
          map.setView([p.lat, p.lng], Math.max(map.getZoom(), 12), {animate:true});
          openPopupFor(p);
        });

        row.querySelector('.recentX').addEventListener('click', (e)=>{
          e.stopPropagation();
          removeRecent(id);
          renderRecent();
        });

        recentList.appendChild(row);
      }

      // 페이지네이션 UI: 4개 초과면 하단에 표시
      if(items.length > pageSize){
        const nav = document.createElement('div');
        nav.className = 'recentItem';
        nav.style.gridTemplateColumns = '44px 1fr 44px';
        nav.style.justifyContent = 'center';
        nav.style.alignItems = 'center';
        nav.innerHTML = `
          <button class="recentX" id="rpPrev" style="width:44px">←</button>
          <div style="text-align:center; font-weight:900; color:rgba(223,232,243,.85)">${page}/${totalPages}</div>
          <button class="recentX" id="rpNext" style="width:44px">→</button>
        `;
        recentList.appendChild(nav);

        nav.querySelector('#rpPrev').addEventListener('click', (e)=>{
          e.stopPropagation();
          page = Math.max(1, page-1);
          writeJSON(LS_RECENT_KEY + '_page', page);
          renderRecent();
        });
        nav.querySelector('#rpNext').addEventListener('click', (e)=>{
          e.stopPropagation();
          page = Math.min(totalPages, page+1);
          writeJSON(LS_RECENT_KEY + '_page', page);
          renderRecent();
        });
      }else{
        writeJSON(LS_RECENT_KEY + '_page', 1);
      }
    }

    function renderCartBadge(){
      const cart = readJSON(LS_CART_KEY, []);
      cartCnt.textContent = (cart.length || 0).toLocaleString('ko-KR');
    }

    function bindUI(){
      elClearQ.addEventListener('click', ()=>{
        elQ.value = '';
        applyFilters();
      });

      elQ.addEventListener('input', ()=>{
        applyFilters();
      });

      // 카테고리 변경 시 지도 초기화(뷰 리셋) 하지 않는다.
      elCat.addEventListener('change', ()=>{
        applyFilters();
      });

      elReset.addEventListener('click', ()=>{
        elQ.value = '';
        elCat.value = '';
        applyFilters();
        resetViewToAllPoints();
      });

      zIn.addEventListener('click', ()=>{
        map.zoomIn();
      });
      zOut.addEventListener('click', ()=>{
        map.zoomOut();
      });

      cartBtn.addEventListener('click', ()=>{
        alert("장바구니 모달은 다음 단계에서 연결합니다. (현재는 버튼만 유지)");
      });
    }

    async function tryFetchJson(url){
      const res = await fetch(url, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();

      // 일부 호스팅에서 BOM/공백/잘못된 헤더가 섞이는 경우 방어
      const trimmed = text.replace(/^\uFEFF/, '').trim();
      if(!trimmed) throw new Error("Empty response");

      try{
        const raw = JSON.parse(trimmed);
        const arr = normalizePoints(raw);
        if(!arr){
          throw new Error("Unexpected JSON shape");
        }
        const coerced = arr.map(coercePoint).filter(Boolean);
        if(!coerced.length){
          throw new Error("No valid lat/lng points");
        }
        return coerced;
      }catch(e){
        console.error("JSON parse error:", e);
        throw e;
      }
    }

    async function loadData(){
      // GitHub Pages / Imweb 등 다양한 베이스 경로 대응
      const q = "v=" + Date.now();

      const candidates = [
        new URL(`data_public.json?${q}`, location.href).toString(),
        new URL(`data.json?${q}`, location.href).toString(),
        new URL(`../data_public.json?${q}`, location.href).toString(),
        new URL(`../data.json?${q}`, location.href).toString(),
        `${location.origin}/data_public.json?${q}`,
        `${location.origin}/data.json?${q}`
      ];

      let lastErr = null;

      for(const url of candidates){
        try{
          const data = await tryFetchJson(url);
          return data;
        }catch(err){
          lastErr = err;
          console.warn("[loadData] failed:", url, err);
        }
      }
      throw lastErr || new Error("Failed to load data");
    }

    function resetViewToAllPoints(){
      // 전체 데이터 기준 "기본 지도 위치"로 복귀 (줌 8 기준, 제주 포함 / 북쪽은 속초 정도까지만)
      if(!map || !Array.isArray(all) || all.length === 0) return;

      // 데이터 경계 계산
      const rawBounds = L.latLngBounds(all.map(p => [p.lat, p.lng]));
      const sw0 = rawBounds.getSouthWest();
      const ne0 = rawBounds.getNorthEast();

      // 화면 요구사항 기준 클램프(휴전선 위는 과도하게 보이지 않게, 제주 포함)
      const MIN_LAT = 33.0;    // 제주가 포함되도록 여유
      const MAX_LAT = 38.4;    // 속초(약 38.2) 상단 여유
      const MIN_LNG = 124.2;   // 서해/제주 포함 여유
      const MAX_LNG = 131.2;   // 동해/울릉도 여유

      const sw = L.latLng(
        Math.min(sw0.lat, MIN_LAT),
        Math.min(sw0.lng, MIN_LNG)
      );
      const ne = L.latLng(
        Math.min(Math.max(ne0.lat, MIN_LAT), MAX_LAT),
        Math.min(Math.max(ne0.lng, MIN_LNG), MAX_LNG)
      );

      const safeBounds = L.latLngBounds(sw, ne);

      // 패널 공간을 고려한 fitBounds (추가 panBy로 보정하지 않는다: 제주가 잘리는 문제 방지)
      const panelW = (rightPanel ? rightPanel.getBoundingClientRect().width : 0) || 360;
      const pad = 24;

      map.fitBounds(safeBounds, {
        paddingTopLeft: [pad, pad],
        paddingBottomRight: [panelW + pad, pad],
        maxZoom: DEFAULT_ZOOM,
        animate: false
      });

      // 줌 라벨 동기화
      try{ zoomLabel.textContent = map.getZoom(); }catch(e){}
    }

    async function boot(){
      initMap();
      bindUI();

      try{
        all = await loadData();
      }catch(err){
        console.error(err);
        alert("data.json을 불러오지 못했습니다. (콘솔 확인)");
        return;
      }

      try{
        rebuildCategoryOptions();
        applyFilters();          // markers/list render
        renderRecent();
        renderCartBadge();

        // 레이아웃/지도 컨테이너 사이즈 안정화 후 기본 위치 보정
        requestAnimationFrame(()=>{
          try{ map.invalidateSize(true); }catch(e){}
          resetViewToAllPoints();
        });
      }catch(err){
        console.error(err);
        alert("초기 렌더링 중 오류가 발생했습니다. (콘솔 확인)");
      }
    }

    function waitLeaflet(){
      if(window.L && window.L.map){
        boot();
        return;
      }
      setTimeout(waitLeaflet, 50);
    }

    waitLeaflet();
  })();
  </script>
</body>
</html>
