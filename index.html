<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frontier DOOH 전국 DB</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0e10;
      --panel:#0f1417cc;
      --panel2:#0f1417;
      --stroke:#1e2a30;
      --text:#d7e2e8;
      --muted:#95a6b3;
      --mint:#a2decc;
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,NanumGothic,Arial}
    #app{position:fixed;inset:0;display:flex;overflow:hidden}
    #map{flex:1;background:#000}

    .panel{
      position:absolute;left:12px;top:12px;bottom:12px;width:310px;
      background:linear-gradient(180deg,var(--panel),rgba(15,20,23,.55));
      border:1px solid rgba(162,222,204,.10);
      border-radius:24px;box-shadow:var(--shadow);
      overflow:hidden;backdrop-filter: blur(10px);
      display:flex;flex-direction:column;
    }
    .panel .section{padding:12px 12px 0 12px}
    .panel .section:last-child{padding-bottom:12px}

    .box{
      background:rgba(0,0,0,.22);
      border:1px solid rgba(162,222,204,.12);
      border-radius:16px;
      padding:10px;
      margin-bottom:10px;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(162,222,204,.18);
      background:rgba(162,222,204,.08);
      color:var(--text);
      font-weight:700;
      min-width:44px;
    }
    .muted{color:var(--muted);font-size:12px;line-height:1.4}

    .zoomWrap{display:flex;align-items:center;gap:10px}
    .zoomLabel{font-weight:800;letter-spacing:.02em}
    .zoomBtns{
      margin-left:auto;
      width:42px;
      display:flex;flex-direction:column;
      border:1px solid rgba(162,222,204,.18);
      border-radius:14px;overflow:hidden;
      background:rgba(0,0,0,.25);
    }
    .zbtn{
      height:34px;border:0;background:transparent;color:var(--text);
      cursor:pointer;font-size:16px;font-weight:900;
    }
    .zbtn + .zbtn{border-top:1px solid rgba(162,222,204,.12)}
    .zbtn:hover{background:rgba(162,222,204,.10)}

    .cartRow{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      font-weight:800;
    }

    .recentHead{display:flex;align-items:center;justify-content:space-between}
    .recentGrid{
      display:flex;flex-direction:column;gap:10px;
      max-height:460px;overflow:auto;padding-right:4px;
    }
    .recentItem{
      display:grid;grid-template-columns:70px 1fr;gap:10px;
      padding:10px;border-radius:16px;
      border:1px solid rgba(162,222,204,.10);
      background:rgba(0,0,0,.20);
      cursor:pointer;
    }
    .recentItem:hover{background:rgba(162,222,204,.06);border-color:rgba(162,222,204,.22)}
    .thumb{
      width:70px;height:54px;border-radius:12px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(162,222,204,.10);
      overflow:hidden;display:flex;align-items:center;justify-content:center;
      color:rgba(215,226,232,.45);font-size:11px;font-weight:800;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .title{
      font-weight:900;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:100%;
    }
    .price{color:var(--mint);font-weight:900;margin-top:4px}

    .pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .pbtn{
      width:42px;height:34px;border-radius:12px;border:1px solid rgba(162,222,204,.18);
      background:rgba(0,0,0,.25);color:var(--text);cursor:pointer;font-weight:900;
    }
    .pbtn:hover{background:rgba(162,222,204,.10)}

    .searchbar{
      position:absolute;left:340px;top:14px;right:340px;height:44px;
      background:rgba(0,0,0,.32);
      border:1px solid rgba(162,222,204,.14);
      border-radius:999px;
      display:flex;align-items:center;gap:10px;
      padding:0 14px;
      backdrop-filter:blur(10px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .searchbar input{
      flex:1;border:0;outline:0;background:transparent;color:var(--text);
      font-size:14px;font-weight:700;
    }
    .searchbar .sbtn{
      height:30px;padding:0 12px;border-radius:999px;border:1px solid rgba(162,222,204,.18);
      background:rgba(162,222,204,.10);
      color:var(--text);font-weight:900;cursor:pointer;
    }
    .searchbar .sbtn:hover{background:rgba(162,222,204,.18)}

    .results{
      position:absolute;right:12px;top:12px;bottom:12px;width:360px;
      background:linear-gradient(180deg,var(--panel),rgba(15,20,23,.55));
      border:1px solid rgba(162,222,204,.10);
      border-radius:24px;box-shadow:var(--shadow);
      overflow:hidden;backdrop-filter: blur(10px);
      display:flex;flex-direction:column;
    }
    .results .head{padding:12px 14px;font-weight:900;display:flex;align-items:center;justify-content:space-between}
    .results .list{flex:1;overflow:auto;padding:0 10px 12px 10px}
    .card{
      padding:12px;margin:10px 0;border-radius:18px;
      border:1px solid rgba(162,222,204,.10);
      background:rgba(0,0,0,.20);
      cursor:pointer;
    }
    .card:hover{background:rgba(162,222,204,.06);border-color:rgba(162,222,204,.22)}
    .card .cTitle{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card .cAddr{color:var(--muted);font-size:12px;margin-top:6px;line-height:1.4}
    .card .cPrice{color:var(--mint);font-weight:950;margin-top:8px}

    .glow{
      filter: drop-shadow(0 0 10px rgba(162,222,204,.8)) drop-shadow(0 0 18px rgba(162,222,204,.55));
    }

    /* Leaflet tweaks */
    .leaflet-control-zoom{display:none !important;}
    .leaflet-popup-content{margin:10px 12px}
    .leaflet-popup-content-wrapper{
      background:#0e1417;
      color:var(--text);
      border:1px solid rgba(162,222,204,.18);
      border-radius:16px;
      box-shadow:0 14px 40px rgba(0,0,0,.6);
    }
    .leaflet-popup-tip{background:#0e1417;border:1px solid rgba(162,222,204,.18)}
    .miniBtn{
      margin-top:10px;
      width:100%;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(162,222,204,.22);
      background:rgba(162,222,204,.10);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .miniBtn:hover{background:rgba(162,222,204,.18)}
  </style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div class="panel" id="leftPanel">
    <div class="section">
      <div class="box">
        <div class="row">
          <div class="zoomWrap">
            <div class="zoomLabel">ZOOM</div>
            <div class="pill" id="zoomNum">0</div>
          </div>

          <div class="zoomBtns">
            <button class="zbtn" id="zoomIn">▲</button>
            <button class="zbtn" id="zoomOut">▼</button>
          </div>
        </div>
      </div>

      <div class="box">
        <div class="cartRow">
          <div>장바구니</div>
          <div class="pill" id="cartCount">0</div>
        </div>
        <div class="muted" style="margin-top:8px">
          장바구니는 이 브라우저(이용자) 기준으로 저장됩니다.<br/>
          (같은 PC의 다른 사람이 접속해도 그대로 보일 수 있습니다.)
        </div>
      </div>

      <div class="box">
        <div class="recentHead">
          <div style="font-weight:900">최근 본 매체</div>
          <div class="muted"><span id="recentNow">0</span>/<span id="recentMax">4</span></div>
        </div>
      </div>

      <div class="box" style="padding-top:0">
        <div class="recentGrid" id="recentGrid"></div>
        <div class="pager">
          <button class="pbtn" id="recentPrev">←</button>
          <div class="muted"><span id="recentPage">1</span>/<span id="recentPageMax">1</span></div>
          <button class="pbtn" id="recentNext">→</button>
        </div>
      </div>
    </div>
  </div>

  <div class="searchbar">
    <input id="q" placeholder="지역/매체명/키워드 검색 (예: 인천공항, 강남, KT SQUARE)" />
    <button class="sbtn" id="btnSearch">검색</button>
    <button class="sbtn" id="btnReset" style="opacity:.85">초기화</button>
  </div>

  <div class="results">
    <div class="head">
      <div>검색 결과</div>
      <div class="muted" id="resultCount">0개</div>
    </div>
    <div class="list" id="resultList"></div>
  </div>
</div>

<script>
(() => {
  const VERSION = "v1.1.26";

  const __FETCH_TIMEOUT_MS = 20000;
  async function fetchJsonWithTimeout(url, timeoutMs){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort("timeout"), timeoutMs);
    try{
      const res = await fetch(url, { signal: ctrl.signal, cache: "no-store" });
      if(!res.ok) throw new Error("HTTP "+res.status+" "+res.statusText);
      const txt = await res.text();
      const cleaned = txt.replace(/^\uFEFF/, "");
      return JSON.parse(cleaned);
    } finally {
      clearTimeout(t);
    }
  }

  async function loadDataJson(){
    try{
      const baseDir = location.pathname.replace(/[^\/]+$/, "");
      const candidates = [
        { label: "rel:data_public.json", url: "data_public.json" },
        { label: "rel:data.json",        url: "data.json" },
        { label: "./data_public.json",   url: "./data_public.json" },
        { label: "./data.json",          url: "./data.json" },
        { label: "base:data_public",     url: baseDir + "data_public.json" },
        { label: "base:data",            url: baseDir + "data.json" },
        { label: "ghraw:data_public",    url: "https://raw.githubusercontent.com/frontier8004-collab/frontier-dooh-data/main/data_public.json" },
        { label: "ghraw:data",           url: "https://raw.githubusercontent.com/frontier8004-collab/frontier-dooh-data/main/data.json" },
        { label: "jsdelivr:data_public", url: "https://cdn.jsdelivr.net/gh/frontier8004-collab/frontier-dooh-data@main/data_public.json" },
        { label: "jsdelivr:data",        url: "https://cdn.jsdelivr.net/gh/frontier8004-collab/frontier-dooh-data@main/data.json" },
      ];

      const normalizeData = (j) => {
        if (Array.isArray(j)) return j;
        if (j && Array.isArray(j.items)) return j.items;
        if (j && Array.isArray(j.data)) return j.data;
        if (j && Array.isArray(j.points)) return j.points;
        return null;
      };

      let lastErr = null;
      for(const c of candidates){
        try {
          const loaded = await fetchJsonWithTimeout(c.url, __FETCH_TIMEOUT_MS);
          const norm = normalizeData(loaded);
          if (!norm) throw new Error("data json root must be Array OR an object with items[]/data[]/points[]");
          window.__DATA_SOURCE = c.label;
          console.log("[DATA] loaded via", c.label, c.url, "(items:", norm.length, ")");
          return norm;
        } catch (err) {
          lastErr = err;
          console.warn("[DATA] failed", c.label, c.url, err);
        }
      }

      const msg =
        "데이터(JSON) 로드 실패.\n" +
        "1) index.html과 같은 폴더에 data_public.json 또는 data.json 이 있는지 확인\n" +
        "2) GitHub Pages 배포가 최신 커밋을 반영했는지 확인(몇 분 지연 가능)\n" +
        "3) 파일명이 대소문자까지 정확한지 확인\n\n" +
        "마지막 에러: " + (lastErr ? (lastErr.message || String(lastErr)) : "unknown");
      alert(msg);
      return [];
    } catch(e){
      alert("데이터 로드 중 예외: " + (e.message || String(e)));
      return [];
    }
  }

  const map = L.map("map", {
    zoomControl:false,
    preferCanvas:true
  }).setView([36.5, 127.8], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const cluster = L.markerClusterGroup({
    chunkedLoading: true,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    removeOutsideVisibleBounds: true,
  });
  map.addLayer(cluster);

  const zoomNum = document.getElementById("zoomNum");
  function updateZoomUI(){ zoomNum.textContent = String(map.getZoom()); }
  map.on("zoomend", updateZoomUI);
  updateZoomUI();

  document.getElementById("zoomIn").onclick = () => map.zoomIn();
  document.getElementById("zoomOut").onclick = () => map.zoomOut();

  const q = document.getElementById("q");
  const btnSearch = document.getElementById("btnSearch");
  const btnReset = document.getElementById("btnReset");

  const resultList = document.getElementById("resultList");
  const resultCount = document.getElementById("resultCount");

  const recentGrid = document.getElementById("recentGrid");
  const recentNow = document.getElementById("recentNow");
  const recentMax = document.getElementById("recentMax");
  const recentPrev = document.getElementById("recentPrev");
  const recentNext = document.getElementById("recentNext");
  const recentPage = document.getElementById("recentPage");
  const recentPageMax = document.getElementById("recentPageMax");

  const cartCount = document.getElementById("cartCount");

  const RECENT_LIMIT = 4;
  recentMax.textContent = String(RECENT_LIMIT);

  const LS_RECENT = "frontier_recent_v1";
  const LS_CART = "frontier_cart_v1";

  function safeParse(json, fallback){
    try{ return JSON.parse(json); }catch{ return fallback; }
  }

  function loadRecent(){
    return safeParse(localStorage.getItem(LS_RECENT) || "[]", []);
  }
  function saveRecent(arr){
    localStorage.setItem(LS_RECENT, JSON.stringify(arr.slice(0, RECENT_LIMIT)));
  }

  function loadCart(){
    return safeParse(localStorage.getItem(LS_CART) || "[]", []);
  }
  function saveCart(arr){
    localStorage.setItem(LS_CART, JSON.stringify(arr));
  }
  function updateCartUI(){
    cartCount.textContent = String(loadCart().length);
  }

  let __recentPage = 1;
  const RECENT_PAGE_SIZE = 4;

  function renderRecent(){
    const arr = loadRecent();
    recentNow.textContent = String(arr.length);

    const pageMax = Math.max(1, Math.ceil(arr.length / RECENT_PAGE_SIZE));
    __recentPage = Math.min(__recentPage, pageMax);
    recentPage.textContent = String(__recentPage);
    recentPageMax.textContent = String(pageMax);

    const start = (__recentPage - 1) * RECENT_PAGE_SIZE;
    const pageItems = arr.slice(start, start + RECENT_PAGE_SIZE);

    recentGrid.innerHTML = "";
    pageItems.forEach(item => {
      const el = document.createElement("div");
      el.className = "recentItem";
      el.innerHTML = `
        <div class="thumb">${item.thumb ? `<img src="${item.thumb}" alt="">` : "NO IMAGE"}</div>
        <div>
          <div class="title" title="${escapeHtml(item.title||"")}">${escapeHtml(item.title||"")}</div>
          <div class="price">${formatPrice(item.price)}</div>
        </div>
      `;
      el.onclick = () => focusItem(item, { zoom: 14, glow: true, pin: true });
      recentGrid.appendChild(el);
    });
  }

  recentPrev.onclick = () => { __recentPage = Math.max(1, __recentPage - 1); renderRecent(); };
  recentNext.onclick = () => { __recentPage = Math.min(Number(recentPageMax.textContent), __recentPage + 1); renderRecent(); };

  function formatPrice(p){
    if(p === null || p === undefined || p === "") return "문의";
    const n = Number(p);
    if(Number.isFinite(n)){
      return n.toLocaleString("ko-KR") + "원";
    }
    return String(p);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function addRecent(item){
    const arr = loadRecent().filter(x => x && x.id !== item.id);
    arr.unshift(pickRecent(item));
    saveRecent(arr);
    __recentPage = 1;
    renderRecent();
  }

  function pickRecent(item){
    return {
      id: item.id,
      title: item.title,
      price: item.price,
      lat: item.lat,
      lng: item.lng,
      thumb: item.thumb || null,
      address: item.address || ""
    };
  }

  function addToCart(item){
    const cart = loadCart();
    if(!cart.find(x => x && x.id === item.id)){
      cart.unshift({ id:item.id, title:item.title, price:item.price, thumb:item.thumb||null });
      saveCart(cart);
      updateCartUI();
    }
  }

  function focusItem(item, opt={}){
    const zoom = opt.zoom ?? Math.min(16, Math.max(10, map.getZoom()));
    if(Number.isFinite(item.lat) && Number.isFinite(item.lng)){
      map.setView([item.lat, item.lng], zoom, { animate:true });
    }
    if(opt.glow && item.__marker){
      item.__marker._icon && item.__marker._icon.classList.add("glow");
      setTimeout(() => {
        item.__marker._icon && item.__marker._icon.classList.remove("glow");
      }, 900);
    }
    if(opt.pin && item.__marker){
      item.__marker.openPopup();
    }
  }

  function makePopupHtml(item){
    const title = escapeHtml(item.title||"");
    const addr = escapeHtml(item.address||"");
    const price = formatPrice(item.price);

    return `
      <div style="min-width:220px">
        <div style="font-weight:950;font-size:14px">${title}</div>
        <div style="color:var(--muted);font-size:12px;margin-top:6px;line-height:1.35">${addr}</div>
        <div style="color:var(--mint);font-weight:950;margin-top:8px">${price}</div>
        <button class="miniBtn" data-addcart="1">담기</button>
      </div>
    `;
  }

  function renderResults(items){
    resultCount.textContent = `${items.length}개`;
    resultList.innerHTML = "";
    items.forEach(item => {
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="cTitle" title="${escapeHtml(item.title||"")}">${escapeHtml(item.title||"")}</div>
        <div class="cAddr">${escapeHtml(item.address||"")}</div>
        <div class="cPrice">${formatPrice(item.price)}</div>
      `;
      el.onclick = () => focusItem(item, { zoom: 14, glow: true, pin: true });
      resultList.appendChild(el);
    });
  }

  function normalizeItem(raw){
    const lat = Number(raw.lat ?? raw.latitude);
    const lng = Number(raw.lng ?? raw.longitude ?? raw.lon);
    return {
      id: raw.id ?? raw.media_id ?? raw.uid ?? (raw.title + "_" + lat + "_" + lng),
      title: raw.title ?? raw.name ?? raw.media_name ?? "",
      address: raw.address ?? raw.addr ?? "",
      lat: Number.isFinite(lat) ? lat : null,
      lng: Number.isFinite(lng) ? lng : null,
      price: raw.price ?? raw.price_krw ?? raw.cost ?? "",
      thumb: raw.thumb ?? raw.thumbnail ?? raw.image_url ?? raw.img ?? null,
      raw
    };
  }

  function doSearch(all, keyword){
    const kw = (keyword||"").trim().toLowerCase();
    if(!kw) return [];

    const hits = all.filter(item => {
      const t = (item.title||"").toLowerCase();
      const a = (item.address||"").toLowerCase();
      return t.includes(kw) || a.includes(kw);
    });

    renderResults(hits);

    if(hits.length){
      const first = hits[0];
      focusItem(first, { zoom: 12, glow: true, pin: false });
    }
    return hits;
  }

  btnSearch.onclick = () => doSearch(window.__ALL_ITEMS || [], q.value);
  q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") btnSearch.click(); });

  btnReset.onclick = () => {
    q.value = "";
    renderResults([]);
    map.setView([36.5, 127.8], 7);
  };

  (async function init(){
    console.log("Frontier DOOH", VERSION);
    updateCartUI();
    renderRecent();

    let data = await loadDataJson();
    if (!Array.isArray(data) || data.length === 0) {
      alert("데이터를 불러오지 못했습니다. data_public.json 또는 data.json 이 정상인지 확인하세요.");
      data = [];
    }

    const items = data.map(normalizeItem).filter(x => Number.isFinite(x.lat) && Number.isFinite(x.lng));
    window.__ALL_ITEMS = items;

    items.forEach(item => {
      const m = L.marker([item.lat, item.lng], { title: item.title });
      m.bindPopup(makePopupHtml(item), { closeButton:true });
      m.on("click", () => {
        addRecent(item);
        // 클릭한 매체를 우상(1번 위치)에 띄우고 빛나게
        focusItem(item, { zoom: map.getZoom(), glow: true, pin: true });
      });
      m.on("popupopen", (e) => {
        const root = e.popup.getElement();
        const btn = root && root.querySelector('[data-addcart="1"]');
        if(btn){
          btn.onclick = () => {
            addToCart(item);
            updateCartUI();
            btn.textContent = "담김";
            setTimeout(()=>btn.textContent="담기", 800);
          };
        }
      });
      item.__marker = m;
      cluster.addLayer(m);
    });

    renderResults([]);

  })();

})();
</script>
</body>
</html>
