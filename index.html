<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frontier 전국 DOOH DB – Web Map MVP</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0c0d;
      --panel:#0f1011;
      --panel2:#0c0d0e;
      --line:rgba(255,255,255,.10);
      --text:#cfd8e3;
      --muted:rgba(207,216,227,.72);
      --mint:#a2decc;
      --mint2:rgba(162,222,204,.18);
      --shadow:0 18px 60px rgba(0,0,0,.55);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:radial-gradient(900px 450px at 15% 10%, rgba(162,222,204,.10), transparent 60%),
                 radial-gradient(900px 450px at 85% 0%, rgba(162,222,204,.07), transparent 55%),
                 var(--bg);
      color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Arial, sans-serif;
      overflow:hidden;
    }

    /* Top header */
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(to bottom, rgba(15,16,17,.92), rgba(15,16,17,.78));
      backdrop-filter: blur(10px);
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }
    .title h1{
      font-size:14px;
      margin:0;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border:1px solid rgba(162,222,204,.35);
      background:rgba(162,222,204,.08);
      color:rgba(255,255,255,.92);
      border-radius:999px;
      box-shadow:0 0 0 1px rgba(162,222,204,.08) inset, 0 0 24px rgba(162,222,204,.10);
      white-space:nowrap;
    }

    /* Filter bar */
    .filters{
      position:sticky;
      top:0;
      z-index:30;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(to bottom, rgba(12,13,14,.92), rgba(12,13,14,.78));
      backdrop-filter: blur(10px);
    }
    .filters .field{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .filters label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* Inputs (A: 강제 흰색) */
    .filters input[type="text"],
    .filters select{
      height:38px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:#fff;
      outline:none;
    }
    .filters select{ padding-right:34px; }
    .filters input[type="text"]:focus,
    .filters select:focus{
      border-color:rgba(162,222,204,.55);
      box-shadow:0 0 0 3px rgba(162,222,204,.12);
    }

    /* ★ 요청 A: #q 입력 텍스트 흰색 확실히 */
    #q{
      width:min(560px, 44vw);
      color:#fff !important;
      caret-color:#fff !important;
      -webkit-text-fill-color:#fff !important; /* 일부 브라우저/오토필 대비 */
    }
    #q::placeholder{
      color:rgba(255,255,255,.45) !important;
    }

    /* 혹시 더 강한 CSS가 덮어쓰는 경우 대비(스코프 강화) */
    .filters input,
    .filters textarea{
      color:#fff !important;
      caret-color:#fff !important;
      -webkit-text-fill-color:#fff !important;
    }

    .btn{
      height:38px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:#fff;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:rgba(162,222,204,.55);
      background:rgba(162,222,204,.08);
    }
    .btn:active{ transform: translateY(1px); }

    /* Layout */
    .app{
      height:calc(100% - 56px); /* top header height-ish */
      display:flex;
      flex-direction:column;
    }
    .main{
      height:100%;
      display:grid;
      grid-template-columns: 520px 1fr;
      gap:0;
      min-height:0;
    }
    @media (max-width: 1080px){
      .main{ grid-template-columns: 420px 1fr; }
      #q{ width:min(460px, 40vw); }
    }
    @media (max-width: 860px){
      body{ overflow:auto; }
      .app{ height:auto; }
      .main{
        grid-template-columns: 1fr;
        grid-template-rows: 56vh auto;
      }
    }

    /* Left panel */
    .panel{
      background:linear-gradient(to bottom, rgba(15,16,17,.82), rgba(15,16,17,.92));
      border-right:1px solid var(--line);
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .panelInner{
      min-height:0;
      overflow:auto;
      padding:12px 12px 18px;
      position:relative;
    }

    /* Stats sticky */
    .statsSticky{
      position:sticky;
      bottom:0;
      z-index:10;
      margin:12px 0 0;
      padding:10px 10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(12,13,14,.78);
      backdrop-filter: blur(10px);
      border-radius:14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      box-shadow: 0 0 0 1px rgba(162,222,204,.06) inset;
    }
    .stat{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .stat .k{ font-size:11px; color:rgba(255,255,255,.62); }
    .stat .v{ font-size:13px; font-weight:700; color:#fff; }

    /* Cards grid */
    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 1080px){
      .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 860px){
      .cards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 520px){
      .cards{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      transition: transform .12s ease, border-color .15s ease, box-shadow .15s ease;
      box-shadow: 0 0 0 1px rgba(162,222,204,.00) inset;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color:rgba(162,222,204,.40);
      box-shadow: 0 0 0 1px rgba(162,222,204,.10) inset, 0 10px 34px rgba(0,0,0,.45);
    }
    .card.is-hovered{
      border-color:rgba(162,222,204,.72) !important;
      box-shadow: 0 0 0 1px rgba(162,222,204,.18) inset, 0 0 26px rgba(162,222,204,.18);
    }

    .thumb{
      height:108px;
      background:
        radial-gradient(120px 70px at 20% 30%, rgba(162,222,204,.22), transparent 60%),
        radial-gradient(140px 90px at 80% 0%, rgba(162,222,204,.14), transparent 62%),
        rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb .noimg{
      font-size:12px;
      color:rgba(255,255,255,.65);
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }

    .meta{
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .badgeRow{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(162,222,204,.30);
      background:rgba(162,222,204,.10);
      color:rgba(255,255,255,.92);
      max-width:100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .name{
      font-size:13px;
      font-weight:700;
      color:#fff;
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:32px;
    }
    .sub{
      font-size:12px;
      color:rgba(255,255,255,.70);
      line-height:1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:30px;
    }
    .price{
      margin-top:2px;
      font-size:12px;
      color:rgba(255,255,255,.82);
    }
    .price .mint{ color:var(--mint); font-weight:700; }

    /* Map */
    .mapWrap{
      position:relative;
      min-height:0;
      background:rgba(0,0,0,.30);
    }
    #map{
      height:100%;
      width:100%;
    }
    .mapHint{
      position:absolute;
      top:12px;
      right:12px;
      z-index:500;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(12,13,14,.70);
      backdrop-filter: blur(10px);
      box-shadow: 0 0 0 1px rgba(162,222,204,.06) inset;
      font-size:12px;
      color:rgba(255,255,255,.78);
      max-width: 320px;
    }
    .mapHint b{ color:#fff; }

    /* Modal (B: 가로/세로 확대 + 이미지 영역 높이 고정) */
    .detailOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.62);
      z-index:1000;
      display:none;
      align-items:center;
      justify-content:center;
      padding:12px; /* ★ 요청: padding 12px */
    }
    .detailOverlay.open{ display:flex; }

    .detail{
      width:min(1600px, 96vw);           /* ★ 가로 더 확대 */
      height:min(92vh, 920px);           /* ★ 세로 체감 크게 */
      max-height:92vh;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(to bottom, rgba(15,16,17,.94), rgba(12,13,14,.94));
      box-shadow: var(--shadow), 0 0 0 1px rgba(162,222,204,.07) inset;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .detailTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
    }
    .detailTop .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .detailTop .t{
      font-size:14px;
      font-weight:800;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .detailTop .s{
      font-size:12px;
      color:rgba(255,255,255,.70);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .closeBtn{
      height:34px;
      padding:0 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:#fff;
      cursor:pointer;
    }
    .closeBtn:hover{
      border-color:rgba(162,222,204,.55);
      background:rgba(162,222,204,.08);
    }

    .detailBody{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 1.25fr 1fr; /* ★ 요청: 1.25fr 1fr */
      gap:0;
    }
    @media (max-width: 980px){
      .detail{
        height:min(92vh, 980px);
      }
      .detailBody{
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
    }

    .dimg{
      border-right:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(240px 120px at 18% 20%, rgba(162,222,204,.18), transparent 60%),
        rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:12px;
      min-height:0;

      /* ★ 요청: aspect-ratio 제거 + 고정 높이 */
      aspect-ratio:auto;
      height:min(52vh, 520px);
    }
    @media (max-width: 980px){
      .dimg{
        border-right:none;
        border-bottom:1px solid rgba(255,255,255,.10);
        height:min(40vh, 420px);
      }
    }

    .dimg img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      display:block;
      box-shadow: 0 0 0 1px rgba(162,222,204,.05) inset;
    }
    .dimg .noimgBig{
      font-size:13px;
      color:rgba(255,255,255,.74);
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
    }

    .dinfo{
      min-height:0;
      overflow:auto;
      padding:14px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .grid2{ grid-template-columns: 1fr; }
    }
    .kv{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 10px;
    }
    .kv .k{
      font-size:11px;
      color:rgba(255,255,255,.62);
      margin-bottom:4px;
    }
    .kv .v{
      font-size:13px;
      color:#fff;
      line-height:1.35;
      word-break:keep-all;
    }
    .kv .v.mint{ color:var(--mint); font-weight:800; }

    .desc{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:12px 12px;
      color:rgba(255,255,255,.80);
      line-height:1.55;
      font-size:13px;
      white-space:pre-wrap;
    }

    /* Leaflet tweaks (dark vibe) */
    .leaflet-control-attribution{ display:none; }
    .leaflet-control-zoom a{
      background:rgba(12,13,14,.75) !important;
      color:#fff !important;
      border:1px solid rgba(255,255,255,.12) !important;
      backdrop-filter: blur(10px);
    }

    /* Marker hover glow (mint) */
    .marker-mint{
      filter: drop-shadow(0 0 8px rgba(162,222,204,.55)) drop-shadow(0 0 18px rgba(162,222,204,.22));
    }

    /* Loading / empty */
    .empty{
      margin:10px 2px 2px;
      padding:14px 12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:14px;
      color:rgba(255,255,255,.70);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="top">
    <div class="title">
      <h1>Frontier 전국 DOOH DB – 웹 지도 MVP</h1>
      <div class="pill" id="loadedPill">Loaded: …</div>
    </div>
    <div class="pill" style="border-color:rgba(255,255,255,.14);background:rgba(255,255,255,.04);box-shadow:none;color:rgba(255,255,255,.75);">
      Static (GitHub Pages)
    </div>
  </div>

  <div class="app">
    <div class="filters">
      <div class="field" style="flex:1; min-width:0;">
        <label for="q">검색</label>
        <input id="q" type="text" placeholder="매체명/장소/주소 등 검색" autocomplete="off" spellcheck="false" />
      </div>

      <div class="field">
        <label for="catHigh">카테고리</label>
        <select id="catHigh">
          <option value="">전체</option>
        </select>
      </div>

      <button class="btn" id="resetBtn">초기화</button>
    </div>

    <div class="main">
      <!-- Left -->
      <aside class="panel">
        <div class="panelInner" id="panelScroll">
          <div class="cards" id="cards"></div>
          <div id="sentinel" style="height:14px;"></div>
          <div id="emptyBox" class="empty" style="display:none;">검색/필터 결과가 없습니다.</div>

          <div class="statsSticky">
            <div class="stat">
              <div class="k">전체</div>
              <div class="v" id="statTotal">-</div>
            </div>
            <div class="stat">
              <div class="k">필터 결과</div>
              <div class="v" id="statFiltered">-</div>
            </div>
            <div class="stat">
              <div class="k">현재 범위(inView)</div>
              <div class="v" id="statInView">-</div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Right -->
      <section class="mapWrap">
        <div id="map"></div>
        <div class="mapHint">
          <b>Tip</b><br>
          리스트 카드 hover → 지도 마커 민트 하이라이트<br>
          지도 마커 hover → 리스트 카드 glow/스크롤<br>
          클릭 → 해시 모달 <span style="color:var(--mint);font-weight:700;">#item=...</span>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal -->
  <div class="detailOverlay" id="detailOverlay" aria-hidden="true">
    <div class="detail" role="dialog" aria-modal="true" aria-label="상세">
      <div class="detailTop">
        <div class="left">
          <div class="t" id="dtTitle">-</div>
          <div class="s" id="dtSub">-</div>
        </div>
        <button class="closeBtn" id="closeBtn">닫기 (Esc)</button>
      </div>

      <div class="detailBody">
        <div class="dimg" id="dtImgWrap"></div>
        <div class="dinfo">
          <div class="grid2">
            <div class="kv">
              <div class="k">카테고리</div>
              <div class="v" id="dtCat">-</div>
            </div>
            <div class="kv">
              <div class="k">가격</div>
              <div class="v mint" id="dtPrice">-</div>
            </div>
            <div class="kv">
              <div class="k">장소</div>
              <div class="v" id="dtPlace">-</div>
            </div>
            <div class="kv">
              <div class="k">주소/상세 위치</div>
              <div class="v" id="dtAddr">-</div>
            </div>
          </div>

          <div class="desc" id="dtDesc" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =============== Config ===============
    const DATA_URL = "data_public.json";
    const MINT = "#a2decc";

    // =============== State ===============
    let raw = [];
    let filtered = [];
    let renderCursor = 0;
    const PAGE_SIZE = 60;

    let map, cluster;
    const markerById = new Map();   // id -> marker
    const itemById = new Map();     // id -> item
    const cardElById = new Map();   // id -> element

    let activeHoverId = null;

    // =============== Helpers ===============
    function safeStr(v){ return (v === null || v === undefined) ? "" : String(v); }
    function norm(s){ return safeStr(s).trim().toLowerCase(); }

    function pickId(item, idx){
      return safeStr(item.public_id || item.id || item.uid || item.key || item._id || ("idx_" + idx));
    }

    function pickLatLng(item){
      const lat = Number(item.lat ?? item.latitude ?? item.y);
      const lng = Number(item.lng ?? item.lon ?? item.longitude ?? item.x);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
      return [lat, lng];
    }

    function pickCatHigh(item){
      return safeStr(item.catHigh || item.category_high || item.categoryHigh || item.cat_high || item.media_group || item.group || "").trim();
    }

    function pickName(item){
      return safeStr(item.name || item.media_name || item.title || item.media || item.asset_name || "이름 없음").trim();
    }

    function pickPlace(item){
      return safeStr(item.place || item.location || item.venue || item.site || item.mall || item.station || "").trim();
    }

    function pickAddr(item){
      return safeStr(item.addr || item.address || item.address_road || item.road_address || item.address_jibun || "").trim();
    }

    function pickPrice(item){
      return safeStr(item.price || item.cost || item.rate || item.unit_price || "").trim();
    }

    function pickImg(item){
      return safeStr(item.img || item.image || item.image_url || item.thumbnail || item.thumb || "").trim();
    }

    function buildSearchHay(item){
      const parts = [
        pickName(item),
        pickPlace(item),
        pickAddr(item),
        pickCatHigh(item),
        safeStr(item.city || item.sido || item.sigungu || item.region || ""),
      ];
      return norm(parts.join(" "));
    }

    function setLoadedPill(n){
      document.getElementById("loadedPill").textContent = "Loaded: " + n;
    }

    // =============== UI Elements ===============
    const elQ = document.getElementById("q");
    const elCat = document.getElementById("catHigh");
    const elReset = document.getElementById("resetBtn");
    const elCards = document.getElementById("cards");
    const elSentinel = document.getElementById("sentinel");
    const elEmpty = document.getElementById("emptyBox");
    const elPanelScroll = document.getElementById("panelScroll");

    const elStatTotal = document.getElementById("statTotal");
    const elStatFiltered = document.getElementById("statFiltered");
    const elStatInView = document.getElementById("statInView");

    // Modal els
    const overlay = document.getElementById("detailOverlay");
    const closeBtn = document.getElementById("closeBtn");
    const dtTitle = document.getElementById("dtTitle");
    const dtSub = document.getElementById("dtSub");
    const dtImgWrap = document.getElementById("dtImgWrap");
    const dtCat = document.getElementById("dtCat");
    const dtPrice = document.getElementById("dtPrice");
    const dtPlace = document.getElementById("dtPlace");
    const dtAddr = document.getElementById("dtAddr");
    const dtDesc = document.getElementById("dtDesc");

    // =============== Map ===============
    function initMap(){
      map = L.map("map", { zoomControl:true });

      // Dark-friendly tiles (OpenStreetMap standard; 필요시 교체 가능)
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(map);

      cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        chunkedLoading: true
      });
      map.addLayer(cluster);

      // Default view: Korea-ish
      map.setView([36.4, 127.9], 7);

      map.on("moveend", () => {
        updateInViewCount(); // 성능: moveend에서는 "재생성" 안 함
      });
    }

    function clearMarkers(){
      markerById.clear();
      cluster.clearLayers();
    }

    function rebuildMarkers(){
      clearMarkers();

      for (const item of filtered){
        const ll = pickLatLng(item);
        if (!ll) continue;

        const id = item.__id;
        const marker = L.marker(ll, { title: pickName(item) });

        marker.on("mouseover", () => {
          hoverCard(id, true);
        });
        marker.on("mouseout", () => {
          hoverCard(id, false);
        });
        marker.on("click", () => {
          location.hash = "#item=" + encodeURIComponent(id);
        });

        markerById.set(id, marker);
        cluster.addLayer(marker);
      }

      updateInViewCount();
    }

    function mintMarker(id, on){
      const m = markerById.get(id);
      if (!m) return;
      const iconEl = m.getElement();
      if (!iconEl) return;
      if (on) iconEl.classList.add("marker-mint");
      else iconEl.classList.remove("marker-mint");
    }

    // =============== List / Cards ===============
    function resetList(){
      renderCursor = 0;
      elCards.innerHTML = "";
      cardElById.clear();
    }

    function makeCard(item){
      const id = item.__id;
      const cat = pickCatHigh(item) || "미분류";
      const name = pickName(item);
      const place = pickPlace(item);
      const addr = pickAddr(item);
      const price = pickPrice(item);
      const img = pickImg(item);

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = id;

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if (img){
        const im = document.createElement("img");
        im.src = img;
        im.alt = name;
        im.loading = "lazy";
        im.referrerPolicy = "no-referrer";
        im.onerror = () => {
          thumb.innerHTML = "";
          const ni = document.createElement("div");
          ni.className = "noimg";
          ni.textContent = "NO IMAGE";
          thumb.appendChild(ni);
        };
        thumb.appendChild(im);
      }else{
        const ni = document.createElement("div");
        ni.className = "noimg";
        ni.textContent = "NO IMAGE";
        thumb.appendChild(ni);
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const badgeRow = document.createElement("div");
      badgeRow.className = "badgeRow";
      const badge = document.createElement("div");
      badge.className = "badge";
      badge.textContent = cat;
      badgeRow.appendChild(badge);

      const nm = document.createElement("div");
      nm.className = "name";
      nm.textContent = name;

      const sb = document.createElement("div");
      sb.className = "sub";
      sb.textContent = (place || addr || "-");

      const pr = document.createElement("div");
      pr.className = "price";
      if (price){
        pr.innerHTML = `<span class="mint">${escapeHtml(price)}</span>`;
      }else{
        pr.innerHTML = `<span style="color:rgba(255,255,255,.62);">가격 정보 없음</span>`;
      }

      meta.appendChild(badgeRow);
      meta.appendChild(nm);
      meta.appendChild(sb);
      meta.appendChild(pr);

      card.appendChild(thumb);
      card.appendChild(meta);

      card.addEventListener("mouseenter", () => hoverCard(id, true));
      card.addEventListener("mouseleave", () => hoverCard(id, false));
      card.addEventListener("click", () => {
        location.hash = "#item=" + encodeURIComponent(id);
      });

      cardElById.set(id, card);
      return card;
    }

    function renderNext(){
      const end = Math.min(renderCursor + PAGE_SIZE, filtered.length);
      for (let i = renderCursor; i < end; i++){
        const card = makeCard(filtered[i]);
        elCards.appendChild(card);
      }
      renderCursor = end;

      elEmpty.style.display = (filtered.length === 0) ? "block" : "none";
    }

    function hoverCard(id, on){
      const el = cardElById.get(id);
      if (!el) return;

      if (on){
        activeHoverId = id;
        el.classList.add("is-hovered");
        mintMarker(id, true);

        // Scroll into view (gentle)
        const rect = el.getBoundingClientRect();
        const pr = elPanelScroll.getBoundingClientRect();
        if (rect.top < pr.top + 8 || rect.bottom > pr.bottom - 8){
          el.scrollIntoView({ block:"nearest", behavior:"smooth" });
        }
      }else{
        if (activeHoverId === id) activeHoverId = null;
        el.classList.remove("is-hovered");
        mintMarker(id, false);
      }
    }

    // =============== Filter / Search ===============
    function buildCategoryOptions(){
      const set = new Set();
      for (const it of raw){
        const c = pickCatHigh(it);
        if (c) set.add(c);
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b,"ko"));
      elCat.innerHTML = `<option value="">전체</option>` + cats.map(c => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`).join("");
    }

    function applyFilter(){
      const q = norm(elQ.value);
      const cat = safeStr(elCat.value).trim();

      filtered = raw.filter(it => {
        if (cat){
          const c = pickCatHigh(it);
          if (c !== cat) return false;
        }
        if (q){
          return it.__hay.includes(q);
        }
        return true;
      });

      // stats
      elStatTotal.textContent = raw.length.toLocaleString();
      elStatFiltered.textContent = filtered.length.toLocaleString();

      resetList();
      // 새 필터 결과에서만 마커 재구성 (moveend에서 재생성 금지)
      rebuildMarkers();
      renderNext();
    }

    // =============== In-view Count (map bounds) ===============
    function updateInViewCount(){
      if (!map) return;
      const b = map.getBounds();
      let count = 0;
      for (const it of filtered){
        const ll = pickLatLng(it);
        if (!ll) continue;
        if (b.contains(ll)) count++;
      }
      elStatInView.textContent = count.toLocaleString();
    }

    // =============== Hash Modal ===============
    function openModal(id){
      const item = itemById.get(id);
      if (!item) return;

      const cat = pickCatHigh(item) || "미분류";
      const name = pickName(item);
      const place = pickPlace(item);
      const addr = pickAddr(item);
      const price = pickPrice(item);
      const img = pickImg(item);

      dtTitle.textContent = name;
      dtSub.textContent = place || addr || "-";
      dtCat.textContent = cat;
      dtPlace.textContent = place || "-";
      dtAddr.textContent = addr || "-";
      dtPrice.textContent = price || "가격 정보 없음";

      // Optional description (있으면 표시)
      const desc = safeStr(item.desc || item.description || item.note || item.memo || "").trim();
      if (desc){
        dtDesc.style.display = "block";
        dtDesc.textContent = desc;
      }else{
        dtDesc.style.display = "none";
        dtDesc.textContent = "";
      }

      dtImgWrap.innerHTML = "";
      if (img){
        const im = document.createElement("img");
        im.src = img;
        im.alt = name;
        im.referrerPolicy = "no-referrer";
        im.onerror = () => {
          dtImgWrap.innerHTML = `<div class="noimgBig">NO IMAGE</div>`;
        };
        dtImgWrap.appendChild(im);
      }else{
        dtImgWrap.innerHTML = `<div class="noimgBig">NO IMAGE</div>`;
      }

      overlay.classList.add("open");
      overlay.setAttribute("aria-hidden", "false");

      // map focus
      const ll = pickLatLng(item);
      if (ll && map){
        map.panTo(ll, { animate:true, duration:0.35 });
      }
    }

    function closeModal(){
      overlay.classList.remove("open");
      overlay.setAttribute("aria-hidden", "true");
    }

    function parseHash(){
      const h = location.hash || "";
      const m = h.match(/#item=([^&]+)/);
      return m ? decodeURIComponent(m[1]) : null;
    }

    function onHashChange(){
      const id = parseHash();
      if (!id){
        closeModal();
        return;
      }
      openModal(id);
    }

    // Overlay interactions
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay){
        location.hash = "";
      }
    });
    closeBtn.addEventListener("click", () => location.hash = "");
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.classList.contains("open")){
        location.hash = "";
      }
    });

    // =============== Infinite scroll (panel) ===============
    const io = new IntersectionObserver((entries) => {
      for (const ent of entries){
        if (ent.isIntersecting){
          if (renderCursor < filtered.length){
            renderNext();
          }
        }
      }
    }, { root: elPanelScroll, threshold: 0.1 });
    io.observe(elSentinel);

    // =============== Events ===============
    let tmr = null;
    elQ.addEventListener("input", () => {
      // small debounce
      clearTimeout(tmr);
      tmr = setTimeout(applyFilter, 120);
    });
    elCat.addEventListener("change", applyFilter);
    elReset.addEventListener("click", () => {
      elQ.value = "";
      elCat.value = "";
      applyFilter();
      // 포커스 다시
      elQ.focus();
    });

    window.addEventListener("hashchange", onHashChange);

    // =============== HTML escape (safe) ===============
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeHtmlAttr(s){
      return escapeHtml(s).replaceAll("\n"," ");
    }

    // =============== Boot ===============
    async function boot(){
      initMap();

      const res = await fetch(DATA_URL, { cache:"no-store" });
      const data = await res.json();

      raw = Array.isArray(data) ? data : (data.items || data.data || []);
      raw = raw.map((it, idx) => {
        const obj = it || {};
        obj.__id = pickId(obj, idx);
        obj.__hay = buildSearchHay(obj);
        return obj;
      });

      // maps
      itemById.clear();
      for (const it of raw) itemById.set(it.__id, it);

      setLoadedPill(raw.length);
      buildCategoryOptions();

      // stats init
      elStatTotal.textContent = raw.length.toLocaleString();

      applyFilter();

      // hash open if any
      onHashChange();
    }

    // wait for leaflet scripts (defer)
    window.addEventListener("load", () => {
      boot().catch(err => {
        console.error(err);
        setLoadedPill("ERROR");
        elEmpty.style.display = "block";
        elEmpty.textContent = "데이터 로딩 실패. 콘솔(F12) 확인.";
      });
    });
  </script>
</body>
</html>
