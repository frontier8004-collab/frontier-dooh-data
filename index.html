<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frontier DOOH 전국 DB</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0d10;
      --panel:#12161b;
      --panel2:#0f1318;
      --stroke:rgba(255,255,255,.08);
      --stroke2:rgba(255,255,255,.12);
      --text:#e7edf7;
      --muted:rgba(231,237,247,.65);
      --mint:#7de3c6;
      --mint2:#a2decc;
      --danger:#ff5c5c;
      --radius:18px;
      --shadow:0 20px 50px rgba(0,0,0,.45);
    }

    @import url('https://webfontworld.github.io/NanumSquare/NanumSquare.css');

    html,body{height:100%; margin:0; background:var(--bg); color:var(--text);}
    body{font-family:'NanumSquare',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; overflow:hidden;}

    #app{position:fixed; inset:0; display:flex; align-items:stretch; justify-content:stretch;}

    /* Map */
    #map{
      position:relative;
      flex:1;
      height:100%;
      z-index:1;
      background: #000;
    }

    /* Floating search bar */
    #topbar{
      position:absolute;
      left:50%;
      top:14px;
      transform:translateX(-50%);
      width:min(980px, calc(100% - 44px));
      z-index:9999;
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(18,22,27,.80);
      border:1px solid var(--stroke);
      backdrop-filter: blur(10px);
      box-shadow:0 12px 30px rgba(0,0,0,.35);
    }
    #searchInput{
      flex:1;
      height:40px;
      padding:0 14px;
      border-radius:999px;
      outline:none;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);
      color:var(--text);
      font-size:14px;
    }
    #searchInput::placeholder{color:rgba(231,237,247,.45);}
    .btn{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{border-color:var(--stroke2);}
    .btn.mint{
      border-color:rgba(125,227,198,.35);
      box-shadow:0 0 0 1px rgba(125,227,198,.16) inset;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:26px;
      padding:0 10px;
      height:24px;
      border-radius:999px;
      background:rgba(125,227,198,.14);
      border:1px solid rgba(125,227,198,.35);
      color:var(--mint2);
      font-weight:800;
      font-size:12px;
    }

    /* Left “building” panel */
    #side{
      position:absolute;
      left:14px;
      top:14px;
      bottom:14px;
      width:320px;
      max-width:calc(100% - 28px);
      z-index:9998;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    #side .building{
      pointer-events:auto;
      height:100%;
      border-radius:22px;
      background:rgba(18,22,27,.86);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    #sideHeader{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .hTitle{
      font-size:12px;
      letter-spacing:.12em;
      color:rgba(231,237,247,.55);
      text-transform:uppercase;
    }
    .miniRow{
      display:flex;
      gap:8px;
      align-items:center;
    }

    /* Zoom UI (v1.1.26 style already applied) */
    .zoomCard{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
    }
    .zoomLeft{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:10px 12px;
      min-height:44px;
    }
    .zoomLabel{
      font-size:12px;
      letter-spacing:.12em;
      color:rgba(231,237,247,.55);
      text-transform:uppercase;
    }
    .zoomNum{
      font-weight:900;
      font-size:18px;
      color:var(--text);
    }
    .zoomRight{
      width:56px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .zBtn{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      font-size:18px;
    }
    .zBtn:hover{border-color:rgba(255,255,255,.14);}

    /* Cart + Recent sections */
    .section{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .sectionTitle{
      font-weight:800;
      font-size:13px;
      color:rgba(231,237,247,.90);
    }
    .cartRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(125,227,198,.25);
      background:rgba(125,227,198,.08);
    }
    .cartRow .label{font-weight:900;}
    .cartRow .count{
      min-width:34px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
    }

    /* Recent list */
    .recentList{
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:calc(100vh - 360px);
      overflow:auto;
      padding-right:6px;
    }
    .recentCard{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      overflow:hidden;
    }
    .recentImg{
      width:100%;
      aspect-ratio: 16 / 9;
      background:rgba(255,255,255,.04);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(231,237,247,.35);
      font-size:12px;
    }
    .recentBody{padding:10px 12px; display:flex; flex-direction:column; gap:6px;}
    .recentName{
      font-weight:900;
      font-size:13px;
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .recentPrice{
      font-weight:900;
      font-size:14px;
      color:var(--mint2);
    }
    .bottomPager{
      margin-top:auto;
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    /* Right list panel (search results) */
    #results{
      position:absolute;
      right:14px;
      top:14px;
      bottom:14px;
      width:520px;
      max-width:calc(100% - 28px);
      z-index:9998;
      border-radius:22px;
      background:rgba(18,22,27,.86);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      pointer-events:auto;
    }
    #resultsHeader{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #resultsHeader .title{
      font-weight:900;
      font-size:14px;
    }
    #resultsList{
      flex:1;
      overflow:auto;
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      padding:12px 12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition: transform .12s ease, border-color .12s ease;
    }
    .item:hover{
      transform:translateY(-1px);
      border-color:rgba(125,227,198,.22);
    }
    .item .name{
      font-weight:900;
      font-size:15px;
      line-height:1.25;
    }
    .item .sub{
      color:rgba(231,237,247,.65);
      font-size:12px;
      line-height:1.3;
    }
    .item .price{
      margin-top:2px;
      font-weight:900;
      color:var(--mint2);
    }

    /* Mini modal (marker popup) */
    .miniPopup{
      width:240px;
      font-family:'NanumSquare',sans-serif;
      color:var(--text);
    }
    .miniPopup .pName{
      font-weight:900;
      margin:0 0 6px;
      font-size:14px;
      line-height:1.25;
    }
    .miniPopup .pPrice{
      font-weight:900;
      color:var(--mint2);
      margin-bottom:10px;
    }
    .miniPopup .pBtns{
      display:flex;
      gap:8px;
    }
    .miniPopup .pBtns button{
      flex:1;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
    }
    .miniPopup .pBtns button:hover{
      border-color:rgba(125,227,198,.22);
    }

    /* Modal overlay */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
      padding:22px;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(1100px, 100%);
      max-height:min(86vh, 860px);
      border-radius:24px;
      background:rgba(18,22,27,.96);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHead .mTitle{
      font-weight:900;
      font-size:14px;
      letter-spacing:.02em;
    }
    .xBtn{
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
      font-weight:900;
    }
    .modalBody{
      padding:14px 16px;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* Leaflet tweaks */
    .leaflet-control-attribution{display:none;}
    .leaflet-container{background:#0b0d10;}
    .leaflet-popup-content-wrapper{
      background:rgba(18,22,27,.95);
      color:var(--text);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 18px 50px rgba(0,0,0,.45);
    }
    .leaflet-popup-tip{
      background:rgba(18,22,27,.95);
      border:1px solid rgba(255,255,255,.10);
    }

    /* Responsive */
    @media (max-width:1100px){
      #results{display:none;}
      #side{width:320px;}
      #topbar{width:calc(100% - 28px);}
    }
    @media (max-width:520px){
      #side{left:10px; top:10px; bottom:10px; width:280px;}
      #topbar{top:10px;}
    }
  </style>
</head>

<body>
  <div id="app">
    <div id="map"></div>

    <div id="topbar">
      <input id="searchInput" placeholder="지역/매체명을 검색하세요 (예: 인천공항, 강남, KT SQUARE)" />
      <button id="btnReset" class="btn">초기화</button>
      <button id="btnToggleResults" class="btn mint">검색결과</button>
    </div>

    <div id="side">
      <div class="building">
        <div id="sideHeader">
          <div class="hTitle">ZOOM</div>
          <div class="miniRow">
            <span class="pill" id="clusterCount">0</span>
          </div>
        </div>

        <div class="zoomCard">
          <div class="zoomLeft">
            <div class="zoomLabel">ZOOM</div>
            <div class="zoomNum" id="zoomNum">0</div>
          </div>
          <div class="zoomRight">
            <button class="zBtn" id="zoomIn">+</button>
            <button class="zBtn" id="zoomOut">−</button>
          </div>
        </div>

        <div class="section">
          <div class="sectionHead">
            <div class="sectionTitle">제안서</div>
            <button id="btnCartOpen" class="btn" style="height:30px;padding:0 10px;font-size:12px;">열기</button>
          </div>
          <div class="cartRow">
            <div class="label">장바구니</div>
            <div class="count" id="cartCount">0</div>
          </div>
        </div>

        <div class="section">
          <div class="sectionHead">
            <div class="sectionTitle">최근 본 매체</div>
            <div style="font-weight:900;color:rgba(231,237,247,.65);font-size:12px;" id="recentCount">0/4</div>
          </div>
          <div class="recentList" id="recentList"></div>
        </div>

        <div class="bottomPager">
          <button class="btn" id="recentPrev" style="height:34px;">←</button>
          <div style="font-weight:900;color:rgba(231,237,247,.65);" id="recentPage">1/1</div>
          <button class="btn" id="recentNext" style="height:34px;">→</button>
        </div>
      </div>
    </div>

    <div id="results">
      <div id="resultsHeader">
        <div class="title">검색 결과</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="pill" id="resultsCount">0</span>
          <button id="btnCloseResults" class="btn" style="height:34px;">닫기</button>
        </div>
      </div>
      <div id="resultsList"></div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="overlay" id="cartOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="mTitle">장바구니</div>
        <button class="xBtn" id="cartClose">×</button>
      </div>
      <div class="modalBody" id="cartBody"></div>
    </div>
  </div>

  <!-- Hash Modal (detail) -->
  <div class="overlay" id="hashOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="mTitle" id="hashTitle">상세</div>
        <button class="xBtn" id="hashClose">×</button>
      </div>
      <div class="modalBody" id="hashBody"></div>
    </div>
  </div>

  <script>
    // v1.1.26 restore build (data loader hardened)
    (async () => {
      const VERSION = "v1.1.26";

      // Utils
      const qs = (s, el=document) => el.querySelector(s);
      const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
      const fmtPrice = (v) => {
        if(v===null || v===undefined || v==="" || isNaN(Number(v))) return "문의";
        const n = Number(v);
        if(!isFinite(n) || n<=0) return "문의";
        return n.toLocaleString("ko-KR") + "원";
      };

      const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

      // DOM
      const elZoomNum = qs("#zoomNum");
      const elClusterCount = qs("#clusterCount");
      const elSearch = qs("#searchInput");
      const elResults = qs("#results");
      const elResultsList = qs("#resultsList");
      const elResultsCount = qs("#resultsCount");
      const elRecentList = qs("#recentList");
      const elRecentCount = qs("#recentCount");
      const elRecentPage = qs("#recentPage");
      const elCartCount = qs("#cartCount");

      // Modals
      const cartOverlay = qs("#cartOverlay");
      const cartBody = qs("#cartBody");
      const hashOverlay = qs("#hashOverlay");
      const hashTitle = qs("#hashTitle");
      const hashBody = qs("#hashBody");

      // State
      const RECENT_MAX = 4;
      const RECENT_PAGE_SIZE = 2;
      let recent = [];
      let recentPage = 1;

      // Cart storage (A안: 사용자(브라우저) 단위 localStorage)
      const CART_KEY = "frontier_dooh_cart_v1";
      let cart = [];
      function loadCart(){
        try{
          const raw = localStorage.getItem(CART_KEY);
          cart = raw ? JSON.parse(raw) : [];
          if(!Array.isArray(cart)) cart = [];
        }catch(e){ cart = []; }
        elCartCount.textContent = String(cart.length || 0);
      }
      function saveCart(){
        try{ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }catch(e){}
        elCartCount.textContent = String(cart.length || 0);
      }

      function addToCart(item){
        // IMPORTANT: "같은 위치/몰려있는 핀"이 하나로 합쳐지는 문제를 피하려면
        // 개별 고유키가 필요합니다. data.json에 id가 없다면 아래처럼 fallback 키를 만든다.
        const key = item.id || item.media_id || item.uid || item._uid || (item.name + "|" + item.address + "|" + item.lat + "|" + item.lng + "|" + (item.price||""));
        if(cart.some(x => (x._key || x.id || x.media_id || x.uid) === key)) return;
        cart.push({ ...item, _key: key });
        saveCart();
      }

      // Recent
      function pushRecent(item){
        const key = item.id || item.media_id || item.uid || item._uid || (item.name + "|" + item.address + "|" + item.lat + "|" + item.lng);
        recent = recent.filter(x => (x._key||x.id||x.media_id||x.uid) !== key);
        recent.unshift({ ...item, _key: key });
        if(recent.length > RECENT_MAX) recent = recent.slice(0, RECENT_MAX);
        recentPage = 1;
        renderRecent();
      }

      function renderRecent(){
        const total = recent.length;
        elRecentCount.textContent = `${total}/${RECENT_MAX}`;
        const totalPages = Math.max(1, Math.ceil(total / RECENT_PAGE_SIZE));
        recentPage = clamp(recentPage, 1, totalPages);
        elRecentPage.textContent = `${recentPage}/${totalPages}`;

        const start = (recentPage-1)*RECENT_PAGE_SIZE;
        const items = recent.slice(start, start+RECENT_PAGE_SIZE);

        elRecentList.innerHTML = items.map(x => {
          const img = (x.image_url || x.img || x.image || "").trim();
          const imgHtml = img
            ? `<div class="recentImg" style="background-image:url('${img}');background-size:cover;background-position:center;"></div>`
            : `<div class="recentImg">NO IMAGE</div>`;
          return `
            <div class="recentCard" data-key="${x._key}">
              ${imgHtml}
              <div class="recentBody">
                <div class="recentName" title="${(x.name||"").replace(/"/g,'&quot;')}">${x.name || "-"}</div>
                <div class="recentPrice">${fmtPrice(x.price)}</div>
              </div>
            </div>
          `;
        }).join("");

        qsa(".recentCard", elRecentList).forEach(card=>{
          card.addEventListener("click", ()=>{
            const key = card.getAttribute("data-key");
            const item = recent.find(r => r._key === key);
            if(item) openHashModal(item);
          });
        });
      }

      qs("#recentPrev").addEventListener("click", ()=>{ recentPage--; renderRecent(); });
      qs("#recentNext").addEventListener("click", ()=>{ recentPage++; renderRecent(); });

      // Results panel toggle
      qs("#btnToggleResults").addEventListener("click", ()=> elResults.style.display = (elResults.style.display==="none" ? "flex" : "none"));
      qs("#btnCloseResults").addEventListener("click", ()=> elResults.style.display="none");

      // Reset
      qs("#btnReset").addEventListener("click", ()=>{
        elSearch.value = "";
        renderResults([]);
        // Default view (South Korea)
        map.setView([36.4, 127.9], 7);
      });

      // Cart modal open/close
      qs("#btnCartOpen").addEventListener("click", ()=>{ openCartModal(); });
      qs("#cartClose").addEventListener("click", ()=>{ closeCartModal(); });
      qs("#hashClose").addEventListener("click", ()=>{
        closeHashModal();
        // v1.1.26 요구: 해시모달 X 닫으면 장바구니로 복귀 (장바구니가 열려있던 경우)
        if(cartOverlay.classList.contains("show")){
          // already open
        }
      });

      cartOverlay.addEventListener("click", (e)=>{ if(e.target===cartOverlay) closeCartModal(); });
      hashOverlay.addEventListener("click", (e)=>{ if(e.target===hashOverlay) closeHashModal(); });

      function openCartModal(){
        renderCartModal();
        cartOverlay.classList.add("show");
      }
      function closeCartModal(){
        cartOverlay.classList.remove("show");
      }
      function openHashModal(item){
        // UI 1차 자율 변경 영역(요청사항 9) - 현재는 임시 기본 구성
        hashTitle.textContent = item.name || "상세";
        const img = (item.image_url || item.img || item.image || "").trim();
        const imgBlock = img
          ? `<div style="border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);">
               <img src="${img}" alt="" style="width:100%;display:block;max-height:360px;object-fit:cover;">
             </div>`
          : `<div style="border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);height:260px;display:flex;align-items:center;justify-content:center;color:rgba(231,237,247,.35);font-weight:900;">NO IMAGE</div>`;

        hashBody.innerHTML = `
          ${imgBlock}
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <div class="pill">업데이트 ${(item.updated_at || item.update || "-")}</div>
            <div class="pill">${(item.media_group || item.group || "미분류")}</div>
          </div>
          <div style="color:rgba(231,237,247,.75);line-height:1.6;font-size:13px;">
            ${(item.description || item.desc || item.note || "").toString().replace(/\n/g,"<br>")}
          </div>
          <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;">
            <button class="btn mint" id="hashAddCart">제안서 담기</button>
          </div>
        `;
        qs("#hashAddCart").addEventListener("click", ()=>{
          addToCart(item);
          // 담기 후 장바구니 모달로
          closeHashModal();
          openCartModal();
        });

        hashOverlay.classList.add("show");
      }
      function closeHashModal(){
        hashOverlay.classList.remove("show");
      }

      function renderCartModal(){
        if(!cart.length){
          cartBody.innerHTML = `<div style="color:rgba(231,237,247,.55);padding:14px 2px;">장바구니가 비어 있습니다.</div>`;
          return;
        }

        // v1.1.26 요구: 이미지 크기를 미니모달(팝업) 수준으로, 폰트 크기 조절
        // 적용 폰트 포인트(대략):
        // - 제목: 13px, 부제: 12px, 가격: 13px
        cartBody.innerHTML = cart.map((x, idx)=>{
          const img = (x.image_url || x.img || x.image || "").trim();
          const imgHtml = img
            ? `<img src="${img}" style="width:240px;height:135px;object-fit:cover;border-radius:14px;border:1px solid rgba(255,255,255,.10);">`
            : `<div style="width:240px;height:135px;border-radius:14px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);display:flex;align-items:center;justify-content:center;color:rgba(231,237,247,.35);font-weight:900;">NO IMAGE</div>`;

          return `
            <div class="item" data-idx="${idx}" style="cursor:default;">
              <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;">
                ${imgHtml}
                <div style="flex:1;min-width:240px;">
                  <div style="font-weight:900;font-size:13px;line-height:1.25;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${(x.name||"").replace(/"/g,'&quot;')}">${x.name || "-"}</div>
                  <div style="color:rgba(231,237,247,.65);font-size:12px;line-height:1.4;margin-bottom:8px;">${x.address || x.addr || "-"}</div>
                  <div style="font-weight:900;color:var(--mint2);font-size:13px;margin-bottom:12px;">${fmtPrice(x.price)}</div>

                  <div style="display:flex;gap:10px;justify-content:flex-end;">
                    <button class="btn" data-act="open">상세</button>
                    <button class="btn" data-act="remove">삭제</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join("");

        qsa(".item", cartBody).forEach(row=>{
          const idx = Number(row.getAttribute("data-idx"));
          qsa("button", row).forEach(btn=>{
            btn.addEventListener("click", ()=>{
              const act = btn.getAttribute("data-act");
              if(act==="open"){
                // 장바구니 → 상세(해시모달)로 이동, 그리고 X 닫으면 다시 장바구니로 돌아오는 동작은:
                // 해시모달을 닫을 때 cartOverlay가 show 상태라면 그대로 유지되므로 자연스럽게 복귀됨.
                openHashModal(cart[idx]);
              }else if(act==="remove"){
                cart.splice(idx,1);
                saveCart();
                renderCartModal();
              }
            });
          });
        });
      }

      // Map init
      const map = L.map('map', {
        zoomControl:false,
        preferCanvas:true
      });

      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      });
      tiles.addTo(map);

      map.setView([36.4, 127.9], 7);

      // Zoom controls
      qs("#zoomIn").addEventListener("click", ()=> map.zoomIn());
      qs("#zoomOut").addEventListener("click", ()=> map.zoomOut());

      map.on("zoomend", ()=>{
        elZoomNum.textContent = String(map.getZoom());
      });
      elZoomNum.textContent = String(map.getZoom());

      // Cluster
      const cluster = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        // "드래곤볼" 방지 성격: 애니메이션을 줄이면 순간 퍼짐/사라짐 현상이 감소
        animate: false,
        animateAddingMarkers: false,
        spiderfyDistanceMultiplier: 1.0,
        disableClusteringAtZoom: 18
      });

      map.addLayer(cluster);

      // --- DATA LOADING (RESTORE CORE FIX) ---
      // Load data
      let data = [];
      const __FETCH_TIMEOUT_MS = 20000;

      async function fetchJsonWithTimeout(url, ms){
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), ms);
        try{
          const res = await fetch(url, { cache: "no-store", signal: ctrl.signal });
          if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const text = await res.text();
          try{
            return JSON.parse(text);
          }catch(parseErr){
            throw new Error(`JSON parse error: ${parseErr.message}`);
          }
        }finally{
          clearTimeout(t);
        }
      }

      async function loadDataJson(){
        // Candidate URLs (try in order)
        const baseDir = location.href.replace(/[?#].*$/, "").replace(/\/[^\/]*$/, "/");
        const candidates = [
          { label: "relative", url: "data.json" },
          { label: "dot-relative", url: "./data.json" },
          { label: "baseDir", url: baseDir + "data.json" },
          // Fallbacks (in case GitHub Pages path or cache gets weird)
          { label: "raw-github", url: "https://raw.githubusercontent.com/frontier8004-collab/frontier-dooh-data/main/data.json" },
          { label: "jsdelivr", url: "https://cdn.jsdelivr.net/gh/frontier8004-collab/frontier-dooh-data@main/data.json" },
        ];

        let lastErr = null;
        for(const c of candidates){
          try{
            const loaded = await fetchJsonWithTimeout(c.url, __FETCH_TIMEOUT_MS);
            console.log("[DATA] loaded via", c.label, c.url, "(items:", Array.isArray(loaded) ? loaded.length : "n/a", ")");
            return loaded;
          }catch(err){
            lastErr = err;
            console.warn("[DATA] load failed:", c.label, c.url, String(err && err.message ? err.message : err));
          }
        }

        const msg =
          "data.json 로드 실패.\n" +
          "1) index.html과 같은 폴더에 data.json이 있는지 확인\n" +
          "2) GitHub Pages 캐시/배포 상태 확인\n\n" +
          "마지막 에러: " + (lastErr ? (lastErr.message || String(lastErr)) : "unknown");
        alert(msg);
        return [];
      }

      data = await loadDataJson();

      if(!Array.isArray(data)){
        alert("data.json 형식이 올바르지 않습니다. 배열(Array) 형태여야 합니다.");
        data = [];
      }

      // Build markers
      const markers = [];
      function glowMarker(marker){
        // "빛나라" 효과: 간단한 CSS pulse를 marker element에 적용
        const el = marker.getElement && marker.getElement();
        if(!el) return;
        el.style.filter = "drop-shadow(0 0 10px rgba(125,227,198,.95)) drop-shadow(0 0 18px rgba(125,227,198,.55))";
        el.style.transform = "translate3d(0,0,0) scale(1.12)";
        setTimeout(()=>{
          el.style.filter = "";
          el.style.transform = "";
        }, 900);
      }

      function toLatLng(item){
        const lat = Number(item.lat ?? item.latitude);
        const lng = Number(item.lng ?? item.lon ?? item.longitude);
        if(!isFinite(lat) || !isFinite(lng)) return null;
        return [lat,lng];
      }

      function makePopup(item, marker){
        const div = document.createElement("div");
        div.className = "miniPopup";
        div.innerHTML = `
          <div class="pName">${item.name || "-"}</div>
          <div class="pPrice">${fmtPrice(item.price)}</div>
          <div class="pBtns">
            <button data-act="open">상세</button>
            <button data-act="cart">담기</button>
          </div>
        `;
        div.querySelectorAll("button").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.getAttribute("data-act");
            if(act==="open"){
              openHashModal(item);
            }else if(act==="cart"){
              addToCart(item);
            }
          });
        });
        return div;
      }

      // Create markers and attach events
      data.forEach(item=>{
        const ll = toLatLng(item);
        if(!ll) return;

        const m = L.marker(ll);
        m.on("click", ()=>{
          // 요구: 핀 클릭시 해당 매체가 1번 위치(우상)으로 이동 + 빛나라
          // 여기서는 "검색결과 패널 상단(첫번째)"로 올리는 동작을 수행
          pushRecent(item);
          glowMarker(m);

          // 우측 리스트를 현재 클릭한 항목 단일로 보여주며 1번에 고정
          renderResults([item], {pinFocus:true});
        });

        m.on("mouseover", ()=>{
          // 몰려있는 핀 개별 발광은 markercluster 내부 상태/아이콘 관리에 따라 제한이 있으나
          // 개별 마커 엘리먼트가 있는 경우 glow를 적용
          glowMarker(m);
        });

        m.bindPopup(makePopup(item, m));
        cluster.addLayer(m);
        markers.push({ item, marker:m });
      });

      // Cluster count update
      function updateClusterCount(){
        const cnt = cluster.getVisibleParent ? cluster.getVisibleParent({}).length : cluster.getLayers().length;
        elClusterCount.textContent = String(cluster.getLayers().length || 0);
      }
      updateClusterCount();

      // Render results
      function renderResults(items, opts={}){
        const arr = Array.isArray(items) ? items : [];
        elResultsCount.textContent = String(arr.length);

        elResultsList.innerHTML = arr.map((x, idx)=>{
          return `
            <div class="item" data-idx="${idx}">
              <div class="name">${x.name || "-"}</div>
              <div class="sub">${x.address || x.addr || "-"}</div>
              <div class="price">${fmtPrice(x.price)}</div>
            </div>
          `;
        }).join("");

        qsa(".item", elResultsList).forEach(row=>{
          row.addEventListener("click", ()=>{
            const idx = Number(row.getAttribute("data-idx"));
            const item = arr[idx];
            if(!item) return;

            // 지도 이동 + 확대(기본 로직)
            const ll = toLatLng(item);
            if(ll){
              map.setView(ll, Math.max(map.getZoom(), 12), { animate:true });
            }
            pushRecent(item);
            openHashModal(item);
          });
        });

        // 1번 위치(우상)에 “고정”: 패널 자체는 항상 우상단이므로 별도 이동 불필요
        // 단, 스크롤 잔상 방지 위해 리스트 스크롤을 항상 최상단으로 리셋 (요청사항)
        elResultsList.scrollTop = 0;
      }

      // Search
      function normalize(s){ return (s||"").toString().trim().toLowerCase(); }

      function searchData(q){
        const nq = normalize(q);
        if(!nq) return [];
        return data.filter(x=>{
          const name = normalize(x.name);
          const addr = normalize(x.address || x.addr);
          const group = normalize(x.media_group || x.group);
          return name.includes(nq) || addr.includes(nq) || group.includes(nq);
        }).slice(0, 200);
      }

      function computeZoomForResults(items){
        // v1.1.26 개선요구: 검색 시 무조건 12 고정이 아니라,
        // 결과들의 분포를 보고 "적절한 줌"을 준다.
        const llList = items.map(toLatLng).filter(Boolean);
        if(llList.length===0) return {center:null, zoom:12};
        if(llList.length===1) return {center:llList[0], zoom:14};

        const lats = llList.map(v=>v[0]);
        const lngs = llList.map(v=>v[1]);
        const minLat=Math.min(...lats), maxLat=Math.max(...lats);
        const minLng=Math.min(...lngs), maxLng=Math.max(...lngs);
        const center=[(minLat+maxLat)/2, (minLng+maxLng)/2];

        // spread 기반 줌 추정(대략)
        const dLat = Math.abs(maxLat-minLat);
        const dLng = Math.abs(maxLng-minLng);
        const spread = Math.max(dLat,dLng);

        let zoom = 12;
        if(spread < 0.002) zoom = 16;
        else if(spread < 0.01) zoom = 15;
        else if(spread < 0.03) zoom = 14;
        else if(spread < 0.08) zoom = 13;
        else zoom = 12;

        return {center, zoom};
      }

      elSearch.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          const q = elSearch.value;
          const results = searchData(q);
          renderResults(results);

          // 지도 이동
          const {center, zoom} = computeZoomForResults(results);
          if(center){
            map.setView(center, zoom, { animate:true });
          }

          // 우측 패널 오픈 보장
          elResults.style.display = "flex";
        }
      });

      // Initial render
      renderRecent();
      loadCart();

      // On drag map: (요청) 지도 드래그 시 리스트 스크롤을 최상단으로 고정해 잔상 제거
      map.on("movestart", ()=>{
        elResultsList.scrollTop = 0;
      });

      console.log("Frontier DOOH", VERSION, "loaded. items:", data.length);
    })();
  </script>
</body>
</html>
