<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frontier 전국 DOOH DB – Web Map MVP</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0c0d;
      --panel:#101214;
      --panel2:#0f1011;
      --text:#cfd8e3;
      --muted:#8ea0b3;
      --line:rgba(255,255,255,.10);
      --mint:#a2decc;
      --mint2:rgba(162,222,204,.20);
      --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR",sans-serif;
    }
    a{color:inherit}
    .app{display:flex; height:100vh; width:100vw; overflow:hidden;}
    .left{
      width:420px; min-width:360px; max-width:520px;
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-right:1px solid var(--line);
      display:flex; flex-direction:column;
    }
    .top{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      position:sticky; top:0; background:linear-gradient(180deg,var(--panel),var(--panel2));
      z-index:5;
    }
    .title{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px;
    }
    .title h1{
      margin:0; font-size:14px; font-weight:800; letter-spacing:.2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 10px; border:1px solid var(--mint2);
      border-radius:999px;
      background:rgba(0,0,0,.35);
      box-shadow:0 0 16px rgba(162,222,204,.10);
      font-size:12px; color:var(--text);
      white-space:nowrap;
    }
    .pill b{color:var(--mint)}
    .meta{
      display:grid; grid-template-columns:1fr 1fr;
      gap:6px; font-size:12px; color:var(--muted);
      margin-top:8px;
    }
    .meta div{padding:6px 8px; border:1px solid var(--line); border-radius:10px; background:rgba(0,0,0,.18)}
    .meta b{color:var(--text)}
    .controls{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      margin-top:10px;
    }
    .controls .full{grid-column:1/-1;}
    input[type="text"], select{
      width:100%; padding:10px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(207,216,227,.55)}
    .checks{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:10px;
    }
    .chk{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      font-size:12px; color:var(--text);
      user-select:none;
    }
    .chk input{accent-color:var(--mint); cursor:pointer}
    .btns{display:flex; gap:10px; margin-top:10px;}
    .btn{
      flex:1;
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      font-weight:800; cursor:pointer;
    }
    .btn.primary{
      border-color:var(--mint2);
      box-shadow:0 0 18px rgba(162,222,204,.12);
    }
    .btn:active{transform:translateY(1px)}
    .listWrap{flex:1; overflow:auto;}
    .listHeader{
      padding:12px 14px 8px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      position:sticky; top:0; background:linear-gradient(180deg,var(--panel),var(--panel2));
      z-index:4;
    }
    .listHeader .small{font-size:12px; color:var(--muted)}
    .list{
      padding:10px 10px 18px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.18);
      padding:10px 10px;
      margin-bottom:10px;
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease;
    }
    .item:hover{
      transform:translateY(-1px);
      border-color:rgba(162,222,204,.30);
    }
    .item .t{
      font-weight:900; font-size:13px; line-height:1.25;
      margin-bottom:6px;
    }
    .item .s{
      font-size:12px; color:var(--muted); line-height:1.35;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size:11px;
      padding:4px 8px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      margin-right:6px;
    }
    .badge.mint{border-color:rgba(162,222,204,.30); color:var(--mint)}
    .right{flex:1; position:relative;}
    #map{height:100%; width:100%;}
    .toast{
      position:absolute; left:12px; bottom:12px;
      padding:10px 12px;
      background:rgba(0,0,0,.55);
      border:1px solid var(--line);
      border-radius:12px;
      font-size:12px; color:var(--muted);
      z-index:700;
      max-width:min(520px, 70%);
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center;
      z-index:2000;
      padding:16px;
    }
    .modal{
      width:min(860px, 96vw);
      background:linear-gradient(180deg, rgba(16,18,20,.98), rgba(10,11,12,.98));
      border:1px solid rgba(162,222,204,.20);
      box-shadow:0 0 40px rgba(0,0,0,.55);
      border-radius:16px;
      overflow:hidden;
    }
    .modalHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .modalHead h2{margin:0; font-size:16px; font-weight:950; line-height:1.25}
    .modalHead .sub{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .close{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font-weight:900;
    }
    .modalBody{padding:14px 16px;}
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    @media(max-width:760px){
      .left{width:360px}
      .grid{grid-template-columns:1fr}
    }
    .kv{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 10px;
      font-size:12px;
    }
    .kv .k{color:var(--muted); font-weight:800; margin-bottom:6px}
    .kv .v{color:var(--text); font-weight:800; line-height:1.35}
    .links{
      display:flex; flex-wrap:wrap; gap:10px;
      margin-top:12px;
    }
    .linkbtn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      text-decoration:none;
      font-size:12px; font-weight:950;
    }
    .linkbtn.primary{border-color:rgba(162,222,204,.30); color:var(--mint)}
    .warn{
      margin-top:12px;
      font-size:12px;
      color:rgba(255,255,255,.70);
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      border-radius:12px;
      padding:10px 10px;
    }
    .warn b{color:var(--mint)}
  </style>
</head>

<body>
<div class="app">
  <div class="left">
    <div class="top">
      <div class="title">
        <h1>Frontier 전국 DOOH DB – Web Map MVP</h1>
        <div class="pill" id="pill">
          <span>Loaded: <b id="pillLoaded">-</b></span>
          <span>Showing: <b id="pillShowing">-</b></span>
          <span>InView: <b id="pillInView">-</b></span>
        </div>
      </div>

      <div class="meta">
        <div>전체 로드 <b id="mLoaded">-</b></div>
        <div>현재 표시 <b id="mShown">-</b></div>
        <div>좌표 있음 <b id="mHasCoord">-</b></div>
        <div>좌표 없음 <b id="mNoCoord">-</b></div>
      </div>

      <div class="controls">
        <div class="full">
          <input id="q" type="text" placeholder="검색 (예: 지역/주소/명칭/키워드)" />
        </div>
        <div>
          <select id="selGroup">
            <option value="">media_group (전체)</option>
          </select>
        </div>
        <div>
          <select id="selSido">
            <option value="">sido (전체)</option>
          </select>
        </div>
      </div>

      <div class="checks">
        <label class="chk"><input type="checkbox" id="chkBounds" /> 지도 범위만 보기</label>
        <label class="chk"><input type="checkbox" id="chkKorea" checked /> 한국 밖 제외</label>
        <label class="chk"><input type="checkbox" id="chkReview" /> REVIEW만</label>
      </div>

      <div class="btns">
        <button class="btn primary" id="btnApply">적용</button>
        <button class="btn" id="btnReset">초기화</button>
      </div>
    </div>

    <div class="listWrap">
      <div class="listHeader">
        <div class="small">리스트 (클릭 → 상세모달 + 지도 이동)</div>
        <div class="small">표시: <b id="listCount">-</b></div>
      </div>
      <div class="list" id="list"></div>
    </div>
  </div>

  <div class="right">
    <div id="map"></div>
    <div class="toast" id="toast">데이터 로딩 중…</div>
  </div>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <div>
        <h2 id="mdTitle">-</h2>
        <div class="sub" id="mdSub">-</div>
      </div>
      <button class="close" id="mdClose">닫기</button>
    </div>
    <div class="modalBody">
      <div class="grid" id="mdGrid"></div>

      <div class="links">
        <a class="linkbtn primary" id="lnkKakao" href="#" target="_blank" rel="noopener noreferrer">카카오맵</a>
        <a class="linkbtn primary" id="lnkGoogle" href="#" target="_blank" rel="noopener noreferrer">구글맵</a>
      </div>

      <div class="warn">
        <b>안내</b> : 본 화면은 MVP로, 추후(검증/운영사 파일/네트워크 취합) 단계에서 광고주·담당자용 핵심지표(노출/유동/타겟/기간·가격/운영사·담당자 등)를 확장합니다.
      </div>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const DATA_URL = "./data_house_kor_single_fixed_merged.json";

  // "한국 밖 제외" 기준을 넉넉히 잡은 박스(대한민국 대략 범위)
  const KOREA_BOUNDS = L.latLngBounds(
    L.latLng(33.0, 124.0),
    L.latLng(39.8, 132.2)
  );

  // ====== STATE ======
  let rawItems = [];
  let normItems = [];
  let filteredItems = [];
  let markerByKey = new Map();

  // ====== MAP ======
  const map = L.map("map", { zoomControl:true }).setView([36.5, 127.9], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const clusters = L.markerClusterGroup({
    showCoverageOnHover: false,
    chunkedLoading: true,
    spiderfyOnMaxZoom: true
  });

  map.addLayer(clusters);

  // ====== UI ======
  const elToast = document.getElementById("toast");

  const pillLoaded = document.getElementById("pillLoaded");
  const pillShowing = document.getElementById("pillShowing");
  const pillInView = document.getElementById("pillInView");

  const mLoaded = document.getElementById("mLoaded");
  const mShown = document.getElementById("mShown");
  const mHasCoord = document.getElementById("mHasCoord");
  const mNoCoord = document.getElementById("mNoCoord");

  const q = document.getElementById("q");
  const selGroup = document.getElementById("selGroup");
  const selSido = document.getElementById("selSido");
  const chkBounds = document.getElementById("chkBounds");
  const chkKorea = document.getElementById("chkKorea");
  const chkReview = document.getElementById("chkReview");

  const btnApply = document.getElementById("btnApply");
  const btnReset = document.getElementById("btnReset");

  const list = document.getElementById("list");
  const listCount = document.getElementById("listCount");

  // Modal
  const modalBack = document.getElementById("modalBack");
  const mdClose = document.getElementById("mdClose");
  const mdTitle = document.getElementById("mdTitle");
  const mdSub = document.getElementById("mdSub");
  const mdGrid = document.getElementById("mdGrid");
  const lnkKakao = document.getElementById("lnkKakao");
  const lnkGoogle = document.getElementById("lnkGoogle");

  function toast(msg){
    elToast.textContent = msg;
  }

  // ====== NORMALIZE ======
  function pick(obj, keys){
    for(const k of keys){
      if(obj && obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== ""){
        return obj[k];
      }
    }
    return "";
  }

  function toNumber(v){
    if(v === null || v === undefined) return NaN;
    const n = Number(v);
    return Number.isFinite(n) ? n : NaN;
  }

  function getLatLng(item){
    const lat = toNumber(pick(item, ["lat","latitude","Lat","LAT"]));
    const lng = toNumber(pick(item, ["lng","lon","longitude","Lng","LNG"]));
    if(!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
    return L.latLng(lat, lng);
  }

  function normItem(item){
    const id = String(pick(item, ["id","ID","_id","key"]) || "").trim();
    const title = String(pick(item, ["title","name","media_name","display_name"]) || "").trim();
    const subtitle = String(pick(item, ["subtitle","subTitle","operator","network","brand"]) || "").trim();
    const address = String(pick(item, ["address","addr","road_address","location"]) || "").trim();
    const media_group = String(pick(item, ["media_group","group","mediaGroup"]) || "").trim();
    const sido = String(pick(item, ["sido","province","region"]) || "").trim();
    const status = String(pick(item, ["status","state"]) || "").trim();
    const verified_status = String(pick(item, ["verified_status","verified","verify"]) || "").trim();

    const ll = getLatLng(item);

    // 내부식별 키(안정적)
    const key = id || (title + "|" + address + "|" + (ll ? (ll.lat+","+ll.lng) : "noLL"));

    // NOTE: source_url / 외부 출처 관련 필드는 "화면 노출" 절대 금지 → 모달에서 제외함
    return {
      _raw: item,
      key,
      id,
      title: title || "(제목 없음)",
      subtitle,
      address,
      media_group,
      sido,
      status,
      verified_status,
      latlng: ll
    };
  }

  // ====== FILTERS ======
  function textMatch(n, query){
    if(!query) return true;
    const ql = query.toLowerCase();
    const base = [
      n.id, n.title, n.subtitle, n.address, n.media_group, n.sido,
      n.status, n.verified_status
    ].join(" ").toLowerCase();
    return base.includes(ql);
  }

  function isReview(n){
    const s = (n.status || "").toUpperCase();
    const v = (n.verified_status || "").toUpperCase();
    return s.includes("REVIEW") || v.includes("REVIEW");
  }

  function rebuildDropdowns(){
    // media_group / sido 옵션 채우기
    const groups = new Set();
    const sidos = new Set();
    for(const n of normItems){
      if(n.media_group) groups.add(n.media_group);
      if(n.sido) sidos.add(n.sido);
    }
    const gArr = Array.from(groups).sort((a,b)=>a.localeCompare(b,"ko"));
    const sArr = Array.from(sidos).sort((a,b)=>a.localeCompare(b,"ko"));

    // 기존 선택값 유지
    const gSel = selGroup.value;
    const sSel = selSido.value;

    selGroup.innerHTML = `<option value="">media_group (전체)</option>` + gArr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    selSido.innerHTML = `<option value="">sido (전체)</option>` + sArr.map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");

    selGroup.value = gSel;
    selSido.value = sSel;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function applyFilters(reason = "user"){
    const query = q.value.trim();
    const g = selGroup.value.trim();
    const s = selSido.value.trim();

    // 1) 텍스트/드롭다운/리뷰
    let arr = normItems.filter(n=>{
      if(!textMatch(n, query)) return false;
      if(g && n.media_group !== g) return false;
      if(s && n.sido !== s) return false;
      if(chkReview.checked && !isReview(n)) return false;
      // 한국 밖 제외(좌표 있는 것만 판정)
      if(chkKorea.checked && n.latlng && !KOREA_BOUNDS.contains(n.latlng)) return false;
      return true;
    });

    // 2) 지도 범위 필터 (checkbox ON이면, 현 지도 bounds 안만 남김)
    const bounds = map.getBounds();
    let inViewArr = arr;
    if(chkBounds.checked){
      inViewArr = arr.filter(n => n.latlng && bounds.contains(n.latlng));
    }

    filteredItems = arr;

    // 지도에 그릴 건 "지도범위 ON이면 inViewArr, OFF면 arr" 기준
    const toRender = chkBounds.checked ? inViewArr : arr;

    renderAll(toRender);

    // ★ 핵심 수정: "사용자 의도 검색/적용"이면 결과 영역으로 지도 이동
    // 이유: 지도범위 ON 상태에서도 '대구 검색 → 지도 이동'이 되어야 함
    if(reason === "user"){
      autoFitToResults(arr);
    }

    updateNumbers(arr, inViewArr);
  }

  function autoFitToResults(arr){
    // 좌표 있는 결과만 대상으로 fit
    const pts = arr.filter(n=>n.latlng).map(n=>n.latlng);
    if(pts.length === 0) return;

    // 단일 포인트면 적당한 줌으로 setView
    if(pts.length === 1){
      map.setView(pts[0], Math.max(map.getZoom(), 12), { animate:true });
      return;
    }

    const b = L.latLngBounds(pts);
    map.fitBounds(b, { padding:[28,28], animate:true, maxZoom: 15 });
  }

  // ====== RENDER ======
  function clearMarkers(){
    clusters.clearLayers();
    markerByKey.clear();
  }

  function makePopup(n){
    const t = escapeHtml(n.title);
    const a = escapeHtml(n.address || "");
    const g = escapeHtml(n.media_group || "");
    const s = escapeHtml(n.sido || "");
    return `<div style="font-weight:900;margin-bottom:6px">${t}</div>
            <div style="font-size:12px;color:#8ea0b3;line-height:1.35">${g ? ("<b style='color:#a2decc'>"+g+"</b> · ") : ""}${s}${a ? ("<br/>"+a) : ""}</div>`;
  }

  function renderMarkers(items){
    clearMarkers();
    for(const n of items){
      if(!n.latlng) continue;

      const m = L.marker(n.latlng);
      m.bindPopup(makePopup(n));
      m.on("click", ()=> openModal(n));
      clusters.addLayer(m);

      markerByKey.set(n.key, m);
    }
  }

  function renderList(items){
    list.innerHTML = "";
    listCount.textContent = String(items.length);

    // 너무 길면 체감 느려질 수 있어 상위 800개만 렌더 (MVP 안전장치)
    const MAX = 800;
    const slice = items.slice(0, MAX);

    for(const n of slice){
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="t">${escapeHtml(n.title)}</div>
        <div class="s">
          ${n.media_group ? `<span class="badge mint">${escapeHtml(n.media_group)}</span>` : ""}
          ${n.sido ? `<span class="badge">${escapeHtml(n.sido)}</span>` : ""}
          ${n.address ? `<div style="margin-top:6px">${escapeHtml(n.address)}</div>` : ""}
        </div>
      `;
      div.addEventListener("click", ()=>{
        openModal(n);
        if(n.latlng){
          map.setView(n.latlng, Math.max(map.getZoom(), 14), { animate:true });
          const mk = markerByKey.get(n.key);
          if(mk){ setTimeout(()=> mk.openPopup(), 150); }
        }
      });
      list.appendChild(div);
    }

    if(items.length > MAX){
      const more = document.createElement("div");
      more.className = "warn";
      more.textContent = `리스트 렌더는 상위 ${MAX}개만 표시 중 (현재 표시 ${items.length}개).`;
      list.prepend(more);
    }
  }

  function renderAll(items){
    renderMarkers(items);
    renderList(items);
    toast(`Loaded ${normItems.length} · Showing ${filteredItems.length} · Map ${items.length}`);
    setTimeout(()=>{ elToast.style.opacity = "0.05"; }, 1200);
    setTimeout(()=>{ elToast.style.opacity = "1"; }, 1600);
  }

  function updateNumbers(arr, inViewArr){
    const loaded = normItems.length;
    const shown = arr.length;

    const hasCoord = normItems.filter(n=>n.latlng).length;
    const noCoord = loaded - hasCoord;

    const inView = (chkBounds.checked ? inViewArr.length : shown);

    // meta
    mLoaded.textContent = String(loaded);
    mShown.textContent = String(shown);
    mHasCoord.textContent = String(hasCoord);
    mNoCoord.textContent = String(noCoord);

    // pill
    pillLoaded.textContent = String(loaded);
    pillShowing.textContent = String(shown);
    pillInView.textContent = String(inView);
  }

  // ====== MODAL (출처 URL 절대 노출 금지) ======
  function openModal(n){
    mdTitle.textContent = n.title || "-";
    mdSub.textContent = [n.media_group, n.sido].filter(Boolean).join(" · ") || "-";

    // 광고주/담당자 관점에서 "보이는 정보"를 최대한 늘리되, "없는 값은 표시하지 않음"
    // + 외부 출처(source_url 등)는 절대 표시하지 않음
    mdGrid.innerHTML = "";

    const rows = [];

    // 기본
    if(n.id) rows.push(["ID", n.id]);
    if(n.address) rows.push(["주소", n.address]);
    if(n.status) rows.push(["Status", n.status]);
    if(n.verified_status) rows.push(["Verified", n.verified_status]);
    if(n.latlng) rows.push(["좌표", `${n.latlng.lat.toFixed(6)}, ${n.latlng.lng.toFixed(6)}`]);

    // 원본에서 "있을 수도 있는" 실무 정보(있을 때만 노출)
    const raw = n._raw || {};
    const allowKeys = [
      ["운영사", ["operator","operator_name","company","owner"]],
      ["매체유형", ["media_type","type","format"]],
      ["상품구분", ["salesType","sales_type"]],
      ["스크린정보", ["screen","screen_size","resolution","ratio"]],
      ["수량/면수", ["faces","face_count","count","qty"]],
      ["설치위치", ["site","venue","place"]],
      ["비고", ["note","memo","remark"]]
    ];

    for(const [label, keys] of allowKeys){
      const val = pick(raw, keys);
      if(val) rows.push([label, String(val)]);
    }

    // rows -> cards
    for(const [k,v] of rows){
      const box = document.createElement("div");
      box.className = "kv";
      box.innerHTML = `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div>`;
      mdGrid.appendChild(box);
    }

    // 지도 링크 (주소가 있으면 주소로, 없으면 좌표로)
    const addrQ = n.address ? n.address : (n.latlng ? `${n.latlng.lat},${n.latlng.lng}` : n.title);
    const kakao = `https://map.kakao.com/?q=${encodeURIComponent(addrQ)}`;
    const google = n.latlng
      ? `https://www.google.com/maps?q=${encodeURIComponent(n.latlng.lat + "," + n.latlng.lng)}`
      : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addrQ)}`;

    lnkKakao.href = kakao;
    lnkGoogle.href = google;

    modalBack.style.display = "flex";
  }

  function closeModal(){
    modalBack.style.display = "none";
  }

  mdClose.addEventListener("click", closeModal);
  modalBack.addEventListener("click", (e)=>{
    if(e.target === modalBack) closeModal();
  });
  window.addEventListener("keydown",(e)=>{
    if(e.key === "Escape") closeModal();
  });

  // ====== EVENTS ======
  btnApply.addEventListener("click", ()=> applyFilters("user"));

  btnReset.addEventListener("click", ()=>{
    q.value = "";
    selGroup.value = "";
    selSido.value = "";
    chkReview.checked = false;
    chkBounds.checked = false;
    chkKorea.checked = true;
    applyFilters("user");
  });

  // 입력 후 Enter = 적용
  q.addEventListener("keydown",(e)=>{
    if(e.key === "Enter"){
      applyFilters("user");
    }
  });

  // 체크 변경 즉시 반영 (bounds는 user 의도로 취급해도 무방)
  chkBounds.addEventListener("change", ()=> applyFilters("user"));
  chkKorea.addEventListener("change", ()=> applyFilters("user"));
  chkReview.addEventListener("change", ()=> applyFilters("user"));

  // 지도 이동/줌 시: 지도범위 필터 ON이면 inView 수치/렌더가 즉시 따라가야 함
  map.on("moveend zoomend", ()=>{
    if(chkBounds.checked){
      applyFilters("bounds"); // reason bounds: autoFit 금지
    }else{
      // bounds off여도 pill의 InView는 Showing과 같게 유지됨
      applyFilters("bounds");
    }
  });

  // ====== LOAD ======
  async function load(){
    toast("데이터 로딩 중…");
    try{
      const res = await fetch(DATA_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      rawItems = Array.isArray(data) ? data : (data.items || data.data || []);
      normItems = rawItems.map(normItem);

      rebuildDropdowns();

      // 최초 1회 렌더
      applyFilters("user");

      toast(`로드 완료: ${normItems.length}`);
    }catch(err){
      console.error(err);
      toast("데이터 로딩 실패: " + String(err));
      elToast.style.borderColor = "rgba(255,107,107,.35)";
      elToast.style.color = "rgba(255,255,255,.85)";
    }
  }

  load();
</script>
</body>
</html>
