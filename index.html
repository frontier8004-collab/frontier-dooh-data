<script>
  // ========================
  // Config
  // ========================
  const DATA_URL = "./data_v13_med_high.json";
  const DEFAULT_CENTER = [36.5, 127.9];
  const DEFAULT_ZOOM = 7;

  // 타일: CARTO(기본, 안정적) / OSM(대체)
  const TILE_PRIMARY = "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png";
  const TILE_FALLBACK = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";

  // "한국 좌표"로 인정할 대략 범위 (MVP용)
  const KOREA_BBOX = {
    minLat: 32.0,
    maxLat: 40.5,
    minLng: 123.0,
    maxLng: 132.8
  };

  // ========================
  // Utils
  // ========================
  const $ = (id) => document.getElementById(id);
  const safe = (v) => (v===null||v===undefined) ? "" : String(v).trim();
  const toNum = (v) => {
    const n = Number(String(v ?? "").replace(/,/g,"").trim());
    return Number.isFinite(n) ? n : null;
  };
  const uniq = (arr) =>
    Array.from(new Set(arr.map(safe).filter(Boolean)))
      .sort((a,b)=> String(a).localeCompare(String(b), "ko"));

  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function escapeAttr(str){ return String(str ?? "").replace(/"/g,"&quot;"); }

  function inKorea(lat, lng){
    return (
      lat >= KOREA_BBOX.minLat && lat <= KOREA_BBOX.maxLat &&
      lng >= KOREA_BBOX.minLng && lng <= KOREA_BBOX.maxLng
    );
  }

  // 핵심: 좌표 정규화 (뒤집힘/비정상 자동 교정)
  function normalizeLatLng(latRaw, lngRaw){
    let lat = toNum(latRaw);
    let lng = toNum(lngRaw);
    if(lat===null || lng===null) return null;

    // 1) 범위상 불가능하면(위도 90 초과 / 경도 180 초과) 스왑 시도
    if(Math.abs(lat) > 90 || Math.abs(lng) > 180){
      const a = lng, b = lat;
      if(Math.abs(a) <= 90 && Math.abs(b) <= 180){
        lat = a; lng = b;
      }else{
        return null;
      }
    }

    // 2) "한국 범위"가 아니면 스왑했을 때 한국 범위면 스왑
    if(!inKorea(lat, lng) && inKorea(lng, lat)){
      const t = lat; lat = lng; lng = t;
    }

    return { lat, lng, isKorea: inKorea(lat, lng) };
  }

  const badgeClass = (k, v) => {
    const val = safe(v).toUpperCase();
    if(k === "confidence_tier"){
      if(val==="HIGH") return "good";
      if(val==="MED") return "warn";
      if(val==="LOW") return "bad";
    }
    if(k === "verified_status"){
      if(val==="VERIFIED") return "good";
      if(val.includes("LOWCONF")) return "warn";
    }
    return "mint";
  };
  const makeBadge = (k, v) => {
    const cls = badgeClass(k, v);
    const c = cls==="good" ? "badge good" : cls==="warn" ? "badge warn" : cls==="bad" ? "badge bad" : "badge mint";
    return `<span class="${c}">${escapeHtml(safe(v)||"-")}</span>`;
  };

  // ========================
  // Elements
  // ========================
  const elPill = $("pillState");
  const elTotal = $("statTotal");
  const elShown = $("statShown");
  const elCount = $("listCount");
  const elList = $("list");
  const elMetaLine = $("metaLine");
  const elToast = $("toast");

  const elQ = $("q");
  const elFGroup = $("fGroup");
  const elFSido  = $("fSido");
  const elFTier  = $("fTier");
  const elFVer   = $("fVer");
  const elReset  = $("btnReset");
  const elFit    = $("btnFit");

  const elModal  = $("modal");
  const elMTitle = $("mTitle");
  const elMSub   = $("mSub");
  const elMBadges= $("mBadges");
  const elMGrid  = $("mGrid");
  const elMRaw   = $("mRaw");
  const elMClose = $("mClose");
  const elMCenter= $("mCenter");
  const elMCopy  = $("mCopy");

  function setPill(t){ elPill.textContent = t; }
  function setToast(html){ elToast.innerHTML = html; }

  // ========================
  // Map
  // ========================
  const map = L.map("map", { center: DEFAULT_CENTER, zoom: DEFAULT_ZOOM, zoomControl:true });

  let baseLayer = L.tileLayer(TILE_PRIMARY, {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors &copy; CARTO"
  }).addTo(map);

  // 타일 에러가 계속 나면 OSM으로 스위치
  let tileErr = 0;
  baseLayer.on("tileerror", () => {
    tileErr++;
    if(tileErr >= 10 && baseLayer && baseLayer._url !== TILE_FALLBACK){
      try{ map.removeLayer(baseLayer); }catch(e){}
      baseLayer = L.tileLayer(TILE_FALLBACK, { maxZoom:19, attribution:"&copy; OpenStreetMap contributors" }).addTo(map);
      setToast(`<b>주의</b>: 타일 오류가 반복되어 OSM으로 전환했습니다.`);
    }
  });

  // 클러스터
  const markers = L.markerClusterGroup({
    showCoverageOnHover:false,
    chunkedLoading:true,
    spiderfyOnMaxZoom:true
  });
  map.addLayer(markers);

  // ========================
  // Resize / Zoom 안정화 (과하지 않게)
  // ========================
  let refreshTimer = null;
  function scheduleRefresh(delay=120){
    clearTimeout(refreshTimer);
    refreshTimer = setTimeout(() => {
      try{ map.invalidateSize(true); }catch(e){}
      try{ baseLayer && baseLayer.redraw(); }catch(e){}
    }, delay);
  }

  // 창/iframe 크기 변화 대응
  window.addEventListener("resize", () => scheduleRefresh(200));
  window.addEventListener("orientationchange", () => scheduleRefresh(200));
  document.addEventListener("visibilitychange", () => { if(!document.hidden) scheduleRefresh(250); });
  window.addEventListener("focus", () => scheduleRefresh(250));

  if("ResizeObserver" in window){
    const ro = new ResizeObserver(() => scheduleRefresh(120));
    ro.observe(document.getElementById("map"));
    const wrap = document.querySelector(".mapWrap");
    if(wrap) ro.observe(wrap);
  }

  // 휠 줌/이동 후 타일이 검게 남는 경우 방지
  map.on("zoomend", () => scheduleRefresh(80));
  map.on("moveend", () => scheduleRefresh(80));

  // ========================
  // Data + UI
  // ========================
  let items = [];
  let filtered = [];
  let fuse = null;
  let markerById = new Map();
  let selectedId = null;

  function fillSelect(el, values){
    el.innerHTML = `<option value="">전체</option>`;
    values.forEach(v => {
      const opt = document.createElement("option");
      opt.value=v; opt.textContent=v;
      el.appendChild(opt);
    });
  }

  function getFilters(){
    return {
      q: safe(elQ.value).toLowerCase(),
      group: safe(elFGroup.value),
      sido: safe(elFSido.value),
      tier: safe(elFTier.value),
      ver: safe(elFVer.value),
    };
  }

  function applyAll(){
    const f = getFilters();

    let out = items.filter(it => {
      if(f.group && it.media_group !== f.group) return false;
      if(f.sido  && it.sido !== f.sido) return false;
      if(f.tier  && it.confidence_tier !== f.tier) return false;
      if(f.ver   && it.verified_status !== f.ver) return false;
      return true;
    });

    if(f.q){
      const results = fuse.search(f.q).map(r=>r.item);
      const idset = new Set(out.map(x=>x.id));
      out = results.filter(x=>idset.has(x.id));
    }

    filtered = out;
    elShown.textContent = String(filtered.length);
    elCount.textContent = String(filtered.length);

    renderMarkers(filtered);
    renderList(filtered);
  }

  function fitToFiltered(){
    const arr = filtered.length ? filtered : items;
    if(!arr.length) return;

    // 핵심: "한국 좌표만"으로 화면 맞춤(튀는 해외좌표가 있어도 화면이 망가지지 않게)
    const koreaArr = arr.filter(x => x._isKorea);
    const target = koreaArr.length ? koreaArr : arr;

    const bounds = L.latLngBounds(target.map(d => [d.lat, d.lng]));
    map.fitBounds(bounds.pad(0.15));
    scheduleRefresh(120);
  }

  function renderMarkers(data){
    markers.clearLayers();
    markerById.clear();

    data.forEach(it => {
      const tier = safe(it.confidence_tier).toUpperCase();
      const cls = (tier==="HIGH") ? "good" : (tier==="MED") ? "warn" : (tier==="LOW") ? "bad" : "mint";
      const color =
        cls==="good" ? "rgba(76,212,164,.95)" :
        cls==="warn" ? "rgba(255,209,102,.95)" :
        cls==="bad"  ? "rgba(255,107,107,.95)" :
        "rgba(162,222,204,.95)";

      const icon = L.divIcon({
        className: "",
        html: `<div style="width:14px;height:14px;border-radius:999px;border:2px solid rgba(255,255,255,.75);
              background:${color}; box-shadow:0 0 0 3px rgba(0,0,0,.35), 0 0 18px rgba(162,222,204,.18);"></div>`,
        iconSize:[14,14],
        iconAnchor:[7,7]
      });

      const m = L.marker([it.lat, it.lng], {icon});
      m.on("click", ()=> openDetail(it.id));
      m.bindTooltip(
        `<div style="font-weight:900;font-size:12px;margin-bottom:4px">${escapeHtml(it.title||"")}</div>
         <div style="font-size:11px;color:#9fb0c8">${escapeHtml(it.subtitle||"")}</div>`,
        {direction:"top", opacity:0.96, sticky:true}
      );

      markers.addLayer(m);
      markerById.set(it.id, m);
    });

    scheduleRefresh(80);
  }

  function renderList(data){
    elList.innerHTML="";
    if(!data.length){
      elList.innerHTML = `<div style="padding:14px 12px;color:var(--muted);font-size:13px;line-height:1.4">결과가 없습니다. 검색/필터를 조정하세요.</div>`;
      return;
    }

    // 한국좌표 우선 정렬 + tier 정렬
    const tierRank = (t) => (String(t).toUpperCase()==="HIGH") ? 0 : (String(t).toUpperCase()==="MED") ? 1 : 2;
    const sorted = [...data].sort((a,b)=>{
      const ka = a._isKorea ? 0 : 1;
      const kb = b._isKorea ? 0 : 1;
      if(ka!==kb) return ka-kb;

      const tr = tierRank(a.confidence_tier) - tierRank(b.confidence_tier);
      if(tr!==0) return tr;

      const as = (a.confidence_score ?? -1), bs = (b.confidence_score ?? -1);
      if(bs!==as) return bs-as;

      return String(a.title).localeCompare(String(b.title), "ko");
    });

    sorted.forEach(it => {
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div class="h">
          <div>${escapeHtml(it.title||"(Untitled)")}</div>
          <div style="font-size:11px;color:var(--muted);font-weight:900;white-space:nowrap">${escapeHtml(it.id||"")}</div>
        </div>
        <div class="m">${escapeHtml([it.media_group, it.sido].filter(Boolean).join(" · "))}</div>
        <div class="m" style="margin-top:6px">${escapeHtml(it.address||"")}</div>
        <div class="badges">
          ${makeBadge("confidence_tier", it.confidence_tier)}
          ${it.verified_status ? makeBadge("verified_status", it.verified_status) : ""}
          ${(it._isKorea ? `<span class="badge good">KOREA</span>` : `<span class="badge warn">OUTLIER</span>`)}
        </div>
      `;
      div.addEventListener("click", ()=>{ flyTo(it.id); openDetail(it.id); });
      elList.appendChild(div);
    });
  }

  function flyTo(id){
    const it = items.find(x=>x.id===id);
    if(!it) return;

    selectedId = id;
    const ll = L.latLng(it.lat, it.lng);
    const m = markerById.get(id);

    if(m){
      markers.zoomToShowLayer(m, ()=> {
        map.setView(ll, Math.max(map.getZoom(), 15), {animate:true});
        try{ m.openTooltip(); }catch(_){}
        scheduleRefresh(120);
      });
    } else {
      map.setView(ll, 15, {animate:true});
      scheduleRefresh(120);
    }
  }

  function openDetail(id){
    const it = items.find(x=>x.id===id);
    if(!it) return;
    selectedId = id;

    elMTitle.textContent = it.title || "(Untitled)";
    elMSub.textContent = [it.sido, it.media_group, it.address].filter(Boolean).join(" · ");

    elMBadges.innerHTML = "";
    ["confidence_tier","confidence_score","verified_status","status","entity_type"].forEach(k=>{
      if(safe(it[k])!=="") elMBadges.insertAdjacentHTML("beforeend", makeBadge(k, it[k]));
    });
    elMBadges.insertAdjacentHTML("beforeend", it._isKorea ? `<span class="badge good">KOREA</span>` : `<span class="badge warn">OUTLIER</span>`);

    const kvs = [
      ["id", it.id],
      ["national_id", it.national_id],
      ["media_group", it.media_group],
      ["sido", it.sido],
      ["address", it.address],
      ["lat", it.lat],
      ["lng", it.lng],
      ["confidence_tier", it.confidence_tier],
      ["confidence_score", it.confidence_score],
      ["verified_status", it.verified_status],
      ["status", it.status],
      ["source_url", it.source_url],
    ].filter(([k,v])=> safe(v)!=="");

    elMGrid.innerHTML = "";
    kvs.forEach(([k,v])=>{
      const isUrl = safe(v).startsWith("http://") || safe(v).startsWith("https://");
      const vv = isUrl ? `<a href="${escapeAttr(v)}" target="_blank" rel="noopener noreferrer">${escapeHtml(v)}</a>` : escapeHtml(v);
      elMGrid.insertAdjacentHTML("beforeend", `<div class="kv"><div class="k">${escapeHtml(k)}</div><div class="v">${vv}</div></div>`);
    });

    elMRaw.textContent = JSON.stringify(it, null, 2);
    elModal.classList.add("open");
  }

  function closeModal(){ elModal.classList.remove("open"); }

  elModal.addEventListener("click", (e)=>{ if(e.target===elModal) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });
  elMClose.addEventListener("click", closeModal);
  elMCenter.addEventListener("click", ()=>{ if(selectedId) flyTo(selectedId); });
  elMCopy.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(elMRaw.textContent || "");
      elMCopy.textContent="복사됨";
      setTimeout(()=> elMCopy.textContent="JSON 복사", 900);
    }catch(e){
      alert("클립보드 복사 실패 (브라우저 권한 확인)");
    }
  });

  ["input","change"].forEach(evt => {
    elQ.addEventListener(evt, applyAll);
    elFGroup.addEventListener(evt, applyAll);
    elFSido.addEventListener(evt, applyAll);
    elFTier.addEventListener(evt, applyAll);
    elFVer.addEventListener(evt, applyAll);
  });
  elReset.addEventListener("click", ()=> {
    elQ.value=""; elFGroup.value=""; elFSido.value=""; elFTier.value=""; elFVer.value="";
    selectedId = null;
    applyAll();
    fitToFiltered();
  });
  elFit.addEventListener("click", ()=> fitToFiltered());

  async function loadData(){
    try{
      setPill("LOADING…");
      elMetaLine.textContent = DATA_URL;

      const res = await fetch(DATA_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      const arr = Array.isArray(data?.items) ? data.items : [];

      // 좌표 정규화 적용
      items = arr
        .map(x => {
          const norm = normalizeLatLng(x.lat, x.lng);
          if(!norm) return null;
          return {
            ...x,
            lat: norm.lat,
            lng: norm.lng,
            confidence_score: toNum(x.confidence_score),
            _isKorea: norm.isKorea
          };
        })
        .filter(Boolean);

      // 통계
      const koreaCount = items.filter(x=>x._isKorea).length;
      const outCount = items.length - koreaCount;

      elTotal.textContent = String(items.length);

      fillSelect(elFGroup, uniq(items.map(x=>x.media_group)));
      fillSelect(elFSido,  uniq(items.map(x=>x.sido)));
      fillSelect(elFTier,  uniq(items.map(x=>x.confidence_tier)));
      fillSelect(elFVer,   uniq(items.map(x=>x.verified_status)));

      fuse = new Fuse(items, {
        includeScore:true,
        threshold:0.35,
        ignoreLocation:true,
        keys:[
          {name:"title", weight:0.50},
          {name:"subtitle", weight:0.20},
          {name:"media_group", weight:0.15},
          {name:"sido", weight:0.10},
          {name:"address", weight:0.05}
        ]
      });

      setPill("READY");
      setToast(`<b>준비 완료</b>: 총 <b>${items.length}</b>건 • 한국좌표 <b>${koreaCount}</b> • 튀는좌표 <b>${outCount}</b><br/>
                <span style="color:rgba(159,176,200,.9)">튀는좌표는 표시되지만 “화면맞춤”에서는 제외됩니다.</span>`);

      filtered = [...items];
      applyAll();
      fitToFiltered();
      scheduleRefresh(180);

    }catch(err){
      console.error(err);
      setPill("ERROR");
      setToast(`<b>로딩 실패</b>: JSON 경로/형식을 확인하세요. (DATA_URL=${escapeHtml(DATA_URL)})`);
    }
  }

  // 최초 보정
  scheduleRefresh(200);
  scheduleRefresh(900);

  loadData();
</script>
