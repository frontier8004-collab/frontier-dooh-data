<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Frontier DOOH 전국 DB v1.1.27</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#0b0c0d;
      --panel:#0f1011;
      --text:#d8dde6;
      --muted:#9aa6b2;
      --line:rgba(255,255,255,.08);
      --mint:#a2decc;

      --shadow:0 12px 30px rgba(0,0,0,.45);
      --radius:16px;

      --inputBg:#0c0e10;
      --inputLine:rgba(255,255,255,.14);
      --inputText:#ffffff;
      --inputPh:rgba(255,255,255,.45);

      --topbarH:72px;
      --sideW: 161px; /* v1.1.25 유지 */
    }

    *{box-sizing:border-box}
    html, body{height:100%; overflow:hidden;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",sans-serif;
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .leaflet-container{cursor:grab;}
    .leaflet-dragging .leaflet-container{cursor:grabbing;}

    .leaflet-marker-icon, .leaflet-marker-icon *{
      user-select:none;
      -webkit-user-select:none;
      -webkit-user-drag:none;
      -webkit-tap-highlight-color: transparent;
    }
    .leaflet-marker-icon svg{ pointer-events:none; }

    /* ===== TOPBAR ===== */
    .topbar{
      flex:0 0 auto;
      position:sticky; top:0; z-index:6000;
      background:#0c0d0e;
      border-bottom:1px solid var(--line);
      padding:18px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .titleLeft{
      font-size:26px;
      font-weight:1000;
      letter-spacing:.2px;
      color:#e9eef7;
      line-height:1.08;
      text-align:left;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
    }
    .titleLeft:hover{ opacity:.92; }
    .titleLeft .ver{
      font-size:12px;
      font-weight:900;
      color:rgba(255,255,255,.55);
      margin-left:10px;
      letter-spacing:.4px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 8px 18px rgba(0,0,0,.25);
      font-size:12px;
      color:#e9eef7;
      flex:0 0 auto;
    }
    .pill b{color:var(--mint); font-weight:1000}

    /* Load error banner */
    .errBanner{
      position:sticky;
      top:calc(var(--topbarH) + 0px);
      z-index:5600;
      background:rgba(120, 20, 20, .22);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 16px;
      display:none;
    }
    .errBox{
      max-width:1200px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin:0 auto;
      color:#ffdfdf;
      font-size:12px;
      line-height:1.45;
    }
    .errBox b{ color:#ffd1d1; font-weight:1000; }
    .errBox code{
      color:#ffdede;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 6px;
      border-radius:8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:11px;
      white-space:nowrap;
    }
    .errClose{
      flex:0 0 auto;
      height:34px;
      padding:0 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.18);
      color:#fff;
      cursor:pointer;
      font-weight:900;
    }

    /* ===== FILTER BAR ===== */
    .filtersRow{
      flex:0 0 auto;
      position:sticky;
      top:var(--topbarH);
      z-index:5500;
      background:#0c0d0e;
      border-bottom:1px solid var(--line);
      padding:12px 16px;
    }
    .filtersInner{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-start;
      max-width:1200px;
    }

    input[type="text"], select{
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--inputLine);
      background:var(--inputBg);
      color:var(--inputText);
      outline:none;
      font-size:14px;
    }
    input[type="text"]::placeholder{color:var(--inputPh)}
    option{background:#0c0e10; color:#ffffff;}

    .qWrap{ position:relative; display:flex; align-items:center; gap:10px; }
    .q{ width:min(560px, 92vw); padding-right:44px; } /* v1.1.27: 내부 돋보기 공간 */
    .cat{ width:260px; }

    .btn{
      height:44px;
      border-radius:12px;
      border:1px solid rgba(162,222,204,.60);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      padding:0 26px;
      min-width:124px;
      white-space:nowrap;
      font-size:14px;
    }

    #q{ color:#fff !important; caret-color:#fff !important; }
    #q::placeholder{ color:#fff !important; }
    #q:-webkit-autofill{
      -webkit-text-fill-color:#fff !important;
      caret-color:#fff !important;
      box-shadow:0 0 0 1000px var(--inputBg) inset !important;
      border:1px solid var(--inputLine) !important;
    }

    /* v1.1.27: 검색 버튼 삭제 -> 입력창 내부 돋보기 */
    .qIconBtn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:28px;
      height:28px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .qIconBtn:active{ transform:translateY(-50%) translateY(1px); }
    .qIconBtn svg{ width:14px; height:14px; opacity:.95; }

    /* 검색어 제안 박스 */
    #qSuggest{
      position:absolute;
      top:48px;
      left:0;
      width:100%;
      display:none;
      max-height:260px;
      overflow:auto;
      background:rgba(12,14,16,.98);
      border:1px solid rgba(162,222,204,.38);
      border-radius:12px;
      box-shadow:0 18px 44px rgba(0,0,0,.55);
      z-index:9000;
      padding:6px;
    }
    .qSugItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      border-radius:10px;
      cursor:pointer;
      border:1px solid transparent;
      color:#e9eef7;
      font-size:13px;
      line-height:1.2;
    }
    .qSugItem small{
      color:var(--muted);
      font-size:11px;
      white-space:nowrap;
    }
    .qSugItem:hover,
    .qSugItem.isActive{
      background:rgba(162,222,204,.10);
      border-color:rgba(162,222,204,.25);
    }

    /* ===== APP LAYOUT ===== */
    .app{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns: minmax(820px, 45vw) 1fr;
    }
    @media (max-width: 1250px){
      .app{grid-template-columns: minmax(720px, 48vw) 1fr;}
    }
    @media (max-width: 980px){
      .filtersRow{position:relative; top:auto;}
      .topbar{position:relative;}
      html, body{overflow:auto;}
      body{overflow:auto;}
      .app{grid-template-columns: 1fr; grid-template-rows: 520px 1fr;}
      .errBanner{ position:relative; top:auto; }
    }

    .panel{
      background:var(--panel);
      border-right:1px solid var(--line);
      overflow:auto;
      padding:0;
      min-height:0;
      scroll-behavior:auto !important;
    }
    @media (max-width: 980px){
      .panel{border-right:none; border-bottom:1px solid var(--line);}
    }

    .card{
      background:linear-gradient(180deg, rgba(20,22,24,.9), rgba(16,18,20,.85));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }

    /* ===== STATS ===== */
    .statsSticky{
      position:sticky;
      top:0;
      z-index:4000;
      margin:0;
      padding:12px 14px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      border-radius:0;
      background:#0b0c0d;
      border-bottom:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .statsTitle{
      font-weight:1000;
      color:#e9eef7;
      font-size:14px;
      letter-spacing:.2px;
      margin-right:2px;
      user-select:none;
    }
    .sPill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }
    .sPill b{color:var(--mint); font-weight:1000}

    /* ===== LIST ===== */
    .listWrap{padding:12px;}
    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 1200px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .item{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(18,20,22,.92), rgba(14,16,18,.88));
      overflow:hidden;
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease, box-shadow .12s ease;
      min-height:308px;
    }
    .item:hover{ transform:translateY(-2px); border-color:rgba(162,222,204,.35); }
    .item.isActive{
      border-color:rgba(162,222,204,.55);
      box-shadow:0 0 0 2px rgba(162,222,204,.20), var(--shadow);
    }

    @keyframes pinFlash {
      0%   { box-shadow:0 0 0 0 rgba(162,222,204,.00), var(--shadow); }
      15%  { box-shadow:0 0 0 2px rgba(162,222,204,.25), 0 0 24px rgba(162,222,204,.22), var(--shadow); }
      45%  { box-shadow:0 0 0 2px rgba(162,222,204,.20), 0 0 34px rgba(162,222,204,.30), var(--shadow); }
      100% { box-shadow:0 0 0 2px rgba(162,222,204,.20), var(--shadow); }
    }
    .item.isPinFlash{
      animation: pinFlash 0.85s ease-out 1;
    }

    .thumb{width:100%; aspect-ratio: 16/9; background:#0d0f10; position:relative;}
    .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .thumb .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,.35);
      font-weight:1000;
      letter-spacing:.4px;
      font-size:12px;
    }

    .body{padding:10px 10px 12px;}
    .catRow{font-size:12px; color:var(--muted); margin-bottom:8px; display:flex; gap:6px; flex-wrap:wrap;}
    .tag{
      display:inline-flex; align-items:center;
      padding:3px 8px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color:#dfe6f3;
    }
    .name{
      font-size:15px; font-weight:1000; color:#e9eef7; line-height:1.24; margin:0 0 6px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:36px;
    }
    .place{
      font-size:13px; color:var(--muted); margin:0 0 10px;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; min-height:34px;
    }
    .price{
      display:flex; align-items:baseline; justify-content:space-between; gap:8px;
      padding-top:10px; border-top:1px solid rgba(255,255,255,.06);
    }
    .price .p{font-weight:1000; color:var(--mint); font-size:15px; white-space:nowrap;}
    .price .u{font-size:12px; color:var(--muted); white-space:nowrap;}

    /* ===== MAP ===== */
    .mapBox{position:relative; background:#000; padding:10px; min-height:0;}
    .mapInner{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow);
      height:100%;
      min-height:0;
      position:relative;
      background:#f3f5f7; /* v1.1.27: 검은 플래시 방지 */
    }
    #map{width:100%; height:100%; background:#f3f5f7;} /* v1.1.27 */

    .leaflet-tile-pane{
      filter: brightness(1.06) contrast(1.06) saturate(0.92);
      transition: opacity .12s ease;
    }

    /* v1.1.27: 고급 로더 */
    .mapLoader{
      position:absolute;
      inset:0;
      z-index:7000;
      pointer-events:none;
      opacity:0;
      transition:opacity .18s ease;
      background:rgba(245,247,249,.55);
      backdrop-filter: blur(2px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .mapLoader.isOn{ opacity:1; }
    .mlPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.78);
      box-shadow:0 18px 44px rgba(0,0,0,.18);
      font-weight:900;
      font-size:12px;
      color:#24313a;
      letter-spacing:.2px;
    }
    .mlDot{
      width:10px; height:10px;
      border-radius:50%;
      background:rgba(42,158,255,.85);
      box-shadow:0 0 0 6px rgba(42,158,255,.15);
      animation: mlPulse 1.05s ease-in-out infinite;
    }
    @keyframes mlPulse{
      0%{ transform:scale(1); opacity:.75; }
      50%{ transform:scale(1.12); opacity:1; }
      100%{ transform:scale(1); opacity:.75; }
    }

    /* ===== CLUSTER COLORS ===== */
    .marker-cluster-small{ background-color: rgba(42, 158, 255, 0.34) !important; }
    .marker-cluster-small div{ background-color: rgba(42, 158, 255, 0.68) !important; color:#fff !important; font-weight:1000 !important; }
    .marker-cluster-medium{ background-color: rgba(42, 158, 255, 0.34) !important; }
    .marker-cluster-medium div{ background-color: rgba(42, 158, 255, 0.68) !important; color:#fff !important; font-weight:1000 !important; }
    .marker-cluster-large{ background-color: rgba(42, 158, 255, 0.34) !important; }
    .marker-cluster-large div{ background-color: rgba(42, 158, 255, 0.68) !important; color:#fff !important; font-weight:1000 !important; }

    .clusterHighlight{
      border-radius:999px;
      box-shadow:none !important;
      background-color: rgba(162,222,204,.38) !important;
    }
    .clusterHighlight div{
      background-color: rgba(162,222,204,.92) !important;
      color:#062b23 !important;
      font-weight:1000 !important;
    }

    .clusterHint{
      position:absolute;
      z-index:9999;
      pointer-events:none;
      transform:translate(-50%, -140%);
      background:rgba(0,0,0,.82);
      border:1px solid rgba(162,222,204,.35);
      color:#e9fff9;
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      box-shadow:0 16px 40px rgba(0,0,0,.45);
      display:none;
      white-space:nowrap;
    }

    /* ===== PIN CLICK POPUP ===== */
    .leaflet-popup.pinPopWrap{ margin-bottom:0; }
    .leaflet-popup.pinPopWrap .leaflet-popup-content-wrapper{
      background:rgba(0,0,0,.90);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 18px 44px rgba(0,0,0,.55);
      color:#e9eef7;
      padding:0;
      overflow:hidden;
    }
    .leaflet-popup.pinPopWrap .leaflet-popup-tip{
      background:rgba(0,0,0,.90);
      box-shadow:0 18px 44px rgba(0,0,0,.35);
    }
    .leaflet-popup.pinPopWrap .leaflet-popup-content{ margin:0; min-width:300px; max-width:360px; }

    .pinPopCard{ display:flex; flex-direction:column; cursor:pointer; }
    .pinPopImg{
      width:100%;
      height:150px;
      background:#0d0f10;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .pinPopImg img{ width:100%; height:100%; object-fit:cover; display:block; }
    .pinPopImg .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,.35);
      font-weight:1000;
      font-size:12px;
      letter-spacing:.4px;
    }
    .pinPopBody{ padding:12px 12px 12px; display:flex; flex-direction:column; gap:8px; }
    .pinPopTitle{font-weight:1000; font-size:15px; line-height:1.2;}
    .pinPopSub{font-size:12px; color:var(--muted); line-height:1.2;}
    .pinPopPrice{font-size:13px; color:var(--mint); font-weight:1000;}

    .pinPopCtaRow{ margin-top:6px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .pinPopHint{font-size:11px; color:rgba(255,255,255,.65);}

    .pinPopBtnRow{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .pinPopBtn{
      border:1px solid rgba(162,222,204,.55);
      background:rgba(162,222,204,.12);
      color:#e9fff9;
      font-weight:1000;
      border-radius:12px;
      padding:8px 10px;
      font-size:12px;
      white-space:nowrap;
      cursor:pointer;
    }
    .pinPopBtn.ghost{
      border-color:rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
    }

    /* ===== RIGHT SIDE PANEL ===== */
    .mapSide{
      position:absolute;
      top:14px;
      right:14px;
      z-index:5000;
      width:var(--sideW);
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .sideCard{
      pointer-events:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,18,20,.82);
      box-shadow:0 18px 44px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .buildingCard{ display:flex; flex-direction:column; gap:0; }
    .buildingSec{ padding:10px; border-bottom:1px solid rgba(255,255,255,.08); }
    .buildingSec:last-child{ border-bottom:none; }

    .zoomBar{
      display:flex;
      align-items:stretch;
      justify-content:space-between;
      gap:8px;
      padding:6px;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .zLabel{
      flex:1 1 auto;
      min-width:0;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.28);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      color:#e9eef7;
      font-weight:1000;
      letter-spacing:.2px;
      padding:0 8px;
      height:44px;
    }
    .zLabel span{ font-size:10px; color:rgba(255,255,255,.55); font-weight:900; letter-spacing:.6px; }
    .zLabel b{ font-size:15px; font-weight:1000; color:#e9eef7; }
    .zStack{ width:44px; display:flex; flex-direction:column; gap:6px; flex:0 0 auto; }
    .zBtn{
      width:44px;
      height:19px;
      border-radius:10px;
      border:1px solid rgba(162,222,204,.35);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      line-height:1;
      font-size:12px;
    }
    .zBtn:active{ transform:translateY(1px); }

    .sideSectionTitle{
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(0,0,0,.18);
      font-weight:1000;
      color:#e9eef7;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }

    /* 장바구니 버튼 */
    .cartBtn{
      width:100%;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(162,222,204,.55);
      background:rgba(162,222,204,.12);
      color:#e9fff9;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 12px;
      user-select:none;
    }
    .cartCountPill{
      min-width:34px;
      height:28px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      color:var(--mint);
      flex:0 0 auto;
    }

    /* 최근 본 매체 */
    .recentBody{ padding:0; display:flex; flex-direction:column; gap:10px; }
    .recentList{ display:grid; grid-template-columns: 1fr; gap:10px; }

    .rRow{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease;
      min-width:0;
      overflow:hidden;
    }
    .rRow:hover{ transform:translateY(-1px); border-color:rgba(162,222,204,.30); }

    .rThumb{
      width:100%;
      height:78px;
      border-radius:12px;
      overflow:hidden;
      background:#0d0f10;
      border:1px solid rgba(255,255,255,.10);
      position:relative;
      min-width:0;
    }
    .rThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .rThumb .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      color:rgba(255,255,255,.35);
      font-weight:1000;
      font-size:11px;
      letter-spacing:.4px;
    }

    .rName{
      font-weight:1000;
      font-size:12px;
      line-height:1.2;
      color:#e9eef7;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .rPrice{
      margin-top:2px;
      font-weight:1000;
      font-size:12px;
      color:var(--mint);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }

    .rX{
      position:absolute;
      top:8px;
      right:8px;
      width:28px;
      height:28px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.55);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:1000;
      cursor:pointer;
      flex:0 0 auto;
    }

    .recentPager{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding-top:2px;
    }
    .pBtn{
      width:44px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(162,222,204,.30);
      background:rgba(255,255,255,.06);
      color:#e9eef7;
      font-weight:1000;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
    }
    .pBtn:disabled{ opacity:.35; cursor:not-allowed; }
    .pMeta{
      font-size:12px;
      color:rgba(255,255,255,.72);
      font-weight:900;
      letter-spacing:.2px;
      user-select:none;
      min-width:56px;
      text-align:center;
    }

    /* ===== DETAIL OVERLAY ===== */
    .detailOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.60);
      display:none;
      z-index:99999;
      padding:20px;
    }
    .detail{
      width:min(1600px, 96vw);
      height:min(92vh, 920px);
      max-height:min(92vh, 920px);
      overflow:auto;
      margin:0 auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(16,18,20,.98), rgba(10,12,14,.94));
      box-shadow:0 22px 60px rgba(0,0,0,.65);
    }
    .detailHead{
      position:sticky; top:0;
      background:rgba(16,18,20,.96);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:14px 16px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
      z-index:2;
    }
    .detailHead .t{font-weight:1000;color:#e9eef7;font-size:22px;margin:0;}
    .detailHead .s{color:var(--muted);font-size:12px;line-height:1.4;margin-top:4px;}
    .x{
      width:44px; height:44px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight:1000;
    }
    .detailBody{
      padding:16px 16px 18px;
      display:grid;
      grid-template-columns: 1.35fr 1fr;
      gap:14px;
    }
    @media (max-width: 920px){ .detailBody{grid-template-columns:1fr;} }
    .dimg{
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:#0d0f10;
      height:min(52vh, 520px);
      position:relative;
    }
    @media (max-width: 920px){ .dimg{ height:min(46vh, 460px); } }
    .dimg img{width:100%;height:100%;object-fit:cover;display:block;}
    .dimg .fallback{width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,.35);font-weight:1000;font-size:12px;}
    .info{
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background:rgba(0,0,0,.20);
      padding:12px;
      margin-bottom:10px;
    }
    .info .k{font-size:12px;color:var(--muted);margin-bottom:6px;}
    .info .v{font-size:14px;color:#e9eef7;font-weight:900;line-height:1.35;word-break:keep-all;}
    .links{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;}
    .links a{
      text-decoration:none;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(162,222,204,.30);
      background:rgba(162,222,204,.12);
      color:#e9fff9;
      font-weight:1000;
      font-size:12px;
    }
    .dActions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .dAddCart{
      height:44px;
      border-radius:14px;
      border:1px solid rgba(162,222,204,.55);
      background:rgba(162,222,204,.12);
      color:#e9fff9;
      font-weight:1000;
      cursor:pointer;
      padding:0 14px;
    }

    /* ===== MODAL (CART) ===== */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      z-index:999999;
      padding:20px;
    }
    .modal{
      width:min(900px, 96vw);
      max-height:min(90vh, 900px);
      overflow:auto;
      margin:0 auto;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(16,18,20,.98), rgba(10,12,14,.94));
      box-shadow:0 22px 60px rgba(0,0,0,.65);
    }
    .modalHead{
      position:sticky; top:0;
      background:rgba(16,18,20,.96);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      z-index:2;
    }
    .modalHead .t{font-weight:1000;color:#e9eef7;font-size:18px;margin:0;}
    .modalBody{ padding:14px 16px 18px; }

    .mRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .mRow:last-child{ border-bottom:none; }

    .mLeft{ display:flex; align-items:center; gap:12px; min-width:0; }
    .mThumb{
      width:150px;
      height:100px;
      border-radius:12px;
      overflow:hidden;
      background:#0d0f10;
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
    }
    .mThumb img{ width:100%; height:100%; object-fit:cover; display:block; }

    .mTitle{
      font-weight:1000;
      color:#e9eef7;
      font-size:14px;
      line-height:1.25;
      min-width:0;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .mPrice{
      font-weight:1000;
      color:var(--mint);
      font-size:14px;
      white-space:nowrap;
    }
    .mX{
      width:36px; height:36px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:#fff;
      cursor:pointer;
      font-weight:1000;
      flex:0 0 auto;
    }
    .mSum{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-weight:1000;
    }
    .mSum .muted{ color:rgba(255,255,255,.65); font-weight:900; font-size:12px; }
  </style>
</head>

<body>
  <div class="topbar" id="topbar">
    <div class="titleLeft" id="titleReset">Frontier DOOH 전국 DB <span class="ver">v1.1.27</span></div>
    <div class="pill">Loaded: <b id="pillLoaded">0</b></div>
  </div>

  <div class="errBanner" id="errBanner">
    <div class="errBox">
      <div style="min-width:0;">
        <b>데이터 로드 실패</b>
        <div style="margin-top:4px; color:rgba(255,255,255,.88);">
          <span id="errMsg">-</span>
          <span style="margin-left:8px;">(경로: <code id="errUrl">-</code>)</span>
        </div>
      </div>
      <button class="errClose" id="errClose">닫기</button>
    </div>
  </div>

  <div class="filtersRow" id="filtersRow">
    <div class="filtersInner">
      <div class="qWrap">
        <input id="q" class="q" type="text" placeholder="검색 (예: 강남구, 홍대, 전광판 …)" />
        <button class="qIconBtn" id="qIconBtn" aria-label="검색 실행" title="검색">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="rgba(255,255,255,.88)" stroke-width="2"/>
            <path d="M16.5 16.5 21 21" stroke="rgba(255,255,255,.88)" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div id="qSuggest" role="listbox" aria-label="검색어 제안"></div>
      </div>
      <select id="catHigh" class="cat" aria-label="매체 카테고리"></select>
      <button class="btn" id="reset">초기화</button>
    </div>
  </div>

  <div class="app">
    <div class="panel" id="panel">
      <div class="statsSticky">
        <div class="statsTitle">리스트</div>
        <div class="sPill">전체 <b id="mAll">0</b></div>
        <div class="sPill">필터 <b id="mFilter">0</b></div>
        <div class="sPill">현재범위 <b id="mInView">0</b></div>
      </div>

      <div class="card listWrap">
        <div class="grid" id="list"></div>

        <div id="empty" style="display:none; padding:12px; color:var(--muted); font-size:12px;">
          조건에 맞는 항목이 없습니다. 검색어/카테고리를 바꿔보세요.
        </div>

        <div id="moreHint" style="display:none; padding:12px; color:var(--muted); font-size:12px;">
          더 불러오는 중…
        </div>
      </div>
    </div>

    <div class="mapBox">
      <div class="mapInner">
        <div id="map"></div>
        <div class="mapLoader" id="mapLoader">
          <div class="mlPill"><span class="mlDot"></span><span>Loading map…</span></div>
        </div>

        <div class="clusterHint" id="clusterHint">클릭해서 확대</div>

        <div class="mapSide" id="mapSide">
          <div class="sideCard buildingCard" id="sideBuilding">
            <div class="buildingSec">
              <div class="zoomBar">
                <div class="zLabel" aria-label="현재 줌">
                  <span>ZOOM</span><b id="zVal">8</b>
                </div>
                <div class="zStack" aria-label="줌 버튼">
                  <button class="zBtn" id="zIn" aria-label="줌 인">＋</button>
                  <button class="zBtn" id="zOut" aria-label="줌 아웃">－</button>
                </div>
              </div>
            </div>

            <div class="buildingSec">
              <button class="cartBtn" id="cartBtn">
                <span>장바구니</span>
                <span class="cartCountPill" id="cartCount">0</span>
              </button>
            </div>

            <div class="buildingSec">
              <div class="sideSectionTitle">
                <span>최근 본 매체</span>
                <span style="color:rgba(255,255,255,.55); font-size:12px; font-weight:900;" id="recentMeta">0</span>
              </div>
              <div class="recentBody">
                <div class="recentList" id="recentList"></div>
                <div class="recentPager" id="recentPager" style="display:none;">
                  <button class="pBtn" id="recentPrev" aria-label="이전 페이지">←</button>
                  <div class="pMeta" id="recentPageMeta">1/1</div>
                  <button class="pBtn" id="recentNext" aria-label="다음 페이지">→</button>
                </div>
              </div>
            </div>
          </div>
          <!-- /빌딩 카드 -->
        </div>
      </div>
    </div>
  </div>

  <!-- Detail -->
  <div class="detailOverlay" id="dOverlay">
    <div class="detail">
      <div class="detailHead">
        <div style="min-width:0;">
          <div class="t" id="dt"></div>
          <div class="s" id="ds"></div>
        </div>
        <button class="x" id="dx">✕</button>
      </div>

      <div class="detailBody">
        <div class="dimg" id="dimg"></div>

        <div>
          <div class="info">
            <div class="k">카테고리</div>
            <div class="v" id="dcat">-</div>
          </div>

          <div class="info">
            <div class="k">가격</div>
            <div class="v" id="dprice">-</div>
          </div>

          <div class="info">
            <div class="k">주소</div>
            <div class="v" id="daddr">-</div>
          </div>

          <div class="info">
            <div class="k">운영사/담당</div>
            <div class="v" id="dop">-</div>
            <div class="links" id="dlinks"></div>
            <div class="dActions">
              <button class="dAddCart" id="dAddCart">장바구니 담기</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Modal -->
  <div class="modalOverlay" id="cartModalOverlay">
    <div class="modal">
      <div class="modalHead">
        <div class="t">장바구니</div>
        <button class="x" id="cartClose">✕</button>
      </div>
      <div class="modalBody" id="cartModalBody"></div>
    </div>
  </div>

<script>
  /* =========================================================
     v1.1.27 (안정화: 2/3/4/5/9만 적용)
     (2) 줌/초기화 시 검은 로딩 느낌 제거: 맵 배경 밝게 + 로더 오버레이
     (3) 검색 버튼 삭제: 입력창 내부 돋보기 아이콘(클릭/Enter)
     (4) 핀 2회 클릭(더블클릭/연속재클릭) -> 상세(해시모달) 100% 진입
     (5) 최근본 99개 제한 + 카운트 표기 N~NN (숫자만, max 99)
     (9) 핀 클릭시 리스트 밀림/걸침 제거 + “클릭 핀 카드가 리스트 1번” 고정:
         - scrollIntoView 제거
         - panel.scrollTop=0 2프레임 강제
         - pinnedTopKey를 이용해 리스트 1번에 강제 배치
         - moveend 이후 1회 재핀(클러스터 확대 직후 타이밍 꼬임 방지)
     ========================================================= */

  const VERSION = "v1.1.27";
  const DATA_URL = "./data_public.json";

  const CATEGORY_TREE = [
    { high:"전광판 / 빌보드 / 외벽" },
    { high:"교통매체" },
    { high:"복합 쇼핑몰 / 대형마트" },
    { high:"극장 / 레저 / 휴양 시설" },
    { high:"생활 밀착형 매체" },
  ];

  const HOME_ZOOM = 8;

  const HOME_BOUNDS_FIXED = { north: 39.5, south: 33.0, west: 123.5, east: 130.5 };
  const HOME_CENTER_SHIFT = { upPct: -0.07, leftPct: -0.10 };

  function computeHomeCenter(){
    const midLat = (HOME_BOUNDS_FIXED.north + HOME_BOUNDS_FIXED.south) / 2;
    const midLng = (HOME_BOUNDS_FIXED.west + HOME_BOUNDS_FIXED.east) / 2;
    const latSpan = (HOME_BOUNDS_FIXED.north - HOME_BOUNDS_FIXED.south);
    const lngSpan = (HOME_BOUNDS_FIXED.east - HOME_BOUNDS_FIXED.west);
    const latShift = latSpan * HOME_CENTER_SHIFT.upPct;
    const lngShift = lngSpan * HOME_CENTER_SHIFT.leftPct;
    return [ midLat + latShift, midLng - lngShift ];
  }
  const HOME_CENTER = computeHomeCenter();

  let ALL = [];
  let map = null;
  let markers = null;
  let baseLayer = null;

  const markerByKey = new Map();
  const itemByKey = new Map();
  const cardByKey = new Map();

  let curBase = [];
  let curInView = [];

  const BATCH = 36;
  const STEP  = 24;
  let renderLimit = BATCH;

  let currentOpenKey = null;
  let suppressHashHandler = false;

  let pinnedTopKey = null;
  let pinFlashTimer = null;

  /* v1.1.27: 핀 2회 클릭 안정화 */
  let lastPinClickKey = null;
  let lastPinClickAt = 0;
  const PIN_RECLICK_MS = 420;

  /* v1.1.27: moveend 후 재핀 */
  let repinOnNextMoveendKey = null;

  const SS_RECENT = "frontier_recent_viewed_v1";
  const SS_CART   = "frontier_cart_v1";

  const RECENT_PAGE_SIZE = 4;
  const RECENT_MAX = 99;
  let recentKeys = [];
  let recentPage = 0;

  let cartKeys = [];

  const $ = (id) => document.getElementById(id);

  function showErrorBanner(msg){
    $("errMsg").textContent = msg || "알 수 없는 오류";
    $("errUrl").textContent = DATA_URL;
    $("errBanner").style.display = "block";
  }
  function hideErrorBanner(){ $("errBanner").style.display = "none"; }

  function showMapLoader(){ $("mapLoader")?.classList.add("isOn"); }
  function hideMapLoader(){ $("mapLoader")?.classList.remove("isOn"); }

  function addOption(sel, value, label){
    const o = document.createElement("option");
    o.value = value;
    o.textContent = label ?? value;
    sel.appendChild(o);
  }

  function escapeHtml(s){
    return (s ?? "").toString()
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function searchNorm(s){
    return (s ?? "").toString().toLowerCase()
      .replace(/\s+/g,"")
      .replace(/[()［］\[\]{}<>.,\-_/\\]/g,"");
  }

  function fmtWon(price, unit){
    const s = (price ?? "").toString();
    const n = parseInt(s.replace(/[^\d]/g,""), 10);
    if (!n || isNaN(n)) return "문의";
    const won = n.toLocaleString("ko-KR") + "원";
    const u = (unit ?? "").toString().trim();
    return u ? `${won} / ${u}` : won;
  }

  function parsePriceNumber(price){
    const s = (price ?? "").toString();
    const n = parseInt(s.replace(/[^\d]/g,""), 10);
    if (!n || isNaN(n)) return null;
    return n;
  }

  function guessPlace(item){
    const addr = (item.address || "").trim();
    const toks = addr.split(" ").filter(Boolean);
    return toks.slice(0, Math.min(4, toks.length)).join(" ") || (item.title || "-");
  }

  function safeImg(url){
    const u = (url ?? "").toString().trim();
    if (!u) return "";
    return u;
  }

  function setCatHighOptions(){
    const sel = $("catHigh");
    sel.innerHTML = "";
    addOption(sel, "", "매체 카테고리 (전체)");
    CATEGORY_TREE.forEach(x => addOption(sel, x.high, x.high));
  }

  function loadStore(){
    try{
      const r = sessionStorage.getItem(SS_RECENT);
      recentKeys = r ? JSON.parse(r) : [];
      if (!Array.isArray(recentKeys)) recentKeys = [];
    }catch(e){ recentKeys = []; }

    try{
      const c = sessionStorage.getItem(SS_CART);
      cartKeys = c ? JSON.parse(c) : [];
      if (!Array.isArray(cartKeys)) cartKeys = [];
    }catch(e){ cartKeys = []; }

    /* v1.1.27: recent max 99 강제 */
    recentKeys = recentKeys.filter(Boolean).slice(0, RECENT_MAX);
    cartKeys = cartKeys.filter(Boolean);

    saveStore();
  }

  function saveStore(){
    try{ sessionStorage.setItem(SS_RECENT, JSON.stringify(recentKeys)); }catch(e){}
    try{ sessionStorage.setItem(SS_CART, JSON.stringify(cartKeys)); }catch(e){}
  }

  function setPills(){
    $("pillLoaded").textContent = String(ALL.length);
    $("mAll").textContent = String(ALL.length);
    $("cartCount").textContent = String(cartKeys.length);

    /* v1.1.27: 최근본 카운트는 “숫자만 / 최대99” */
    const cnt = Math.min(recentKeys.length, RECENT_MAX);
    $("recentMeta").textContent = String(cnt);
  }

  /* ===== MAP / MARKER ICON ===== */
  function makePinSVG(active=false){
    const fill = active ? "rgba(162,222,204,1)" : "rgba(42,158,255,0.92)";
    const stroke = "rgba(0,0,0,0.40)";
    return `
      <svg width="34" height="44" viewBox="0 0 34 44" xmlns="http://www.w3.org/2000/svg">
        <path d="M17 43c7-10 14-16 14-26C31 7.6 24.4 1 17 1S3 7.6 3 17c0 10 7 16 14 26Z"
          fill="${fill}" stroke="${stroke}" stroke-width="1.2"/>
        <circle cx="17" cy="17" r="6.2" fill="rgba(0,0,0,0.35)"/>
        <circle cx="17" cy="17" r="3.4" fill="rgba(255,255,255,0.92)"/>
      </svg>
    `;
  }

  function makeMarkerIcon(active=false){
    return L.divIcon({
      className: "pinWrap",
      html: makePinSVG(active),
      iconSize: [34,44],
      iconAnchor: [17,42],
      popupAnchor: [0,-40]
    });
  }

  function buildPopupHTML(it){
    const img = safeImg(it.image_url || it.img || it.image || "");
    const priceText = fmtWon(it.price, it.price_unit);
    const addr = (it.address || "").toString().trim();
    return `
      <div class="pinPopCard" data-key="${escapeHtml(it.key)}">
        <div class="pinPopImg">
          ${img ? `<img src="${escapeHtml(img)}" alt="">` : `<div class="fallback">NO IMAGE</div>`}
        </div>
        <div class="pinPopBody">
          <div class="pinPopTitle">${escapeHtml(it.title || "-")}</div>
          <div class="pinPopSub">${escapeHtml(addr || "-")}</div>
          <div class="pinPopPrice">${escapeHtml(priceText)}</div>
          <div class="pinPopCtaRow">
            <div class="pinPopHint">더블클릭 또는 빠른 재클릭 → 상세</div>
            <div class="pinPopBtnRow">
              <button class="pinPopBtn ghost" data-act="cart">담기</button>
              <button class="pinPopBtn" data-act="detail">상세</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  /* ===== LIST CARD ===== */
  function makeCard(it){
    const key = it.key;
    const div = document.createElement("div");
    div.className = "item";
    div.dataset.key = key;

    const img = safeImg(it.image_url || it.img || it.image || "");
    const high = (it.category_high || it.high || it.media_group || it.category || "").toString().trim() || "기타";
    const low  = (it.category_low  || it.low  || "").toString().trim();
    const addr = guessPlace(it);
    const priceText = fmtWon(it.price, it.price_unit);

    div.innerHTML = `
      <div class="thumb">
        ${img ? `<img src="${escapeHtml(img)}" alt="">` : `<div class="fallback">NO IMAGE</div>`}
      </div>
      <div class="body">
        <div class="catRow">
          <span class="tag">${escapeHtml(high)}</span>
          ${low ? `<span class="tag">${escapeHtml(low)}</span>` : ``}
        </div>
        <p class="name">${escapeHtml(it.title || "-")}</p>
        <p class="place">${escapeHtml(addr || "-")}</p>
        <div class="price">
          <div class="p">${escapeHtml(priceText)}</div>
          <div class="u">${escapeHtml((it.price_unit || "").toString() || "")}</div>
        </div>
      </div>
    `;

    div.addEventListener("click", (e)=>{
      e.preventDefault();
      openDetailByKey(key, { pushHash:true, from:"list" });
    });

    return div;
  }

  function flashCard(key){
    const el = cardByKey.get(key);
    if (!el) return;
    el.classList.remove("isPinFlash");
    void el.offsetWidth;
    el.classList.add("isPinFlash");
    clearTimeout(pinFlashTimer);
    pinFlashTimer = setTimeout(()=>{ el.classList.remove("isPinFlash"); }, 950);
  }

  function setActiveCard(key){
    cardByKey.forEach((el, k)=>{
      if (k === key) el.classList.add("isActive");
      else el.classList.remove("isActive");
    });
  }

  /* ===== FILTERING ===== */
  function itemSearchBlob(it){
    const parts = [
      it.title, it.address, it.media_group, it.category_high, it.category_low,
      it.operator, it.owner, it.city, it.region
    ].filter(Boolean).map(x=>x.toString());
    return searchNorm(parts.join(" "));
  }

  function applyFilters(){
    const q = $("q").value.trim();
    const cat = $("catHigh").value;

    const qn = searchNorm(q);
    const catn = (cat || "").trim();

    let out = ALL;

    if (catn){
      out = out.filter(it => ((it.category_high || it.media_group || "") + "").trim() === catn);
    }
    if (qn){
      out = out.filter(it => itemSearchBlob(it).includes(qn));
    }

    curBase = out;

    /* 리스트 “현재범위”는 moveend에서 계산 */
    $("mFilter").textContent = String(curBase.length);

    /* pinnedTopKey가 현재 필터에 없으면 해제 */
    if (pinnedTopKey && !curBase.some(x=>x.key === pinnedTopKey)) pinnedTopKey = null;

    renderLimit = BATCH;
    recomputeInViewAndRender();
  }

  function recomputeInView(){
    if (!map) { curInView = curBase.slice(); return; }
    const b = map.getBounds();
    let inb = curBase.filter(it=>{
      const lat = Number(it.lat), lng = Number(it.lng);
      if (!isFinite(lat) || !isFinite(lng)) return false;
      return b.contains([lat,lng]);
    });

    /* v1.1.27: 클릭 핀 카드가 리스트 1번 */
    if (pinnedTopKey){
      const idx = inb.findIndex(x=>x.key === pinnedTopKey);
      if (idx >= 0){
        const sel = inb.splice(idx,1)[0];
        inb = [sel, ...inb];
      }else{
        /* 범위 내에 없으면 base에서도 1번으로 올릴 필요가 없으므로 유지 */
      }
    }

    curInView = inb;
    $("mInView").textContent = String(curInView.length);
  }

  function renderList(){
    const list = $("list");
    const empty = $("empty");
    const moreHint = $("moreHint");

    list.innerHTML = "";
    cardByKey.clear();

    const total = curInView.length;
    if (total === 0){
      empty.style.display = "block";
      moreHint.style.display = "none";
      return;
    }
    empty.style.display = "none";

    const slice = curInView.slice(0, renderLimit);
    slice.forEach(it=>{
      const card = makeCard(it);
      cardByKey.set(it.key, card);
      list.appendChild(card);
    });

    if (renderLimit < total){
      moreHint.style.display = "block";
    }else{
      moreHint.style.display = "none";
    }

    if (pinnedTopKey){
      setActiveCard(pinnedTopKey);
      flashCard(pinnedTopKey);
    }
  }

  function recomputeInViewAndRender(){
    recomputeInView();
    renderList();
  }

  function attachInfiniteScroll(){
    const panel = $("panel");
    panel.addEventListener("scroll", ()=>{
      const nearBottom = panel.scrollTop + panel.clientHeight >= panel.scrollHeight - 520;
      if (nearBottom && renderLimit < curInView.length){
        renderLimit = Math.min(curInView.length, renderLimit + STEP);
        renderList();
      }
    }, { passive:true });
  }

  /* ===== v1.1.27: 핀 클릭시 “리스트 최상단 고정” (밀림/걸침 제거) ===== */
  function hardPinListToTop(){
    const panel = $("panel");
    panel.scrollTop = 0;
    requestAnimationFrame(()=>{ panel.scrollTop = 0; });
    requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ panel.scrollTop = 0; }); });
  }

  /* ===== MAP INIT ===== */
  function initMap(){
    map = L.map("map", {
      zoomControl:false,
      doubleClickZoom:false, /* v1.1.27: 더블클릭 상세와 충돌 방지 */
      preferCanvas:true
    }).setView(HOME_CENTER, HOME_ZOOM);

    $("zVal").textContent = String(map.getZoom());

    baseLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap"
    });

    /* v1.1.27: 로딩 오버레이 */
    let loaderT = null;
    baseLayer.on("loading", ()=>{
      clearTimeout(loaderT);
      loaderT = setTimeout(()=>{ showMapLoader(); }, 80);
    });
    baseLayer.on("load", ()=>{
      clearTimeout(loaderT);
      hideMapLoader();
    });

    baseLayer.addTo(map);

    markers = L.markerClusterGroup({
      showCoverageOnHover: false,
      removeOutsideVisibleBounds: true,
      maxClusterRadius: 58,
      spiderfyOnMaxZoom: true,
      disableClusteringAtZoom: 16
    });

    markers.on("clusterclick", (e)=>{
      highlightCluster(e.layer);
      showClusterHintAt(e.latlng);
      setTimeout(hideClusterHint, 680);
      repinOnNextMoveendKey = pinnedTopKey; /* 확대 직후 한번 재핀 */
    });

    markers.on("animationend", ()=>{
      if (repinOnNextMoveendKey){
        const k = repinOnNextMoveendKey;
        repinOnNextMoveendKey = null;
        /* moveend와 비슷한 효과: 범위/리스트 재계산 후 강제 top */
        recomputeInViewAndRender();
        if (k && curInView.some(x=>x.key===k)){
          pinnedTopKey = k;
          recomputeInViewAndRender();
          hardPinListToTop();
        }
      }
    });

    map.on("zoomend moveend", ()=>{
      $("zVal").textContent = String(map.getZoom());
      recomputeInViewAndRender();

      if (repinOnNextMoveendKey){
        const k = repinOnNextMoveendKey;
        repinOnNextMoveendKey = null;
        if (k){
          pinnedTopKey = k;
          recomputeInViewAndRender();
          hardPinListToTop();
        }
      }
    });

    map.on("dragstart", ()=>{});
    map.on("click", ()=>{ hideClusterHint(); });

    $("zIn").addEventListener("click", ()=> map.zoomIn());
    $("zOut").addEventListener("click", ()=> map.zoomOut());

    $("reset").addEventListener("click", ()=> resetAll());
    $("titleReset").addEventListener("click", ()=> resetAll());
  }

  function highlightCluster(layer){
    try{
      if (layer && layer._icon){
        if (window.__lastClusterIcon && window.__lastClusterIcon !== layer._icon){
          window.__lastClusterIcon.classList.remove("clusterHighlight");
        }
        layer._icon.classList.add("clusterHighlight");
        window.__lastClusterIcon = layer._icon;
      }
    }catch(e){}
  }

  function showClusterHintAt(latlng){
    const hint = $("clusterHint");
    if (!hint || !map) return;
    const p = map.latLngToContainerPoint(latlng);
    hint.style.left = p.x + "px";
    hint.style.top  = p.y + "px";
    hint.style.display = "block";
  }
  function hideClusterHint(){
    const hint = $("clusterHint");
    if (hint) hint.style.display = "none";
  }

  /* ===== MARKERS ===== */
  function addMarkers(){
    markers.clearLayers();
    markerByKey.clear();

    ALL.forEach(it=>{
      const lat = Number(it.lat), lng = Number(it.lng);
      if (!isFinite(lat) || !isFinite(lng)) return;

      const m = L.marker([lat,lng], { icon: makeMarkerIcon(false) });

      /* 클릭: 미니팝업 + 리스트 최상단/1번 고정 */
      m.on("click", ()=>{
        onPinClick(it.key);
      });

      /* 더블클릭: 상세 */
      m.on("dblclick", (ev)=>{
        L.DomEvent.stop(ev);
        openDetailByKey(it.key, { pushHash:true, from:"pin" });
      });

      m.bindPopup(buildPopupHTML(it), { className:"pinPopWrap", closeButton:false, autoPan:true, maxWidth:360 });

      m.on("popupopen", (ev)=>{
        const node = ev.popup.getElement();
        if (!node) return;

        /* popup 내부 버튼 이벤트 */
        node.addEventListener("click", (e)=>{
          const tgt = e.target;
          if (!(tgt instanceof HTMLElement)) return;
          const act = tgt.getAttribute("data-act");
          if (!act) return;
          e.preventDefault();
          e.stopPropagation();
          if (act === "detail"){
            openDetailByKey(it.key, { pushHash:true, from:"pin" });
          }else if (act === "cart"){
            addToCart(it.key);
          }
        }, { once:true });
      });

      markers.addLayer(m);
      markerByKey.set(it.key, m);
    });

    markers.addTo(map);
  }

  function onPinClick(key){
    const now = Date.now();
    if (lastPinClickKey === key && (now - lastPinClickAt) <= PIN_RECLICK_MS){
      /* v1.1.27: 같은 핀 빠른 재클릭 -> 상세 */
      openDetailByKey(key, { pushHash:true, from:"pin" });
      lastPinClickAt = 0;
      lastPinClickKey = null;
      return;
    }
    lastPinClickKey = key;
    lastPinClickAt = now;

    pinnedTopKey = key;

    /* 맵 센터 이동은 유지(기존 느낌) */
    const it = itemByKey.get(key);
    if (it && map){
      map.panTo([Number(it.lat), Number(it.lng)], { animate:true, duration:0.45 });
    }

    /* 리스트를 “클릭핀 1번” + 최상단 고정 */
    recomputeInViewAndRender();
    hardPinListToTop();

    /* 미니팝업 오픈 */
    const mk = markerByKey.get(key);
    if (mk){
      mk.openPopup();
    }

    /* active 스타일 */
    setActiveCard(key);

    /* 최근본 업데이트 */
    addToRecent(key);
  }

  /* ===== SEARCH 실행 (Enter / 돋보기 클릭) ===== */
  function runSearch(){
    applyFilters();
    const q = $("q").value.trim();
    if (!q) return;

    /* 검색 결과가 있으면 줌 처리(기존 로직 유지) */
    const found = curBase;
    if (!map) return;

    if (found.length === 1){
      const it = found[0];
      if (isFinite(Number(it.lat)) && isFinite(Number(it.lng))){
        map.setView([Number(it.lat), Number(it.lng)], 13, { animate:true });
        pinnedTopKey = it.key;
        recomputeInViewAndRender();
        hardPinListToTop();
      }
    }else if (found.length > 1){
      const pts = found
        .map(x=>[Number(x.lat), Number(x.lng)])
        .filter(p=>isFinite(p[0]) && isFinite(p[1]));
      if (pts.length >= 2){
        const b = L.latLngBounds(pts);
        map.fitBounds(b, { padding:[46,46], animate:true });
        repinOnNextMoveendKey = pinnedTopKey;
      }
    }
  }

  /* ===== RECENT ===== */
  function addToRecent(key){
    if (!key) return;
    recentKeys = recentKeys.filter(k=>k!==key);
    recentKeys.unshift(key);
    recentKeys = recentKeys.slice(0, RECENT_MAX);
    saveStore();
    setPills();
    renderRecent();
  }

  function removeRecent(key){
    recentKeys = recentKeys.filter(k=>k!==key);
    saveStore();
    setPills();
    if (recentPage > 0){
      const maxPage = Math.max(0, Math.ceil(recentKeys.length / RECENT_PAGE_SIZE) - 1);
      recentPage = Math.min(recentPage, maxPage);
    }
    renderRecent();
  }

  function renderRecent(){
    const box = $("recentList");
    const pager = $("recentPager");
    const meta = $("recentPageMeta");
    const prev = $("recentPrev");
    const next = $("recentNext");

    box.innerHTML = "";

    const total = recentKeys.length;
    const maxPage = Math.max(0, Math.ceil(total / RECENT_PAGE_SIZE) - 1);
    recentPage = Math.min(recentPage, maxPage);

    const start = recentPage * RECENT_PAGE_SIZE;
    const keys = recentKeys.slice(start, start + RECENT_PAGE_SIZE);

    keys.forEach(k=>{
      const it = itemByKey.get(k);
      if (!it) return;

      const row = document.createElement("div");
      row.className = "rRow";
      row.dataset.key = k;

      const img = safeImg(it.image_url || it.img || it.image || "");
      const priceText = fmtWon(it.price, it.price_unit);

      row.innerHTML = `
        <div class="rThumb">
          ${img ? `<img src="${escapeHtml(img)}" alt="">` : `<div class="fallback">NO IMAGE</div>`}
        </div>
        <div class="rName" title="${escapeHtml(it.title || "")}">${escapeHtml(it.title || "-")}</div>
        <div class="rPrice">${escapeHtml(priceText)}</div>
        <div class="rX" title="삭제">✕</div>
      `;

      row.addEventListener("click", (e)=>{
        const t = e.target;
        if (t instanceof HTMLElement && t.classList.contains("rX")){
          e.preventDefault();
          e.stopPropagation();
          removeRecent(k);
          return;
        }
        openDetailByKey(k, { pushHash:true, from:"recent" });
      });

      box.appendChild(row);
    });

    if (total <= RECENT_PAGE_SIZE){
      pager.style.display = "none";
    }else{
      pager.style.display = "flex";
      meta.textContent = `${recentPage+1}/${maxPage+1}`;
      prev.disabled = recentPage <= 0;
      next.disabled = recentPage >= maxPage;
    }

    prev.onclick = ()=>{ if (recentPage>0){ recentPage--; renderRecent(); } };
    next.onclick = ()=>{ if (recentPage<maxPage){ recentPage++; renderRecent(); } };
  }

  /* ===== CART ===== */
  function addToCart(key){
    if (!key) return;
    if (!cartKeys.includes(key)){
      cartKeys.push(key);
      saveStore();
      setPills();
    }
  }
  function removeFromCart(key){
    cartKeys = cartKeys.filter(k=>k!==key);
    saveStore();
    setPills();
    renderCartModal();
  }

  function openCartModal(){
    renderCartModal();
    $("cartModalOverlay").style.display = "block";
  }
  function closeCartModal(){
    $("cartModalOverlay").style.display = "none";
  }

  function renderCartModal(){
    const body = $("cartModalBody");
    body.innerHTML = "";

    if (cartKeys.length === 0){
      body.innerHTML = `<div style="color:rgba(255,255,255,.65); font-size:13px;">장바구니가 비어 있습니다.</div>`;
      return;
    }

    let sum = 0;
    cartKeys.forEach(k=>{
      const it = itemByKey.get(k);
      if (!it) return;

      const row = document.createElement("div");
      row.className = "mRow";

      const img = safeImg(it.image_url || it.img || it.image || "");
      const pnum = parsePriceNumber(it.price);
      if (pnum) sum += pnum;

      row.innerHTML = `
        <div class="mLeft">
          <div class="mThumb">${img ? `<img src="${escapeHtml(img)}" alt="">` : ``}</div>
          <div style="min-width:0;">
            <div class="mTitle">${escapeHtml(it.title || "-")}</div>
            <div style="margin-top:6px;" class="mPrice">${escapeHtml(fmtWon(it.price, it.price_unit))}</div>
          </div>
        </div>
        <button class="mX" title="삭제">✕</button>
      `;

      row.querySelector(".mLeft").addEventListener("click", ()=>{
        closeCartModal();
        openDetailByKey(k, { pushHash:true, from:"cart" });
      });

      row.querySelector(".mX").addEventListener("click", (e)=>{
        e.preventDefault();
        e.stopPropagation();
        removeFromCart(k);
      });

      body.appendChild(row);
    });

    const sumBox = document.createElement("div");
    sumBox.className = "mSum";
    sumBox.innerHTML = `
      <div><span class="muted">수량</span> ${cartKeys.length}개</div>
      <div><span class="muted">합계(참고)</span> ${sum ? sum.toLocaleString("ko-KR")+"원" : "문의"}</div>
    `;
    body.appendChild(sumBox);
  }

  /* ===== DETAIL ===== */
  function openDetailByKey(key, { pushHash=false, from="" } = {}){
    const it = itemByKey.get(key);
    if (!it) return;

    currentOpenKey = key;

    $("dt").textContent = it.title || "-";
    $("ds").textContent = (it.address || "").toString() || "-";

    $("dcat").textContent = ((it.category_high || it.media_group || "기타") + (it.category_low ? (" / "+it.category_low) : ""));
    $("dprice").textContent = fmtWon(it.price, it.price_unit);
    $("daddr").textContent = (it.address || "").toString() || "-";
    $("dop").textContent = (it.operator || it.owner || it.vendor || "-").toString();

    const img = safeImg(it.image_url || it.img || it.image || "");
    $("dimg").innerHTML = img ? `<img src="${escapeHtml(img)}" alt="">` : `<div class="fallback">NO IMAGE</div>`;

    const links = $("dlinks");
    links.innerHTML = "";
    const website = (it.website || it.url || "").toString().trim();
    const tel = (it.tel || it.phone || "").toString().trim();
    if (website){
      const a = document.createElement("a");
      a.href = website;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = "링크";
      links.appendChild(a);
    }
    if (tel){
      const a = document.createElement("a");
      a.href = "tel:" + tel;
      a.textContent = "전화";
      links.appendChild(a);
    }

    $("dOverlay").style.display = "block";

    /* 최근본 */
    addToRecent(key);

    /* 지도 이동 */
    if (map && isFinite(Number(it.lat)) && isFinite(Number(it.lng))){
      map.panTo([Number(it.lat), Number(it.lng)], { animate:true, duration:0.45 });
    }

    /* 해시 */
    if (pushHash){
      suppressHashHandler = true;
      location.hash = "#m=" + encodeURIComponent(key);
      setTimeout(()=>{ suppressHashHandler = false; }, 0);
    }

    /* 리스트 강조 */
    pinnedTopKey = key;
    recomputeInViewAndRender();
    hardPinListToTop();
    setActiveCard(key);
    flashCard(key);
  }

  function closeDetail({ clearHash=true } = {}){
    $("dOverlay").style.display = "none";
    currentOpenKey = null;

    if (clearHash){
      suppressHashHandler = true;
      history.replaceState(null, "", location.pathname + location.search);
      setTimeout(()=>{ suppressHashHandler = false; }, 0);
    }
  }

  /* ===== RESET ===== */
  function resetAll(){
    $("q").value = "";
    $("catHigh").value = "";
    pinnedTopKey = null;
    lastPinClickKey = null;
    lastPinClickAt = 0;

    if (map){
      map.setView(HOME_CENTER, HOME_ZOOM, { animate:true });
    }
    applyFilters();
    hardPinListToTop();
  }

  /* ===== HASH ROUTING ===== */
  function parseHashKey(){
    const h = (location.hash || "").trim();
    if (!h) return "";
    const m = h.match(/#m=([^&]+)/);
    if (m && m[1]) return decodeURIComponent(m[1]);
    return "";
  }

  window.addEventListener("hashchange", ()=>{
    if (suppressHashHandler) return;
    const k = parseHashKey();
    if (!k){
      if ($("dOverlay").style.display === "block") closeDetail({ clearHash:false });
      return;
    }
    if (itemByKey.has(k)){
      openDetailByKey(k, { pushHash:false, from:"hash" });
    }
  });

  /* ===== SEARCH SUGGEST (간단) ===== */
  function setupSuggestPool(){
    const set = new Set();
    ALL.slice(0, 400).forEach(it=>{
      const t = (it.title || "").toString().trim();
      if (t && t.length <= 30) set.add(t);
      const a = (it.address || "").toString().trim();
      if (a){
        const tok = a.split(" ").filter(Boolean).slice(0,2).join(" ");
        if (tok && tok.length <= 18) set.add(tok);
      }
    });
    ["강남구","강남역","홍대","홍대입구","대구","대전","부산","오송역","전광판","KTX","공항"].forEach(x=>set.add(x));
    return Array.from(set).slice(0, 200);
  }

  function renderSuggest(q){
    const box = $("qSuggest");
    const t = q.trim();
    if (!t){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }
    const qn = searchNorm(t);
    const cand = SUG_POOL.filter(s=>searchNorm(s).includes(qn)).slice(0, 8);
    if (cand.length === 0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }
    box.innerHTML = "";
    cand.forEach((s, i)=>{
      const div = document.createElement("div");
      div.className = "qSugItem";
      div.innerHTML = `<span>${escapeHtml(s)}</span><small>Enter</small>`;
      div.addEventListener("click", ()=>{
        $("q").value = s;
        box.style.display = "none";
        runSearch();
      });
      box.appendChild(div);
    });
    box.style.display = "block";
  }

  function bindUI(){
    $("errClose").addEventListener("click", hideErrorBanner);

    $("cartBtn").addEventListener("click", openCartModal);
    $("cartClose").addEventListener("click", closeCartModal);
    $("cartModalOverlay").addEventListener("click", (e)=>{
      if (e.target === $("cartModalOverlay")) closeCartModal();
    });

    $("dx").addEventListener("click", ()=> closeDetail({ clearHash:true }));
    $("dOverlay").addEventListener("click", (e)=>{
      if (e.target === $("dOverlay")) closeDetail({ clearHash:true });
    });

    $("dAddCart").addEventListener("click", ()=>{
      if (currentOpenKey) addToCart(currentOpenKey);
    });

    $("catHigh").addEventListener("change", ()=> applyFilters());

    /* v1.1.27: Enter / 돋보기 클릭으로 검색 */
    $("q").addEventListener("keydown", (e)=>{
      if (e.key === "Enter"){
        e.preventDefault();
        $("qSuggest").style.display = "none";
        runSearch();
      }
    });
    $("qIconBtn").addEventListener("click", (e)=>{
      e.preventDefault();
      $("qSuggest").style.display = "none";
      runSearch();
    });

    $("q").addEventListener("input", ()=>{
      renderSuggest($("q").value);
    });
    document.addEventListener("click", (e)=>{
      const box = $("qSuggest");
      if (!box) return;
      const wrap = box.parentElement;
      if (wrap && !wrap.contains(e.target)){
        box.style.display = "none";
      }
    });

    attachInfiniteScroll();
  }

  /* ===== DATA LOAD ===== */
  async function loadData(){
    hideErrorBanner();
    try{
      const res = await fetch(DATA_URL, { cache:"no-cache" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const json = await res.json();
      if (!Array.isArray(json)) throw new Error("data_public.json 형식 오류(배열 아님)");

      ALL = json.map((it, idx)=>{
        const o = { ...it };
        o.key = (o.key || o.id || String(idx)).toString();
        o.lat = Number(o.lat ?? o.latitude);
        o.lng = Number(o.lng ?? o.longitude);
        o.title = (o.title || o.name || "").toString();
        o.address = (o.address || o.addr || o.location || "").toString();
        o.media_group = (o.media_group || o.category_high || o.high || "").toString().trim();
        o.category_high = (o.category_high || o.high || o.media_group || "").toString().trim();
        o.category_low  = (o.category_low || o.low || "").toString().trim();
        o.price_unit = (o.price_unit || o.unit || "").toString();
        return o;
      });

      itemByKey.clear();
      ALL.forEach(it=> itemByKey.set(it.key, it));

      $("pillLoaded").textContent = String(ALL.length);

      /* 카테고리 옵션 */
      setCatHighOptions();

      /* suggest pool */
      SUG_POOL = setupSuggestPool();

      /* 초기 필터 */
      curBase = ALL.slice();
      $("mAll").textContent = String(ALL.length);
      $("mFilter").textContent = String(curBase.length);

    }catch(err){
      showErrorBanner((err && err.message) ? err.message : String(err));
      ALL = [];
      curBase = [];
    }
  }

  /* ===== BOOT ===== */
  async function boot(){
    loadStore();
    setPills();
    bindUI();
    initMap();

    await loadData();

    setPills();
    addMarkers();

    applyFilters();
    renderRecent();

    /* 해시로 진입 */
    const hk = parseHashKey();
    if (hk && itemByKey.has(hk)){
      openDetailByKey(hk, { pushHash:false, from:"hash-onload" });
    }
  }

  boot();
</script>
</body>
</html>
