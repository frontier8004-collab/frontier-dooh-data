<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frontier DOOH Map (House of OOH - Single/Fixed)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#07090c;
      --panel:#0c1016;
      --line:rgba(255,255,255,.10);
      --mint:#a2decc;
      --text:#e7eef7;
      --muted:rgba(231,238,247,.68);
      --danger:#ff6b6b;
      --shadow:0 18px 48px rgba(0,0,0,.55);

      --panelW: 520px;
      --topbarH: 58px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,NanumGothic,sans-serif}
    a{color:inherit}

    .shell{
      height:100vh;
      width:100vw;
      overflow:hidden;
      background:
        radial-gradient(1100px 600px at 20% 10%, rgba(162,222,204,.12), transparent 60%),
        radial-gradient(1000px 700px at 90% 30%, rgba(162,222,204,.10), transparent 65%),
        var(--bg);
    }

    .topbar{
      height:var(--topbarH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
    }
    .topbar .left{
      display:flex; align-items:baseline; gap:10px;
      min-width:0;
    }
    .topbar .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:15px;
      white-space:nowrap;
    }
    .topbar .sub{
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:52vw;
    }
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(162,222,204,.35);
      color:rgba(162,222,204,.95);
      background:rgba(162,222,204,.07);
      white-space:nowrap;
    }

    .main{
      height:calc(100vh - var(--topbarH));
      display:grid;
      grid-template-columns: var(--panelW) 10px 1fr;
      min-height:0;
    }

    .panel{
      min-height:0;
      overflow:auto;
      padding:16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%),
        var(--panel);
      border-right:1px solid rgba(255,255,255,.08);
    }

    .resizer{
      cursor: col-resize;
      background:rgba(255,255,255,.04);
      border-right:1px solid rgba(255,255,255,.08);
      border-left:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .resizer:before{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:3px; height:42px;
      border-radius:999px;
      transform:translate(-50%,-50%);
      background:rgba(162,222,204,.28);
      box-shadow:0 0 0 6px rgba(162,222,204,.05);
    }

    .map-wrap{
      min-height:0;
      position:relative;
      overflow:hidden;
      background:#050607;
    }
    #map{height:100%; width:100%; background:#050607;}

    .section{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      margin-bottom:12px;
    }

    .grid{display:grid;grid-template-columns:1fr;gap:10px;}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}

    @media (max-width: 980px){
      .main{grid-template-columns: 1fr; grid-template-rows: auto 1fr;}
      .resizer{display:none;}
      .panel{
        border-right:none;
        border-bottom:1px solid rgba(255,255,255,.08);
      }
    }
    @media (max-width: 520px){
      .row2{grid-template-columns:1fr;}
      .topbar .sub{display:none;}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px;}
    input[type="text"], select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(231,238,247,.42)}
    input[type="text"]:focus, select:focus{
      border-color: rgba(162,222,204,.45);
      box-shadow: 0 0 0 3px rgba(162,222,204,.10);
    }

    .toggles{display:flex; gap:10px; flex-wrap:wrap;}
    .chk{
      display:flex; align-items:center; gap:8px;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      font-size:12.5px;
      color:rgba(231,238,247,.88);
    }
    .chk input{accent-color: var(--mint); cursor:pointer;}

    .actions{display:flex; gap:10px; margin-top:6px;}
    .btn{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{
      border-color: rgba(162,222,204,.38);
      background: linear-gradient(180deg, rgba(162,222,204,.14), rgba(162,222,204,.06));
      box-shadow: 0 10px 26px rgba(162,222,204,.08);
    }

    .meta{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.22);
    }
    .meta .line{
      display:flex; justify-content:space-between; gap:10px;
      font-size:12.5px;
      color:rgba(231,238,247,.85);
      margin:4px 0;
    }
    .meta b{color:rgba(162,222,204,.95)}

    .list{margin-top:10px;}
    .list h2{margin:0 0 10px;font-size:13px;color:rgba(231,238,247,.90);letter-spacing:.2px;}
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      border-color: rgba(162,222,204,.32);
      background:rgba(162,222,204,.06);
    }
    .item .t{font-weight:900;font-size:13.7px;line-height:1.25}
    .item .s{color:rgba(231,238,247,.70);font-size:12.5px;margin-top:6px;line-height:1.25}
    .item .k{margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;}
    .tag{
      font-size:11.5px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(231,238,247,.78);
      background:rgba(0,0,0,.18);
    }
    .tag.mint{
      border-color: rgba(162,222,204,.30);
      color: rgba(162,222,204,.95);
      background: rgba(162,222,204,.08);
    }

    .loading{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(3px);
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .loading.show{opacity:1; pointer-events:auto;}
    .loading .box{
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,19,24,.72);
      box-shadow: var(--shadow);
      font-size:13px;
      color:rgba(231,238,247,.9);
    }
    .loading .box b{color:rgba(162,222,204,.95)}

    .toast{
      position:fixed;
      left:16px; bottom:16px;
      max-width:min(560px, calc(100% - 32px));
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,12,14,.88);
      color:rgba(231,238,247,.92);
      box-shadow: var(--shadow);
      z-index:2000;
      display:none;
      line-height:1.35;
      font-size:12.8px;
    }
    .toast.show{display:block;}
    .toast .bad{color:var(--danger); font-weight:900}

    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
      padding:18px;
    }
    .modal.show{display:flex;}
    .modal .card{
      width:min(900px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.22)),
                 rgba(15,19,24,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .head{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modal .head .title{font-size:15px; font-weight:900; line-height:1.25;}
    .modal .head .sub{margin-top:6px;color:rgba(231,238,247,.70);font-size:12.5px;line-height:1.25}
    .modal .close{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(231,238,247,.9);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modal .body{
      padding:14px 16px 16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 780px){
      .modal .body{grid-template-columns:1fr}
    }
    .kv{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      border-radius:14px;
      padding:12px;
    }
    .kv .k{font-size:12px;color:rgba(231,238,247,.65);margin-bottom:6px}
    .kv .v{font-size:13px;color:rgba(231,238,247,.92);line-height:1.35;word-break:break-word}

    .mMedia{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      border-radius:14px;
      overflow:hidden;
    }
    .mMedia .ph{
      position:relative;
      aspect-ratio: 16 / 9;
      background:rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(231,238,247,.55);
      font-size:12.5px;
    }
    .mMedia img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .mMedia .cap{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12.5px;
      color:rgba(231,238,247,.85);
    }
    .mMedia .cap b{color:rgba(162,222,204,.95)}

    .modal .foot{
      padding:12px 16px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .modal .foot a{
      text-decoration:none;
      border:1px solid rgba(162,222,204,.30);
      background:rgba(162,222,204,.07);
      color:rgba(162,222,204,.95);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:12.5px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="left">
        <div class="title">Frontier DOOH 전국 DB</div>
        <div class="sub" id="dataUrlLabel">—</div>
      </div>
      <div class="pill" id="pillStatus">Loading…</div>
    </div>

    <div class="main">
      <aside class="panel">
        <div class="section">
          <div class="grid">
            <div>
              <label>검색 (이름 / 지역 / 주소 / 카테고리 / ID)</label>
              <input id="q" type="text" placeholder="예: 강남, 삼성역, 명동, 전광판, 36936…" />
            </div>

            <div class="row2">
              <div>
                <label>카테고리(상위)</label>
                <select id="catParent">
                  <option value="">전체</option>
                </select>
              </div>
              <div>
                <label>카테고리(하위)</label>
                <select id="catChild">
                  <option value="">전체</option>
                </select>
              </div>
            </div>

            <div class="row2">
              <div>
                <label>지역(시/도)</label>
                <select id="city">
                  <option value="">전체</option>
                </select>
              </div>
              <div>
                <label>구/군</label>
                <select id="district">
                  <option value="">전체</option>
                </select>
              </div>
            </div>

            <div class="toggles">
              <label class="chk" title="대한민국 bbox 밖 좌표를 기본 제외합니다.">
                <input id="onlyKorea" type="checkbox" checked />
                이상치 제외(한국 밖)
              </label>
              <label class="chk" title="가격 정보 있는 매체만 보고 싶을 때">
                <input id="onlyHasPrice" type="checkbox" />
                가격 있는 것만
              </label>
            </div>

            <div class="actions">
              <button class="btn primary" id="apply">적용</button>
              <button class="btn" id="reset">초기화</button>
            </div>

            <div class="meta">
              <div class="line"><span>전체 로드</span><span><b id="totalCount">—</b></span></div>
              <div class="line"><span>현재 표시</span><span><b id="shownCount">—</b></span></div>
            </div>
          </div>
        </div>

        <div class="section list">
          <h2>리스트 (최대 200개 표시)</h2>
          <div id="list"></div>
        </div>
      </aside>

      <div class="resizer" id="resizer" title="드래그해서 패널 폭 조절"></div>

      <main class="map-wrap">
        <div id="map"></div>
        <div class="loading" id="loading">
          <div class="box">데이터 로딩 중… <b id="loadingNote"></b></div>
        </div>
      </main>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="modal">
    <div class="card" role="dialog" aria-modal="true">
      <div class="head">
        <div>
          <div class="title" id="mTitle">—</div>
          <div class="sub" id="mSub">—</div>
        </div>
        <button class="close" id="mClose">닫기</button>
      </div>

      <div class="body">
        <div id="mBody"></div>

        <div class="mMedia">
          <div class="ph" id="mImgWrap">
            <span id="mImgPh">이미지 없음</span>
          </div>
          <div class="cap">
            <span>가격: <b id="mPrice">—</b></span>
            <span>상품: <b id="mProduct">—</b></span>
          </div>
        </div>
      </div>

      <div class="foot" id="mFoot"></div>
    </div>
  </div>

  <script>
    // ==============================
    // Single-File Map App (House of OOH compatible)
    // - Filters: category parent/child, city/district, text, hasPrice
    // - Modal: image + fee + product + links
    // ==============================

    // ✅ 데이터 파일 경로 (같은 repo 루트에 있는 JSON)
    const DATA_URL = "./data_house_kor_single_fixed_merged.json";

    // Korea bbox (대략)
    const KOREA_BBOX = { minLat: 33.0, maxLat: 39.8, minLng: 124.0, maxLng: 132.0 };

    let raw = [];
    let filtered = [];
    let map = null;
    let tileLayer = null;
    let cluster = null;

    const $ = (id) => document.getElementById(id);
    const ui = {
      pillStatus: $("pillStatus"),
      q: $("q"),
      catParent: $("catParent"),
      catChild: $("catChild"),
      city: $("city"),
      district: $("district"),
      onlyKorea: $("onlyKorea"),
      onlyHasPrice: $("onlyHasPrice"),
      apply: $("apply"),
      reset: $("reset"),
      totalCount: $("totalCount"),
      shownCount: $("shownCount"),
      list: $("list"),
      dataUrlLabel: $("dataUrlLabel"),
      loading: $("loading"),
      loadingNote: $("loadingNote"),
      toast: $("toast"),

      modal: $("modal"),
      mTitle: $("mTitle"),
      mSub: $("mSub"),
      mBody: $("mBody"),
      mFoot: $("mFoot"),
      mClose: $("mClose"),

      mImgWrap: $("mImgWrap"),
      mImgPh: $("mImgPh"),
      mPrice: $("mPrice"),
      mProduct: $("mProduct"),

      resizer: $("resizer"),
    };

    ui.dataUrlLabel.textContent = DATA_URL;

    function showLoading(note=""){
      ui.loadingNote.textContent = note ? `(${note})` : "";
      ui.loading.classList.add("show");
    }
    function hideLoading(){
      ui.loading.classList.remove("show");
      ui.loadingNote.textContent = "";
    }

    let toastTimer = null;
    function toast(html, ms=5200){
      ui.toast.innerHTML = html;
      ui.toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => ui.toast.classList.remove("show"), ms);
    }

    function safeText(v){
      if (v === null || v === undefined) return "";
      return String(v);
    }
    function normStr(v){
      return safeText(v).replace(/\u00A0/g, " ").replace(/\s+/g, " ").trim();
    }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeLatLngFromHouse(item){
      // House of OOH: item.location.lat / item.location.lon
      const lat = item?.location?.lat;
      const lng = item?.location?.lon;
      let la = Number(lat);
      let ln = Number(lng);
      if (!Number.isFinite(la) || !Number.isFinite(ln)) return null;
      if (la < -90 || la > 90 || ln < -180 || ln > 180) return null;
      return { lat: la, lng: ln };
    }

    function inKorea(lat, lng){
      return lat >= KOREA_BBOX.minLat && lat <= KOREA_BBOX.maxLat &&
             lng >= KOREA_BBOX.minLng && lng <= KOREA_BBOX.maxLng;
    }

    function buildOptions(selectEl, values){
      const current = selectEl.value;
      selectEl.innerHTML = '<option value="">전체</option>';
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
      if ([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
    }

    function waitForNonZeroSize(el, maxFrames = 140){
      return new Promise((resolve) => {
        let frames = 0;
        function tick(){
          const r = el.getBoundingClientRect();
          if (r.width > 10 && r.height > 10) return resolve(true);
          frames++;
          if (frames >= maxFrames) return resolve(false);
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      });
    }

    let resizeRAF = 0;
    function safeInvalidate(){
      if (!map) return;
      cancelAnimationFrame(resizeRAF);
      resizeRAF = requestAnimationFrame(() => {
        try { map.invalidateSize({ animate:false }); } catch(e){}
      });
      setTimeout(() => {
        if (!map) return;
        try { map.invalidateSize({ animate:false }); } catch(e){}
      }, 180);
    }

    // ==============================
    // ✅ COMPAT LAYER (House JSON -> App fields)
    // ==============================
    function compat(item){
      // title
      const name = normStr(item.name);
      const second = normStr(item.second_name);
      const building = normStr(item.building_name);
      const title = name || building || "(no name)";

      // subtitle
      const parentKor = normStr(item.parent_category_code_kor);
      const childKor = normStr(item.category_code_kor);
      const city = normStr(item.city);
      const district = normStr(item.district);
      const subtitleParts = [];
      if (second) subtitleParts.push(second);
      if (building && building !== title) subtitleParts.push(building);
      const subtitle = subtitleParts.join(" · ");

      // categories
      const catParent = parentKor || normStr(item.parent_category_code) || "";
      const catChild = childKor || normStr(item.category_code) || "";

      // location
      const ll = normalizeLatLngFromHouse(item);
      const lat = ll ? ll.lat : null;
      const lng = ll ? ll.lng : null;

      // price / product
      const fee = item.advertisement_fee;
      const feeCur = normStr(item.advertisement_fee_currency) || "KRW";
      const product = normStr(item.product_display_name);
      const exposure = normStr(item.exposure_type); // INSIDE/OUTSIDE
      const oohType = normStr(item.ooh_type); // DOOH/OOH
      const fixedMoving = normStr(item.fixed_moving_type);

      // image
      const image = normStr(item.image);

      // id
      const id = safeText(item.media_item_id || item.id || "");

      // address
      const address = normStr(item.address);

      // labels
      const labels = Array.isArray(item.labels) ? item.labels.map(normStr).filter(Boolean) : [];

      // search haystack
      const hay = [
        id, title, subtitle, address,
        catParent, catChild, city, district,
        labels.join(" "),
        product, oohType, exposure, fixedMoving
      ].map(safeText).join(" ");

      return {
        __raw: item,

        // app fields
        id,
        title,
        subtitle,
        address,
        city,
        district,
        catParent,
        catChild,
        lat,
        lng,
        image,
        fee,
        feeCur,
        product,
        exposure,
        oohType,
        fixedMoving,
        labels,

        __inKorea: (lat !== null && lng !== null) ? inKorea(lat, lng) : false,
        __haystack: hay,
      };
    }

    function formatKRW(n){
      const num = Number(n);
      if (!Number.isFinite(num)) return "";
      try{
        return new Intl.NumberFormat("ko-KR").format(num);
      } catch(e){
        return String(num);
      }
    }

    async function initMap(){
      const start = Date.now();
      while (!(window.L && window.L.map && window.L.markerClusterGroup)) {
        await new Promise(r => setTimeout(r, 20));
        if (Date.now() - start > 6500) {
          toast(`<span class="bad">Leaflet 로딩 실패</span><br/>CDN 차단/네트워크 문제일 수 있습니다.`);
          break;
        }
      }

      const mapEl = $("map");
      await waitForNonZeroSize(mapEl, 180);

      map = L.map("map", {
        zoomControl: true,
        preferCanvas: true,
        worldCopyJump: true,
        inertia: true,
      });

      tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors',
        updateWhenIdle: true,
        keepBuffer: 4
      }).addTo(map);

      cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        chunkedLoading: true,
        chunkInterval: 120,
      });
      map.addLayer(cluster);

      map.setView([36.5, 127.8], 7);

      const wrap = document.querySelector(".map-wrap");
      if (window.ResizeObserver && wrap){
        const ro = new ResizeObserver(() => safeInvalidate());
        ro.observe(wrap);
      } else {
        window.addEventListener("resize", () => safeInvalidate(), { passive:true });
      }

      document.addEventListener("visibilitychange", () => { if (!document.hidden) safeInvalidate(); });
      window.addEventListener("focus", () => safeInvalidate());
    }

    function markerPopupHTML(it){
      const title = safeText(it.title);
      const sub = safeText(it.subtitle);
      const addr = safeText(it.address);
      const p = safeText(it.catParent);
      const c = safeText(it.catChild);

      const fee = (it.fee !== null && it.fee !== undefined && it.fee !== "")
        ? `${formatKRW(it.fee)} ${escapeHTML(it.feeCur || "KRW")}` : "";

      return `
        <div style="min-width:240px;line-height:1.35">
          <div style="font-weight:900;margin-bottom:6px">${escapeHTML(title)}</div>
          ${sub ? `<div style="opacity:.85;margin-bottom:8px">${escapeHTML(sub)}</div>` : ""}
          ${addr ? `<div style="opacity:.85;margin-bottom:8px">${escapeHTML(addr)}</div>` : ""}
          <div style="font-size:12px;opacity:.86">
            ${p ? `<span>분류: <b>${escapeHTML(p)}</b></span><br/>` : ""}
            ${c ? `<span>세부: <b>${escapeHTML(c)}</b></span><br/>` : ""}
            ${fee ? `<span>가격: <b style="color:rgba(162,222,204,.95)">${fee}</b></span>` : ""}
          </div>
        </div>
      `;
    }

    function buildMarker(it){
      if (it.lat === null || it.lng === null) return null;
      const m = L.marker([it.lat, it.lng], { title: safeText(it.title) });
      m.bindPopup(markerPopupHTML(it), { maxWidth: 420 });
      m.on("click", () => openModal(it));
      return m;
    }

    function openModal(it){
      ui.mTitle.textContent = safeText(it.title || "—");
      ui.mSub.textContent = safeText(it.subtitle || "");

      // left column KV
      const rows = [
        ["media_item_id", it.id],
        ["상위카테고리", it.catParent],
        ["하위카테고리", it.catChild],
        ["도시", it.city],
        ["구/군", it.district],
        ["주소", it.address],
        ["ooh_type", it.oohType],
        ["exposure_type", it.exposure],
        ["fixed/moving", it.fixedMoving],
        ["lat", it.lat],
        ["lng", it.lng],
        ["labels", (it.labels && it.labels.length) ? it.labels.join(", ") : ""],
      ];
      ui.mBody.innerHTML = rows.map(([k,v]) => {
        const val = (v === null || v === undefined || v === "") ? "—" : escapeHTML(String(v));
        return `
          <div class="kv">
            <div class="k">${escapeHTML(k)}</div>
            <div class="v">${val}</div>
          </div>
        `;
      }).join("");

      // right image
      ui.mImgWrap.innerHTML = "";
      if (it.image){
        const img = document.createElement("img");
        img.src = it.image;
        img.alt = it.title || "image";
        img.loading = "lazy";
        img.referrerPolicy = "no-referrer";
        img.onerror = () => {
          ui.mImgWrap.innerHTML = `<div class="ph"><span>이미지 로드 실패</span></div>`;
        };
        ui.mImgWrap.appendChild(img);
      } else {
        ui.mImgWrap.innerHTML = `<div class="ph"><span>이미지 없음</span></div>`;
      }

      // price/product
      if (it.fee !== null && it.fee !== undefined && it.fee !== ""){
        ui.mPrice.textContent = `${formatKRW(it.fee)} ${it.feeCur || "KRW"}`;
      } else {
        ui.mPrice.textContent = "—";
      }
      ui.mProduct.textContent = it.product ? it.product : "—";

      // footer links
      const lat = Number(it.lat);
      const lng = Number(it.lng);
      const q = encodeURIComponent(safeText(it.title || "Frontier DOOH"));

      const kakao = (Number.isFinite(lat) && Number.isFinite(lng))
        ? `https://map.kakao.com/link/map/${q},${lat},${lng}` : null;
      const google = (Number.isFinite(lat) && Number.isFinite(lng))
        ? `https://www.google.com/maps?q=${lat},${lng}` : null;

      const links = [];
      if (kakao) links.push(`<a href="${kakao}" target="_blank" rel="noopener">카카오맵 열기</a>`);
      if (google) links.push(`<a href="${google}" target="_blank" rel="noopener">구글맵 열기</a>`);

      ui.mFoot.innerHTML = links.join("");
      ui.modal.classList.add("show");
    }

    function closeModal(){ ui.modal.classList.remove("show"); }
    ui.mClose.addEventListener("click", closeModal);
    ui.modal.addEventListener("click", (e) => { if (e.target === ui.modal) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    function fillDropdowns(items){
      const parents = new Set();
      const childs = new Set();
      const cities = new Set();
      const districts = new Set();

      for (const it of items){
        if (it.catParent) parents.add(it.catParent);
        if (it.catChild) childs.add(it.catChild);
        if (it.city) cities.add(it.city);
        if (it.district) districts.add(it.district);
      }

      buildOptions(ui.catParent, [...parents].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.catChild, [...childs].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.city, [...cities].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.district, [...districts].sort((a,b)=>a.localeCompare(b,"ko")));
    }

    function applyFilters(){
      const q = normStr(ui.q.value).toLowerCase();
      const p = normStr(ui.catParent.value);
      const c = normStr(ui.catChild.value);
      const city = normStr(ui.city.value);
      const dist = normStr(ui.district.value);
      const onlyK = ui.onlyKorea.checked;
      const hasPrice = ui.onlyHasPrice.checked;

      filtered = raw.filter(it => {
        if (p && it.catParent !== p) return false;
        if (c && it.catChild !== c) return false;
        if (city && it.city !== city) return false;
        if (dist && it.district !== dist) return false;

        if (hasPrice){
          const fee = Number(it.fee);
          if (!Number.isFinite(fee) || fee <= 0) return false;
        }

        if (q){
          const hay = (it.__haystack || "").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (onlyK){
          if (it.lat === null || it.lng === null) return false;
          if (!inKorea(it.lat, it.lng)) return false;
        }

        return true;
      });

      renderMapMarkers(filtered);
      renderList(filtered);

      ui.shownCount.textContent = String(filtered.length);
      safeInvalidate();
    }

    function renderMapMarkers(items){
      if (!map || !cluster) return;

      cluster.clearLayers();

      const markers = [];
      let valid = 0;
      let koreaValid = 0;

      for (const it of items){
        const m = buildMarker(it);
        if (!m) continue;
        valid++;
        if (it.__inKorea) koreaValid++;
        markers.push(m);
      }

      if (markers.length) cluster.addLayers(markers);

      if (markers.length){
        const preferK = (koreaValid >= 10 && koreaValid / Math.max(valid,1) >= 0.7);
        if (ui.onlyKorea.checked || preferK){
          const sw = L.latLng(KOREA_BBOX.minLat, KOREA_BBOX.minLng);
          const ne = L.latLng(KOREA_BBOX.maxLat, KOREA_BBOX.maxLng);
          map.fitBounds(L.latLngBounds(sw, ne), { padding:[28,28], animate:false });
        } else {
          try{
            const b = cluster.getBounds();
            if (b && b.isValid()) map.fitBounds(b, { padding:[28,28], animate:false });
          } catch(e){}
        }
      } else {
        map.setView([36.5, 127.8], 7);
      }

      setTimeout(() => safeInvalidate(), 80);
    }

    function renderList(items){
      const max = 200;
      const show = items.slice(0, max);

      if (!show.length){
        ui.list.innerHTML = `<div style="color:rgba(231,238,247,.65);font-size:12.8px;line-height:1.45">
          조건에 맞는 항목이 없습니다.<br/>필터를 완화하거나 검색어를 지워보세요.
        </div>`;
        return;
      }

      ui.list.innerHTML = show.map(it => {
        const title = escapeHTML(safeText(it.title || "—"));
        const sub = escapeHTML(safeText(it.subtitle || ""));
        const addr = escapeHTML(safeText(it.address || ""));
        const p = escapeHTML(safeText(it.catParent || ""));
        const c = escapeHTML(safeText(it.catChild || ""));
        const fee = (it.fee !== null && it.fee !== undefined && it.fee !== "")
          ? `${formatKRW(it.fee)} ${escapeHTML(it.feeCur || "KRW")}` : "";

        return `
          <div class="item" data-id="${escapeHTML(safeText(it.id || ""))}">
            <div class="t">${title}</div>
            <div class="s">${sub ? sub + "<br/>" : ""}${addr}</div>
            <div class="k">
              ${p ? `<span class="tag mint">${p}</span>` : ""}
              ${c ? `<span class="tag">${c}</span>` : ""}
              ${fee ? `<span class="tag">₩ ${fee}</span>` : ""}
              ${it.city ? `<span class="tag">${escapeHTML(it.city)}</span>` : ""}
              ${it.district ? `<span class="tag">${escapeHTML(it.district)}</span>` : ""}
            </div>
          </div>
        `;
      }).join("");

      ui.list.querySelectorAll(".item").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const it = raw.find(x => safeText(x.id) === id) || items.find(x => safeText(x.id) === id);
          if (!it) return;

          if (it.lat !== null && it.lng !== null && map){
            map.setView([it.lat, it.lng], Math.max(map.getZoom(), 14), { animate:false });
            setTimeout(() => safeInvalidate(), 60);
          }
          openModal(it);
        });
      });
    }

    async function loadData(){
      showLoading("JSON fetch");
      ui.pillStatus.textContent = "Loading…";

      try{
        const res = await fetch(DATA_URL, { cache:"no-store" });
        if (!res.ok){
          hideLoading();
          ui.pillStatus.textContent = "Data Error";
          toast(`<span class="bad">데이터 로드 실패</span><br/>HTTP ${res.status}<br/>경로: <b>${escapeHTML(DATA_URL)}</b>`);
          return;
        }

        const json = await res.json();
        const items = Array.isArray(json) ? json : (json.items || (json.data && json.data.items) || []);

        const arr = Array.isArray(items) ? items : [];
        raw = arr.map(compat);

        fillDropdowns(raw);

        ui.totalCount.textContent = String(raw.length);
        ui.pillStatus.textContent = `Loaded: ${raw.length}`;

        applyFilters();
        hideLoading();

      } catch(err){
        hideLoading();
        ui.pillStatus.textContent = "Data Error";
        toast(`<span class="bad">JSON 오류</span><br/>${escapeHTML(err?.message || String(err))}`);
      }
    }

    function resetUI(){
      ui.q.value = "";
      ui.catParent.value = "";
      ui.catChild.value = "";
      ui.city.value = "";
      ui.district.value = "";
      ui.onlyKorea.checked = true;
      ui.onlyHasPrice.checked = false;
      applyFilters();
    }

    // Auto apply
    ui.catParent.addEventListener("change", applyFilters);
    ui.catChild.addEventListener("change", applyFilters);
    ui.city.addEventListener("change", applyFilters);
    ui.district.addEventListener("change", applyFilters);
    ui.onlyKorea.addEventListener("change", applyFilters);
    ui.onlyHasPrice.addEventListener("change", applyFilters);

    let qTimer = null;
    ui.q.addEventListener("input", () => {
      clearTimeout(qTimer);
      qTimer = setTimeout(applyFilters, 160);
    });

    ui.apply.addEventListener("click", applyFilters);
    ui.reset.addEventListener("click", resetUI);

    // Panel resize
    (function initResizer(){
      let dragging = false;

      function setW(px){
        const min = 360;
        const max = Math.min(820, Math.floor(window.innerWidth * 0.65));
        const w = Math.max(min, Math.min(max, px));
        document.documentElement.style.setProperty("--panelW", w + "px");
        setTimeout(() => safeInvalidate(), 60);
      }

      ui.resizer.addEventListener("mousedown", () => {
        dragging = true;
        document.body.style.userSelect = "none";
      });
      window.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        setW(e.clientX);
      }, { passive:true });
      window.addEventListener("mouseup", () => {
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = "";
      });

      ui.resizer.addEventListener("touchstart", () => { dragging = true; }, { passive:true });
      window.addEventListener("touchmove", (e) => {
        if (!dragging) return;
        const t = e.touches && e.touches[0];
        if (!t) return;
        setW(t.clientX);
      }, { passive:true });
      window.addEventListener("touchend", () => { dragging = false; }, { passive:true });
    })();

    // Boot
    (async function boot(){
      showLoading("init");
      await initMap();
      await loadData();
      hideLoading();
      setTimeout(() => safeInvalidate(), 220);
    })();
  </script>
</body>
</html>
