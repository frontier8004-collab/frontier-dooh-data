<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Frontier DOOH Map (House KOR Fixed - Wide + Frontier Taxonomy)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    :root{
      --bg:#07090c;
      --panel:#0c1016;
      --panel2:#0f141c;
      --line:rgba(255,255,255,.10);
      --mint:#a2decc;
      --text:#e7eef7;
      --muted:rgba(231,238,247,.68);
      --danger:#ff6b6b;
      --shadow:0 18px 48px rgba(0,0,0,.55);
      --radius:14px;

      /* ✅ 기본 패널 폭(조금 더 넓게) */
      --panelW: 600px;
      --gutter: 14px;
      --topbarH: 58px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,NanumGothic,sans-serif}
    a{color:inherit}

    .shell{
      height:100vh;
      width:100vw;
      overflow:hidden;
      background:
        radial-gradient(1100px 600px at 20% 10%, rgba(162,222,204,.12), transparent 60%),
        radial-gradient(1000px 700px at 90% 30%, rgba(162,222,204,.10), transparent 65%),
        var(--bg);
    }

    .topbar{
      height:var(--topbarH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(8px);
    }
    .topbar .left{
      display:flex; align-items:baseline; gap:10px;
      min-width:0;
    }
    .topbar .title{
      font-weight:900;
      letter-spacing:.2px;
      font-size:15px;
      white-space:nowrap;
    }
    .topbar .sub{
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:52vw;
    }
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(162,222,204,.35);
      color:rgba(162,222,204,.95);
      background:rgba(162,222,204,.07);
      white-space:nowrap;
    }

    .main{
      height:calc(100vh - var(--topbarH));
      display:grid;
      grid-template-columns: var(--panelW) 10px 1fr;
      min-height:0;
    }

    .panel{
      min-height:0;
      overflow:auto;
      padding:16px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.03), transparent 50%),
        var(--panel);
      border-right:1px solid rgba(255,255,255,.08);
    }

    .resizer{
      cursor: col-resize;
      background:rgba(255,255,255,.04);
      border-right:1px solid rgba(255,255,255,.08);
      border-left:1px solid rgba(255,255,255,.08);
      position:relative;
    }
    .resizer:before{
      content:"";
      position:absolute;
      left:50%; top:50%;
      width:3px; height:42px;
      border-radius:999px;
      transform:translate(-50%,-50%);
      background:rgba(162,222,204,.28);
      box-shadow:0 0 0 6px rgba(162,222,204,.05);
    }

    .map-wrap{
      min-height:0;
      position:relative;
      overflow:hidden;
      background:#050607;
    }
    #map{height:100%; width:100%; background:#050607;}

    .section{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
      margin-bottom:12px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .main{grid-template-columns: 1fr; grid-template-rows: auto 1fr;}
      .resizer{display:none;}
      .panel{
        border-right:none;
        border-bottom:1px solid rgba(255,255,255,.08);
      }
    }
    @media (max-width: 520px){
      .row2{grid-template-columns:1fr;}
      .topbar .sub{display:none;}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 2px;
    }
    input[type="text"], select{
      width:100%;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    input[type="text"]::placeholder{color:rgba(231,238,247,.42)}
    input[type="text"]:focus, select:focus{
      border-color: rgba(162,222,204,.45);
      box-shadow: 0 0 0 3px rgba(162,222,204,.10);
    }

    .toggles{display:flex; gap:10px; flex-wrap:wrap;}
    .chk{
      display:flex; align-items:center; gap:8px;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      font-size:12.5px;
      color:rgba(231,238,247,.88);
    }
    .chk input{accent-color: var(--mint); cursor:pointer;}

    .actions{display:flex; gap:10px; margin-top:6px;}
    .btn{
      flex:1;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .btn.primary{
      border-color: rgba(162,222,204,.38);
      background: linear-gradient(180deg, rgba(162,222,204,.14), rgba(162,222,204,.06));
      box-shadow: 0 10px 26px rgba(162,222,204,.08);
    }

    .meta{
      margin-top:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.22);
    }
    .meta .line{
      display:flex; justify-content:space-between; gap:10px;
      font-size:12.5px;
      color:rgba(231,238,247,.85);
      margin:4px 0;
    }
    .meta b{color:rgba(162,222,204,.95)}

    .list{
      margin-top:10px;
    }
    .list h2{
      margin:0 0 10px;
      font-size:13px;
      color:rgba(231,238,247,.90);
      letter-spacing:.2px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .item:hover{
      transform: translateY(-1px);
      border-color: rgba(162,222,204,.32);
      background:rgba(162,222,204,.06);
    }
    .item .t{font-weight:900;font-size:13.7px;line-height:1.25}
    .item .s{color:rgba(231,238,247,.70);font-size:12.5px;margin-top:6px;line-height:1.25}
    .item .k{margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;}
    .tag{
      font-size:11.5px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:rgba(231,238,247,.78);
      background:rgba(0,0,0,.18);
    }
    .tag.mint{
      border-color: rgba(162,222,204,.30);
      color: rgba(162,222,204,.95);
      background: rgba(162,222,204,.08);
    }

    .loading{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(3px);
      z-index:999;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .loading.show{opacity:1; pointer-events:auto;}
    .loading .box{
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,19,24,.72);
      box-shadow: var(--shadow);
      font-size:13px;
      color:rgba(231,238,247,.9);
    }
    .loading .box b{color:rgba(162,222,204,.95)}

    .toast{
      position:fixed;
      left:16px; bottom:16px;
      max-width:min(560px, calc(100% - 32px));
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,12,14,.88);
      color:rgba(231,238,247,.92);
      box-shadow: var(--shadow);
      z-index:2000;
      display:none;
      line-height:1.35;
      font-size:12.8px;
    }
    .toast.show{display:block;}
    .toast .bad{color:var(--danger); font-weight:900}

    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:3000;
      padding:18px;
    }
    .modal.show{display:flex;}
    .modal .card{
      width:min(920px, 100%);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.22)),
                 rgba(15,19,24,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal .head{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modal .head .title{font-size:15px; font-weight:900; line-height:1.25;}
    .modal .head .sub{margin-top:6px;color:rgba(231,238,247,.70);font-size:12.5px;line-height:1.25}
    .modal .close{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:rgba(231,238,247,.9);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:900;
    }
    .modal .body{
      padding:14px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 720px){
      .modal .body{grid-template-columns:1fr}
    }
    .kv{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      border-radius:14px;
      padding:12px;
    }
    .kv .k{font-size:12px;color:rgba(231,238,247,.65);margin-bottom:6px}
    .kv .v{font-size:13px;color:rgba(231,238,247,.92);line-height:1.35;word-break:break-word}
    .modal .foot{
      padding:12px 16px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .modal .foot a{
      text-decoration:none;
      border:1px solid rgba(162,222,204,.30);
      background:rgba(162,222,204,.07);
      color:rgba(162,222,204,.95);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:12.5px;
    }
  </style>
</head>

<body>
  <div class="shell">
    <div class="topbar">
      <div class="left">
        <div class="title">Frontier DOOH 전국 DB</div>
        <div class="sub" id="dataUrlLabel">—</div>
      </div>
      <div class="pill" id="pillStatus">Loading…</div>
    </div>

    <div class="main">
      <aside class="panel">
        <div class="section">
          <div class="grid">
            <div>
              <label>검색 (name/title/address/city/district/id/labels)</label>
              <input id="q" type="text" placeholder="예: 강남, 삼성역, 명동, COEX, 36936…" />
            </div>

            <!-- ✅ Frontier 세부분류 -->
            <div class="row2">
              <div>
                <label>Frontier 분류</label>
                <select id="frontierGroup">
                  <option value="">전체</option>
                </select>
              </div>
              <div>
                <label>노출(Inside/Outside)</label>
                <select id="exposureType">
                  <option value="">전체</option>
                </select>
              </div>
            </div>

            <!-- ✅ House 원본 분류(Parent/Category) -->
            <div class="row2">
              <div>
                <label>대분류(Parent)</label>
                <select id="parentKor">
                  <option value="">전체</option>
                </select>
              </div>
              <div>
                <label>중분류(Category)</label>
                <select id="catKor">
                  <option value="">전체</option>
                </select>
              </div>
            </div>

            <!-- ✅ 지역/유형 -->
            <div class="row2">
              <div>
                <label>City</label>
                <select id="city">
                  <option value="">전체</option>
                </select>
              </div>
              <div>
                <label>District</label>
                <select id="district">
                  <option value="">전체</option>
                </select>
              </div>
            </div>

            <div class="row2">
              <div>
                <label>유형 (DOOH/OOH)</label>
                <select id="oohType">
                  <option value="">전체</option>
                </select>
              </div>
              <div>
                <label>판매 (SINGLE/GROUP)</label>
                <select id="salesType">
                  <option value="">전체</option>
                </select>
              </div>
            </div>

            <div class="toggles">
              <label class="chk" title="대한민국(대략 bbox) 밖 좌표를 기본 제외합니다.">
                <input id="onlyKorea" type="checkbox" checked />
                이상치 제외(한국 밖)
              </label>
            </div>

            <div class="actions">
              <button class="btn primary" id="apply">적용</button>
              <button class="btn" id="reset">초기화</button>
            </div>

            <div class="meta">
              <div class="line"><span>전체 로드</span><span><b id="totalCount">—</b></span></div>
              <div class="line"><span>현재 표시</span><span><b id="shownCount">—</b></span></div>
            </div>
          </div>
        </div>

        <div class="section list">
          <h2>리스트 (최대 160개 표시)</h2>
          <div id="list"></div>
        </div>
      </aside>

      <div class="resizer" id="resizer" title="드래그해서 패널 폭 조절"></div>

      <main class="map-wrap">
        <div id="map"></div>
        <div class="loading" id="loading">
          <div class="box">데이터 로딩 중… <b id="loadingNote"></b></div>
        </div>
      </main>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="modal" id="modal">
    <div class="card" role="dialog" aria-modal="true">
      <div class="head">
        <div>
          <div class="title" id="mTitle">—</div>
          <div class="sub" id="mSub">—</div>
        </div>
        <button class="close" id="mClose">닫기</button>
      </div>
      <div class="body" id="mBody"></div>
      <div class="foot" id="mFoot"></div>
    </div>
  </div>

  <script>
    // ==============================
    // Stable Single-File Map App
    // - House data compatible (location.{lat,lon} or lat/lng)
    // - Frontier derived taxonomy (frontierGroup)
    // ==============================

    const DATA_URL = "./data_house_kor_single_fixed_merged.json";

    // Korea bbox (대략)
    const KOREA_BBOX = { minLat: 33.0, maxLat: 39.8, minLng: 124.0, maxLng: 132.0 };

    let raw = [];
    let filtered = [];
    let map = null;
    let tileLayer = null;
    let cluster = null;

    const $ = (id) => document.getElementById(id);
    const ui = {
      pillStatus: $("pillStatus"),
      q: $("q"),

      frontierGroup: $("frontierGroup"),
      exposureType: $("exposureType"),
      parentKor: $("parentKor"),
      catKor: $("catKor"),
      city: $("city"),
      district: $("district"),
      oohType: $("oohType"),
      salesType: $("salesType"),

      onlyKorea: $("onlyKorea"),
      apply: $("apply"),
      reset: $("reset"),

      totalCount: $("totalCount"),
      shownCount: $("shownCount"),
      list: $("list"),
      dataUrlLabel: $("dataUrlLabel"),
      loading: $("loading"),
      loadingNote: $("loadingNote"),
      toast: $("toast"),

      modal: $("modal"),
      mTitle: $("mTitle"),
      mSub: $("mSub"),
      mBody: $("mBody"),
      mFoot: $("mFoot"),
      mClose: $("mClose"),

      resizer: $("resizer"),
    };

    ui.dataUrlLabel.textContent = DATA_URL;

    function showLoading(note=""){
      ui.loadingNote.textContent = note ? `(${note})` : "";
      ui.loading.classList.add("show");
    }
    function hideLoading(){
      ui.loading.classList.remove("show");
      ui.loadingNote.textContent = "";
    }

    let toastTimer = null;
    function toast(html, ms=5200){
      ui.toast.innerHTML = html;
      ui.toast.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => ui.toast.classList.remove("show"), ms);
    }

    function safeText(v){
      if (v === null || v === undefined) return "";
      return String(v);
    }
    function normStr(v){
      return safeText(v)
        .replace(/\u00A0/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }
    function escapeHTML(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function normalizeLatLng(lat, lng){
      let la = Number(lat);
      let ln = Number(lng);
      if (!Number.isFinite(la) || !Number.isFinite(ln)) return null;

      // (가끔 lat/lng 뒤집힌 데이터 방어)
      if (Math.abs(la) > 90 && Math.abs(ln) <= 90){
        const tmp = la; la = ln; ln = tmp;
      }
      if (la < -90 || la > 90 || ln < -180 || ln > 180) return null;
      return { lat: la, lng: ln };
    }

    function pickLatLng(it){
      // House: location.lon/lat
      const lat = it.lat ?? it.latitude ?? it.location?.lat ?? it.location?.latitude;
      const lng = it.lng ?? it.lon ?? it.longitude ?? it.location?.lng ?? it.location?.lon ?? it.location?.longitude;
      return normalizeLatLng(lat, lng);
    }

    function inKorea(lat, lng){
      return lat >= KOREA_BBOX.minLat && lat <= KOREA_BBOX.maxLat &&
             lng >= KOREA_BBOX.minLng && lng <= KOREA_BBOX.maxLng;
    }

    function buildOptions(selectEl, values){
      const current = selectEl.value;
      selectEl.innerHTML = '<option value="">전체</option>';
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
      if ([...selectEl.options].some(o => o.value === current)) selectEl.value = current;
    }

    function waitForNonZeroSize(el, maxFrames = 120){
      return new Promise((resolve) => {
        let frames = 0;
        function tick(){
          const r = el.getBoundingClientRect();
          if (r.width > 10 && r.height > 10) return resolve(true);
          frames++;
          if (frames >= maxFrames) return resolve(false);
          requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);
      });
    }

    let resizeRAF = 0;
    function safeInvalidate(){
      if (!map) return;
      cancelAnimationFrame(resizeRAF);
      resizeRAF = requestAnimationFrame(() => {
        try { map.invalidateSize({ animate:false }); } catch(e){}
      });
      setTimeout(() => {
        if (!map) return;
        try { map.invalidateSize({ animate:false }); } catch(e){}
      }, 180);
    }

    async function initMap(){
      const start = Date.now();
      while (!(window.L && window.L.map && window.L.markerClusterGroup)) {
        await new Promise(r => setTimeout(r, 20));
        if (Date.now() - start > 6000) {
          toast(`<span class="bad">Leaflet 로딩 실패</span><br/>CDN 차단/네트워크 문제일 수 있습니다.`);
          break;
        }
      }

      const mapEl = $("map");
      await waitForNonZeroSize(mapEl, 160);

      map = L.map("map", {
        zoomControl: true,
        preferCanvas: true,
        worldCopyJump: true,
        inertia: true,
      });

      tileLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors',
        updateWhenIdle: true,
        keepBuffer: 4
      }).addTo(map);

      cluster = L.markerClusterGroup({
        showCoverageOnHover: false,
        spiderfyOnMaxZoom: true,
        chunkedLoading: true,
        chunkInterval: 120,
      });
      map.addLayer(cluster);

      map.setView([36.5, 127.8], 7);

      map.whenReady(() => safeInvalidate());

      const wrap = document.querySelector(".map-wrap");
      if (window.ResizeObserver && wrap){
        const ro = new ResizeObserver(() => safeInvalidate());
        ro.observe(wrap);
      } else {
        window.addEventListener("resize", () => safeInvalidate(), { passive:true });
      }

      document.addEventListener("visibilitychange", () => {
        if (!document.hidden) safeInvalidate();
      });
      window.addEventListener("focus", () => safeInvalidate());
    }

    // ------------------------------
    // ✅ Frontier 세부 분류(파생)
    // ------------------------------
    function deriveFrontierGroup(it){
      const parent = normStr(it.parent_category_code_kor || it.parentCategoryKor || "");
      const cat = normStr(it.category_code_kor || it.categoryKor || "");
      const exposure = normStr(it.exposure_type || it.exposureType || ""); // INSIDE/OUTSIDE
      const oohType = normStr(it.ooh_type || it.oohType || ""); // DOOH/OOH

      // 1) 전광판/빌보드 계열
      if (parent.includes("전광판") || parent.includes("빌보드")) {
        if (cat.includes("빌보드")) return "전광판/빌보드 · 빌보드(외벽/옥상)";
        if (cat.includes("전광판") || cat.includes("전자")) return "전광판/빌보드 · 전광판(DOOH)";
        return "전광판/빌보드";
      }

      // 2) 쇼핑몰/마트
      if (parent.includes("쇼핑몰") || parent.includes("마트")) {
        if (cat.includes("쇼핑몰")) return "쇼핑몰/마트 · 복합쇼핑몰";
        if (cat.includes("마트")) return "쇼핑몰/마트 · 대형마트";
        return "쇼핑몰/마트";
      }

      // 3) 지하철/교통
      if (parent.includes("지하철")) return "교통 · 지하철";
      if (parent.includes("공항") || parent.includes("기차") || parent.includes("터미널") || parent.includes("KTX")) return "교통 · 공항/기차/터미널";

      // 4) Inside/Outside 힌트 보정
      if (exposure === "INSIDE") {
        if (cat.includes("지하철")) return "교통 · 지하철";
        if (cat.includes("공항")) return "교통 · 공항/기차/터미널";
        if (cat.includes("쇼핑")) return "쇼핑몰/마트 · 복합쇼핑몰";
        return "인도어(실내) 기타";
      }
      if (exposure === "OUTSIDE") {
        if (oohType === "DOOH") return "옥외 · DOOH(기타)";
        return "옥외 · OOH(기타)";
      }

      // fallback
      return parent || cat || (oohType ? `${oohType} 기타` : "기타");
    }

    function markerPopupHTML(it){
      const title = safeText(it.name || it.title || it.product_display_name || "");
      const sub = safeText(it.second_name || it.subtitle || "");
      const addr = safeText(it.address || "");
      const fg = safeText(it.__frontier || "");
      const city = safeText(it.__city || it.city || "");
      const dist = safeText(it.__district || it.district || "");
      const parentKor = safeText(it.__parentKor || "");
      const catKor = safeText(it.__catKor || "");

      return `
        <div style="min-width:240px;line-height:1.35">
          <div style="font-weight:900;margin-bottom:6px">${escapeHTML(title)}</div>
          ${sub ? `<div style="opacity:.85;margin-bottom:8px">${escapeHTML(sub)}</div>` : ""}
          ${addr ? `<div style="opacity:.85;margin-bottom:8px">${escapeHTML(addr)}</div>` : ""}
          <div style="font-size:12px;opacity:.85">
            ${fg ? `<span>Frontier: <b>${escapeHTML(fg)}</b></span><br/>` : ""}
            ${(parentKor || catKor) ? `<span>분류: <b>${escapeHTML(parentKor || "-")}</b> / <b>${escapeHTML(catKor || "-")}</b></span><br/>` : ""}
            ${(city || dist) ? `<span>지역: <b>${escapeHTML(city)}</b> ${dist ? `(${escapeHTML(dist)})` : ""}</span>` : ""}
          </div>
        </div>
      `;
    }

    function buildMarker(it){
      const ll = pickLatLng(it);
      if (!ll) return null;

      it.__lat = ll.lat;
      it.__lng = ll.lng;
      it.__inKorea = inKorea(ll.lat, ll.lng);

      const title = safeText(it.name || it.title || it.product_display_name || "");
      const m = L.marker([ll.lat, ll.lng], { title });
      m.bindPopup(markerPopupHTML(it), { maxWidth: 420 });
      m.on("click", () => openModal(it));
      return m;
    }

    function openModal(it){
      const title = safeText(it.name || it.title || it.product_display_name || "—");
      const sub = safeText(it.second_name || it.subtitle || "");

      ui.mTitle.textContent = title;
      ui.mSub.textContent = sub;

      const rows = [
        ["media_item_id", it.media_item_id],
        ["id", it.id],
        ["name", it.name],
        ["second_name", it.second_name],
        ["address", it.address],
        ["city", it.city],
        ["district", it.district],

        ["Frontier 분류", it.__frontier],
        ["parent_category_code_kor", it.__parentKor],
        ["category_code_kor", it.__catKor],
        ["ooh_type", it.ooh_type],
        ["exposure_type", it.exposure_type],
        ["fixed_moving_type", it.fixed_moving_type],
        ["sales_type", it.sales_type],
        ["contractual_duration", it.contractual_duration],
        ["contractual_duration_type", it.contractual_duration_type],
        ["advertisement_fee", it.advertisement_fee],
        ["advertisement_fee_currency", it.advertisement_fee_currency],

        ["lat", it.__lat],
        ["lng", it.__lng],
        ["image", it.image],
        ["labels", Array.isArray(it.labels) ? it.labels.join(", ") : ""],
        ["updated_at", it.updated_at],
        ["created_at", it.created_at],
      ];

      ui.mBody.innerHTML = rows.map(([k,v]) => {
        const val = (v === null || v === undefined || v === "") ? "—" : escapeHTML(String(v));
        return `
          <div class="kv">
            <div class="k">${escapeHTML(k)}</div>
            <div class="v">${val}</div>
          </div>
        `;
      }).join("");

      const lat = Number(it.__lat);
      const lng = Number(it.__lng);
      const q = encodeURIComponent(title);

      const kakao = (Number.isFinite(lat) && Number.isFinite(lng))
        ? `https://map.kakao.com/link/map/${q},${lat},${lng}` : null;

      const google = (Number.isFinite(lat) && Number.isFinite(lng))
        ? `https://www.google.com/maps?q=${lat},${lng}` : null;

      const links = [];
      if (kakao) links.push(`<a href="${kakao}" target="_blank" rel="noopener">카카오맵 열기</a>`);
      if (google) links.push(`<a href="${google}" target="_blank" rel="noopener">구글맵 열기</a>`);
      if (it.image) links.push(`<a href="${escapeHTML(it.image)}" target="_blank" rel="noopener">이미지 열기</a>`);

      ui.mFoot.innerHTML = links.join("");
      ui.modal.classList.add("show");
    }

    function closeModal(){ ui.modal.classList.remove("show"); }
    ui.mClose.addEventListener("click", closeModal);
    ui.modal.addEventListener("click", (e) => { if (e.target === ui.modal) closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    function preprocessItems(items){
      for (const it of items){
        it.__parentKor = normStr(it.parent_category_code_kor || it.parent_category_code || "");
        it.__catKor = normStr(it.category_code_kor || it.category_code || "");
        it.__city = normStr(it.city || "");
        it.__district = normStr(it.district || "");
        it.__exposure = normStr(it.exposure_type || "");
        it.__oohType = normStr(it.ooh_type || "");
        it.__salesType = normStr(it.sales_type || it.salesType || "");
        it.__frontier = deriveFrontierGroup(it);

        const ll = pickLatLng(it);
        it.__lat = ll?.lat ?? null;
        it.__lng = ll?.lng ?? null;
        it.__inKorea = ll ? inKorea(ll.lat, ll.lng) : false;

        const labels = Array.isArray(it.labels) ? it.labels.join(" ") : "";
        it.__haystack = [
          it.media_item_id, it.id,
          it.name, it.second_name,
          it.address, it.__city, it.__district,
          it.__frontier, it.__parentKor, it.__catKor,
          it.__oohType, it.__exposure,
          labels
        ].map(safeText).join(" ");
      }
    }

    function fillFilterDropdowns(items){
      const fg = new Set();
      const ex = new Set();
      const pk = new Set();
      const ck = new Set();
      const city = new Set();
      const dist = new Set();
      const ooh = new Set();
      const sales = new Set();

      for (const it of items){
        if (it.__frontier) fg.add(it.__frontier);
        if (it.__exposure) ex.add(it.__exposure);
        if (it.__parentKor) pk.add(it.__parentKor);
        if (it.__catKor) ck.add(it.__catKor);
        if (it.__city) city.add(it.__city);
        if (it.__district) dist.add(it.__district);
        if (it.__oohType) ooh.add(it.__oohType);
        if (it.__salesType) sales.add(it.__salesType);
      }

      buildOptions(ui.frontierGroup, [...fg].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.exposureType, [...ex].sort((a,b)=>a.localeCompare(b,"en")));
      buildOptions(ui.parentKor, [...pk].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.catKor, [...ck].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.city, [...city].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.district, [...dist].sort((a,b)=>a.localeCompare(b,"ko")));
      buildOptions(ui.oohType, [...ooh].sort((a,b)=>a.localeCompare(b,"en")));
      buildOptions(ui.salesType, [...sales].sort((a,b)=>a.localeCompare(b,"en")));
    }

    function applyFilters(){
      const q = normStr(ui.q.value).toLowerCase();

      const fg = normStr(ui.frontierGroup.value);
      const ex = normStr(ui.exposureType.value);
      const pk = normStr(ui.parentKor.value);
      const ck = normStr(ui.catKor.value);
      const city = normStr(ui.city.value);
      const dist = normStr(ui.district.value);
      const ooh = normStr(ui.oohType.value);
      const sales = normStr(ui.salesType.value);

      const onlyK = ui.onlyKorea.checked;

      filtered = raw.filter(it => {
        if (fg && it.__frontier !== fg) return false;
        if (ex && it.__exposure !== ex) return false;
        if (pk && it.__parentKor !== pk) return false;
        if (ck && it.__catKor !== ck) return false;
        if (city && it.__city !== city) return false;
        if (dist && it.__district !== dist) return false;
        if (ooh && it.__oohType !== ooh) return false;
        if (sales && it.__salesType !== sales) return false;

        if (q){
          const hay = (it.__haystack || "").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        if (onlyK){
          if (!(it.__lat !== null && it.__lng !== null)) return false;
          if (!it.__inKorea) return false;
        }
        return true;
      });

      renderMapMarkers(filtered);
      renderList(filtered);

      ui.shownCount.textContent = String(filtered.length);
      safeInvalidate();
    }

    function renderMapMarkers(items){
      if (!map || !cluster) return;

      cluster.clearLayers();

      const markers = [];
      let valid = 0;
      let koreaValid = 0;

      for (const it of items){
        const m = buildMarker(it);
        if (!m) continue;
        valid++;
        if (it.__inKorea) koreaValid++;
        markers.push(m);
      }
      if (markers.length) cluster.addLayers(markers);

      if (markers.length){
        const shouldPreferKorea = (koreaValid >= 10 && koreaValid / Math.max(valid,1) >= 0.7);
        if (ui.onlyKorea.checked || shouldPreferKorea){
          const sw = L.latLng(KOREA_BBOX.minLat, KOREA_BBOX.minLng);
          const ne = L.latLng(KOREA_BBOX.maxLat, KOREA_BBOX.maxLng);
          map.fitBounds(L.latLngBounds(sw, ne), { padding:[28,28], animate:false });
        } else {
          try{
            const b = cluster.getBounds();
            if (b && b.isValid()) map.fitBounds(b, { padding:[28,28], animate:false });
          } catch(e){}
        }
      } else {
        map.setView([36.5, 127.8], 7);
      }

      setTimeout(() => safeInvalidate(), 60);
    }

    function renderList(items){
      const max = 160;
      const show = items.slice(0, max);

      if (!show.length){
        ui.list.innerHTML = `<div style="color:rgba(231,238,247,.65);font-size:12.8px;line-height:1.45">
          조건에 맞는 항목이 없습니다.<br/>필터를 완화하거나 검색어를 지워보세요.
        </div>`;
        return;
      }

      ui.list.innerHTML = show.map(it => {
        const title = escapeHTML(safeText(it.name || it.title || it.product_display_name || "—"));
        const sub = escapeHTML(safeText(it.second_name || it.subtitle || ""));
        const addr = escapeHTML(safeText(it.address || ""));
        const fg = escapeHTML(safeText(it.__frontier || ""));
        const parentKor = escapeHTML(safeText(it.__parentKor || ""));
        const catKor = escapeHTML(safeText(it.__catKor || ""));
        const loc = [it.__city, it.__district].filter(Boolean).join(" / ");

        return `
          <div class="item" data-id="${escapeHTML(safeText(it.media_item_id || it.id || ""))}">
            <div class="t">${title}</div>
            <div class="s">${sub ? sub + "<br/>" : ""}${addr}${loc ? `<br/>${escapeHTML(loc)}` : ""}</div>
            <div class="k">
              ${fg ? `<span class="tag mint">${fg}</span>` : ""}
              ${(parentKor || catKor) ? `<span class="tag">${parentKor || "-"}</span>` : ""}
              ${catKor ? `<span class="tag">${catKor}</span>` : ""}
              ${it.__oohType ? `<span class="tag">${escapeHTML(it.__oohType)}</span>` : ""}
              ${it.__exposure ? `<span class="tag">${escapeHTML(it.__exposure)}</span>` : ""}
            </div>
          </div>
        `;
      }).join("");

      ui.list.querySelectorAll(".item").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const it = raw.find(x => safeText(x.media_item_id || x.id) === id) || items.find(x => safeText(x.media_item_id || x.id) === id);
          if (!it) return;

          if (Number.isFinite(Number(it.__lat)) && Number.isFinite(Number(it.__lng)) && map){
            map.setView([Number(it.__lat), Number(it.__lng)], Math.max(map.getZoom(), 14), { animate:false });
            setTimeout(() => safeInvalidate(), 60);
          }
          openModal(it);
        });
      });
    }

    async function loadData(){
      showLoading("JSON fetch");
      ui.pillStatus.textContent = "Loading…";

      try{
        const res = await fetch(DATA_URL, { cache:"no-store" });
        if (!res.ok){
          hideLoading();
          ui.pillStatus.textContent = "Data Error";
          toast(`<span class="bad">데이터 로드 실패</span><br/>
                HTTP ${res.status}<br/>
                경로: <b>${escapeHTML(DATA_URL)}</b>`);
          return;
        }

        const json = await res.json();
        // 배열/객체 모두 수용
        const items =
          Array.isArray(json) ? json :
          Array.isArray(json.items) ? json.items :
          Array.isArray(json.data?.items) ? json.data.items :
          Array.isArray(json.data) ? json.data :
          [];

        raw = Array.isArray(items) ? items : [];

        preprocessItems(raw);
        fillFilterDropdowns(raw);

        ui.totalCount.textContent = String(raw.length);
        ui.pillStatus.textContent = `Loaded: ${raw.length}`;

        applyFilters();
        hideLoading();

      } catch(err){
        hideLoading();
        ui.pillStatus.textContent = "Data Error";
        toast(`<span class="bad">JSON 오류</span><br/>${escapeHTML(err?.message || String(err))}`);
      }
    }

    function resetUI(){
      ui.q.value = "";
      ui.frontierGroup.value = "";
      ui.exposureType.value = "";
      ui.parentKor.value = "";
      ui.catKor.value = "";
      ui.city.value = "";
      ui.district.value = "";
      ui.oohType.value = "";
      ui.salesType.value = "";
      ui.onlyKorea.checked = true;
      applyFilters();
    }

    // ✅ 자동 적용(즉시 반영)
    const autoApply = () => applyFilters();
    ui.frontierGroup.addEventListener("change", autoApply);
    ui.exposureType.addEventListener("change", autoApply);
    ui.parentKor.addEventListener("change", autoApply);
    ui.catKor.addEventListener("change", autoApply);
    ui.city.addEventListener("change", autoApply);
    ui.district.addEventListener("change", autoApply);
    ui.oohType.addEventListener("change", autoApply);
    ui.salesType.addEventListener("change", autoApply);
    ui.onlyKorea.addEventListener("change", autoApply);

    // 검색 디바운스
    let qTimer = null;
    ui.q.addEventListener("input", () => {
      clearTimeout(qTimer);
      qTimer = setTimeout(applyFilters, 180);
    });

    ui.apply.addEventListener("click", applyFilters);
    ui.reset.addEventListener("click", resetUI);

    // ✅ 패널 리사이즈(드래그)
    (function initResizer(){
      let dragging = false;

      function setW(px){
        const min = 420;
        const max = Math.min(920, Math.floor(window.innerWidth * 0.70));
        const w = Math.max(min, Math.min(max, px));
        document.documentElement.style.setProperty("--panelW", w + "px");
        setTimeout(() => safeInvalidate(), 60);
      }

      ui.resizer.addEventListener("mousedown", () => {
        dragging = true;
        document.body.style.userSelect = "none";
      });

      window.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        setW(e.clientX);
      }, { passive:true });

      window.addEventListener("mouseup", () => {
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = "";
      });

      ui.resizer.addEventListener("touchstart", () => { dragging = true; }, { passive:true });
      window.addEventListener("touchmove", (e) => {
        if (!dragging) return;
        const t = e.touches && e.touches[0];
        if (!t) return;
        setW(t.clientX);
      }, { passive:true });
      window.addEventListener("touchend", () => { dragging = false; }, { passive:true });
    })();

    // boot
    (async function boot(){
      showLoading("init");
      await initMap();
      await loadData();
      hideLoading();
      setTimeout(() => safeInvalidate(), 220);
    })();
  </script>
</body>
</html>
